
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.9">
    
    
      
        <title>Print Site - nRF Connect SDK Course Notes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.78cf6014.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/print-site-enum-headings1.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings2.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings3.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings4.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings5.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings6.css">
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
    <script>__md_scope=new URL("/",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  
        <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            remove_material_navigation();remove_mkdocs_theme_navigation();generate_toc();
        })
        </script>
        </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="nRF Connect SDK Course Notes" class="md-header__button md-logo" aria-label="nRF Connect SDK Course Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            nRF Connect SDK Course Notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Print Site
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_3" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="purple"  aria-label="Switch to dark mode purple"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to dark mode purple" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="lime"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_3">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
    
  
  nRF Connect SDK Fundamentals

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../ble/" class="md-tabs__link">
        
  
    
  
  Bluetooth Low Energy

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../briefcode/" class="md-tabs__link">
        
  
    
  
  Brief of all code/config

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="nRF Connect SDK Course Notes" class="md-nav__button md-logo" aria-label="nRF Connect SDK Course Notes" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    nRF Connect SDK Course Notes
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    nRF Connect SDK Fundamentals
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../ble/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bluetooth Low Energy
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../briefcode/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Brief of all code/config
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<div id="print-site-page" class="print-site-enumerate-headings print-site-enumerate-figures">
        <section class="print-page">
            <div id="print-page-toc" data-toc-depth="3">
                <nav role='navigation' class='print-page-toc-nav'>
                <h1 class='print-page-toc-title'>Table of Contents</h1>
                </nav>
            </div>
        </section>
        <section class="print-page" id="index"><h1 id="index-nrf-connect-sdk-fundamentals">nRF Connect SDK Fundamentals</h1>
<p><a href="https://academy.nordicsemi.com/courses/nrf-connect-sdk-fundamentals/">nRF Connect SDK Course</a></br>
<a href="https://academy.nordicsemi.com/courses/bluetooth-low-energy-fundamentals/">nRF BLE Course</a></br></br></p>
<p><a href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/nrf/index.html">Documentation</a></br>
<a href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/zephyr/hardware/peripherals/gpio.html">API GPIO documentation</a></br>
<a href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/zephyr/services/logging/index.html#logging-api">Logging documentation</a></br></p>
<p><code>RTOS</code> - serve real-time applications that process data as it comes in, typically without buffer delays. These applications include embedded systems,
telecommunications, and industrial automation systems.</p>
<p>The key features of an RTOS include:</p>
<ul>
<li>
<p>Deterministic Scheduling: RTOSs provide deterministic scheduling, meaning that the system can predict the exact time at which a task will be executed.
This is crucial for systems where timing is critical.</p>
</li>
<li>
<p>Preemptive Scheduling: RTOSs use preemptive scheduling, which means that a high-priority task can interrupt a lower-priority task. This is important
for systems where certain tasks must be completed before others.</p>
</li>
<li>
<p>Interrupt Handling: RTOSs provide efficient interrupt handling, which is crucial for systems that need to respond quickly to external events.</p>
</li>
<li>
<p>Task Prioritization: RTOSs allow tasks to be prioritized, which means that tasks can be assigned different levels of importance. This is important
for systems where some tasks are more important than others.</p>
</li>
<li>
<p>Real-Time Performance: RTOSs are designed to provide real-time performance, which means that they can process data as it comes in, typically without
buffer delays. This is important for systems where timing is critical.</p>
</li>
</ul>
<p>In conclusion, RTOSs are designed for systems where timing is critical and where tasks must be executed in a specific order. They provide features such
as deterministic scheduling, preemptive scheduling, efficient interrupt handling, task prioritization, and real-time performance, which are crucial
for these types of systems.</p>
<p><code>Zephyr OS</code> is a real-time operating system (RTOS) designed for resource-constrained systems, particularly in the Internet of Things (IoT) domain.
It is designed to be lightweight, efficient, and secure, with a focus on energy efficiency</p>
<p>Here are some key differences between Zephyr OS and consumer-based operating systems:</p>
<ul>
<li>
<p>Design and Purpose: Zephyr OS is designed for resource-constrained systems, particularly in the IoT domain, where energy efficiency is crucial.
It is designed to be lightweight and efficient, focusing on energy efficiency. Consumer-based operating systems like Windows or Ubuntu are designed
for a wide range of applications, from personal computing to server environments, and are not designed to be lightweight or energy-efficient.</p>
</li>
<li>
<p>Security: Zephyr OS is designed with a focus on security. It provides long-term support, regular security updates, and a rigorously tested and
auditable code base. Consumer-based operating systems like Windows or Ubuntu also prioritize security, but they are not designed with the same level of
focus as Zephyr OS.</p>
</li>
<li>
<p>Interoperability: Zephyr OS is designed to be interoperable across a wide range of hardware, software, and communication protocol options.
Consumer-based operating systems like Windows or Ubuntu are designed to be compatible with a wide range of hardware and software, but they are not
designed with the same level of interoperability as Zephyr OS.</p>
</li>
<li>
<p>Ecosystem: Zephyr OS has a strong ecosystem, including a community that provides training and consulting, development tools, code libraries, and more.
Consumer-based operating systems like Windows or Ubuntu also have strong ecosystems, but they are not designed with the same level of community support
and development tools as Zephyr OS.</p>
</li>
</ul>
<p>In conclusion, while Zephyr OS and consumer-based operating systems like Windows or Ubuntu serve different purposes and have different characteristics,
they both play crucial roles in the world of computing. The choice between them depends on the specific requirements of the application or system
being developed.</p>
<h2 id="index-lesson-1">Lesson 1</h2>
<p><img src="../assets/nRF_connect_sdk_2-01.png" alt="Image description"
style="display: block; margin: auto; width: 65%; height: auto; border-radius: 8px;"></p>
<p><code>Zephyr RTOS</code> is an open-source real-time operating system for connected and resource-constrained embedded devices. It includes a scheduler that ensures
predictable/deterministic execution patterns and abstracts out the timing requirements. It also comes with a rich set of fundamental libraries and middleware
that simplifies development and helps reduce a product’s time to market. Zephyr RTOS is highly configurable and enables scalable configurations from
very small configurations for memory-constrained devices (minimum 8 kilobytes, for example, simple LED blinking application) to powerful, feature-rich,
high-processing power devices (multiple MBs of memory) with large memory configurations.</p>
<p>Internally, the nRF Connect SDK code is organized into four main repositories:</p>
<ul>
<li>nrf – Applications, samples, connectivity protocols (Nordic)</li>
<li>nrfxlib – Common libraries and stacks (Nordic)</li>
<li>Zephyr – RTOS &amp; Board configurations (open source)</li>
<li>MCUBoot – Secure Bootloader (open source)</li>
</ul>
<p><img src="../assets/Lesson_1_build_process-04.png" alt="Image description"
style="display: block; margin: auto; width: 85%; height: auto; border-radius: 8px;"></p>
<p><code>west</code> is a core command-line utility that is internally invoked by the nRF Connect for VS Code to do many tasks including building, and flashing
applications to your board.</p>
<p>The <code>devicetree</code> describes the hardware and <code>Kconfig</code> generates definitions that configure the whole system.</p>
<h2 id="index-lesson-2">Lesson 2</h2>
<p>examine how hardware is described in nRF Connect SDK, whether it is a development kit (DK), a System on Chip (SoC), a System in a Package (SiP).</p>
<p>Objectives</p>
<ul>
<li>Examine the devicetree API <zephyr/devicetree.h></li>
<li>Examine board-level devicetree .dts</li>
<li>Examine SoC-level devicetree .dtsi</li>
<li>Understand the purpose of devicetree binding files (.yaml) and the compatible property</li>
<li>Understand the device driver model <zephyr/device.h></li>
<li>Analyze the decoupling between a device driver API and a device driver implementation and the need to have a device pointer</li>
<li>Examine the generic GPIO interface APIs <zephyr/drivers/gpio.h></li>
<li>Practice through hands-on exercises configuring GPIO pins and learn how to read/write to/from GPIO pins and how to set up interrupts for input GPIO pins</li>
</ul>
<h3 id="index-devicetree">Devicetree</h3>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#index-__codelineno-0-1"></a>/dts-v1/<span class="p">;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#index-__codelineno-0-2"></a>/<span class="w"> </span><span class="o">{</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#index-__codelineno-0-3"></a><span class="w">        </span>a-node<span class="w"> </span><span class="o">{</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#index-__codelineno-0-4"></a><span class="w">                </span>subnode_label:<span class="w"> </span>a-sub-node<span class="w"> </span><span class="o">{</span>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#index-__codelineno-0-5"></a><span class="w">                        </span><span class="nv">foo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>&lt;<span class="m">3</span>&gt;<span class="p">;</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#index-__codelineno-0-6"></a><span class="w">                </span><span class="o">}</span><span class="p">;</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#index-__codelineno-0-7"></a><span class="w">        </span><span class="o">}</span><span class="p">;</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#index-__codelineno-0-8"></a><span class="o">}</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="index-devicetree-bindings-yaml-files">Devicetree bindings (YAML files)</h4>
<p>It declares requirements on the contents of devicetree nodes, and provides semantic information about the contents of valid nodes.</p>
<div class="language-yaml highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#index-__codelineno-1-1"></a><span class="nt">compatible</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nordic,nrf-sample&quot;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#index-__codelineno-1-2"></a><span class="nt">properties</span><span class="p">:</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#index-__codelineno-1-3"></a><span class="w">  </span><span class="nt">num-sample</span><span class="p">:</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#index-__codelineno-1-4"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">int</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#index-__codelineno-1-5"></a><span class="w">    </span><span class="nt">required</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></code></pre></div>
<p>Sample DTS file (.dts) with the node <code>node0</code> that is set to the compatible <code>nordic,nrf-sample</code>. This means the <code>node0</code> node must have the required property
<code>num-sample</code> and that property must be assigned an integer value. Otherwise, the build will fail.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#index-__codelineno-2-1"></a>node0<span class="w"> </span><span class="o">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#index-__codelineno-2-2"></a><span class="w">     </span><span class="nv">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nordic,nrf-sample&quot;</span><span class="p">;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#index-__codelineno-2-3"></a><span class="w">     </span>num-sample<span class="w"> </span><span class="o">=</span><span class="w"> </span>&lt;<span class="m">3</span>&gt;<span class="p">;</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#index-__codelineno-2-4"></a><span class="o">}</span><span class="p">;</span>
</span></code></pre></div>
<h4 id="index-aliases">Aliases</h4>
<p>name of the property is the name of that alias and the value of the property is a reference to a node in the device tree.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#index-__codelineno-3-1"></a>/<span class="w"> </span><span class="o">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#index-__codelineno-3-2"></a><span class="w">        </span>aliases<span class="w"> </span><span class="o">{</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#index-__codelineno-3-3"></a><span class="w">                </span><span class="nv">subnode_alias</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span>subnode_label<span class="p">;</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#index-__codelineno-3-4"></a><span class="w">        </span><span class="o">}</span><span class="p">;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#index-__codelineno-3-5"></a><span class="o">}</span><span class="p">;</span>
</span></code></pre></div>
<p>The purpose here is that your C/C++ application code (Ex: main.c) will use the alias. The definition of fixed aliases (Ex: led0 for the first LED on a
board ) in boards’ dts files can make the application code more portable, as it can avoid hard-coding varying device node names and make the application
code more flexible to changes in the board used.</p>
<h4 id="index-accessing-the-devicetree">Accessing the devicetree</h4>
<p><a href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/zephyr/build/dts/api-usage.html#node-identifiers">Ways to get node-identifier</a></p>
<p>To get information about a particular devicetree node in your source code, you need a node identifier for it. This is just a C macro that refers to
the node.</p>
<p>node identifier of a-sub-node:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#index-__codelineno-4-1"></a>DT_NODELABEL<span class="o">(</span>subnode-label<span class="o">)</span>
</span></code></pre></div>
<p>To get the value assigned to a certain devicetree property, we can use the macro DT_PROP().</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#index-__codelineno-5-1"></a>DT_PROP<span class="o">(</span>DT_NODELABEL<span class="o">(</span>subnode-label<span class="o">)</span>,<span class="w"> </span>foo<span class="o">)</span>
</span></code></pre></div>
<p>Device tree file is available in path: <code>&lt;install_path&gt;\zephyr\boards\arm\nrf52833dk_nrf52833\nrf52833dk_nrf52833.dts.</code></p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#index-__codelineno-6-1"></a><span class="nb">cd</span><span class="w"> </span>/home/deimos/ncs/v2.5.0-rc2/zephyr/boards/arm/nrf52dk_nrf52832
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#index-__codelineno-6-2"></a>code<span class="w"> </span>./nrf52dk_nrf52832.dts
</span></code></pre></div>
<h3 id="index-device-driver-model">Device driver model</h3>
<p>In order to interact with a hardware peripheral or a system block, we need to use a device driver (or driver for short), which is software that deals
with the low-level details of configuring the hardware the way we want.</p>
<p>The following code snippet will take the devicetree node identifier returned by DT_NODELABEL() and return a pointer to the device object.
Then <code>device_is_ready()</code> verifies that the device is ready for use, i.e. in a state so that it can be used with its standard API.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#index-__codelineno-7-1"></a><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">;</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#index-__codelineno-7-2"></a><span class="n">dev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEVICE_DT_GET</span><span class="p">(</span><span class="n">DT_NODELABEL</span><span class="p">(</span><span class="n">uart0</span><span class="p">));</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#index-__codelineno-7-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#index-__codelineno-7-4"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#index-__codelineno-7-5"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="index-gpio-generic-api">GPIO Generic API</h3>
<p>To interact with the General-Purpose Input/Output (GPIO) peripheral, we can use the generic API <zephyr/drivers/gpio.h>, which provides user-friendly
functions to interact with GPIO peripherals.</p>
<p>When using any driver in Zephyr, the first step is to initialize it by retrieving the device pointer.</p>
<h4 id="index-initializing-the-api">Initializing the API</h4>
<p>Before using the device pointer contained in gpio_dt_spec led, we need to check if it’s ready using <code>device_is_ready()</code>.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#index-__codelineno-8-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">led</span><span class="p">.</span><span class="n">port</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#index-__codelineno-8-2"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#index-__codelineno-8-3"></a><span class="p">}</span>
</span></code></pre></div>
<h4 id="index-configure-a-single-pin">Configure a single pin</h4>
<p>This is done by calling the function <code>gpio_pin_configure_dt()</code>, which has the following signature:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#index-__codelineno-9-1"></a><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_OUTPUT</span><span class="p">);</span>
</span></code></pre></div>
<p>The following line configures the pin led.pin as an output that is active low.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#index-__codelineno-10-1"></a><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_OUTPUT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GPIO_ACTIVE_LOW</span><span class="p">);</span>
</span></code></pre></div>
<h4 id="index-write-to-an-output-pin">Write to an output pin</h4>
<p>Writing to an output pin is straightforward by using the function <code>gpio_pin_set_dt()</code>, which has the following signature</p>
<p>For example, the following line sets the pin associated with gpio_dt_spec led, which can be denoted as led.pin, to logic 1 “active state”:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#index-__codelineno-11-1"></a><span class="n">gpio_pin_set_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span></code></pre></div>
<p>For example, the following line will toggle the pin led.pin, whenever this API is called.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#index-__codelineno-12-1"></a><span class="n">gpio_pin_toggle_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">);</span>
</span></code></pre></div>
<h4 id="index-read-from-an-input-pin">Read from an input pin</h4>
<p>Reading a pin configured as an input is not as straightforward as writing to a pin configured as an output.
There are two possible methods to read the status of an input pin:</p>
<h5 id="index-polling">Polling</h5>
<p>Polling means continuously reading the status of the pin to check if it has changed. To read the current status of a pin, all you need to do is to
call the function <code>gpio_pin_get_dt()</code></p>
<p>For example, the following line reads the current status of led.pin saves it in a variable called val.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#index-__codelineno-13-1"></a><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_get_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">);</span>
</span></code></pre></div>
<h5 id="index-interrupt-method">Interrupt method</h5>
<p>(Interrupt handler is also known as an interrupt service routine)</p>
<p>You can only configure an interrupt on a GPIO pin configured as an input.</p>
<ol>
<li>Configure the interrupt on a pin.</li>
</ol>
<p>The following line will configure an interrupt on dev.pin on the change to logical level 1.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#index-__codelineno-14-1"></a><span class="n">gpio_pin_interrupt_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">button</span><span class="p">,</span><span class="n">GPIO_INT_EDGE_TO_ACTIVE</span><span class="p">);</span>
</span></code></pre></div>
<ol>
<li>Define the callback function <code>pin_isr()</code>.</li>
</ol>
<p>The signature (prototype) of the callback function is shown below</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#index-__codelineno-15-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">pin_isr</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_callback</span><span class="w"> </span><span class="o">*</span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="n">gpio_port_pins_t</span><span class="w"> </span><span class="n">pins</span><span class="p">);</span>
</span></code></pre></div>
<ol>
<li>Define a variable of type static struct <code>gpio_callback</code> as shown in the code line below.</li>
</ol>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#index-__codelineno-16-1"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_callback</span><span class="w"> </span><span class="n">pin_cb_data</span><span class="p">;</span>
</span></code></pre></div>
<ol>
<li>Initialize the gpio callback variable <code>pin_cb_data</code> using <code>gpio_init_callback()</code>.</li>
</ol>
<p>For example, the following line will initialize the <code>pin_cb_data</code> variable with the callback function <code>pin_isr</code> and the bit mask of pin <code>dev.pin</code>.
   Note the use of the macro <code>BIT(n)</code>, which simply gets an unsigned integer with bit position <code>n</code> set.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#index-__codelineno-17-1"></a><span class="n">gpio_init_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pin_cb_data</span><span class="p">,</span><span class="w"> </span><span class="n">pin_isr</span><span class="p">,</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="n">dev</span><span class="p">.</span><span class="n">pin</span><span class="p">));</span>
</span></code></pre></div>
<ol>
<li>The final step is to add the callback function through the function <code>gpio_add_callback()</code>.</li>
</ol>
<p>For example, the following line adds the callback function that we set up in the previous steps.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#index-__codelineno-18-1"></a><span class="n">gpio_add_callback</span><span class="p">(</span><span class="n">button</span><span class="p">.</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pin_cb_data</span><span class="p">);</span>
</span></code></pre></div>
<h3 id="index-program-example-blinky">Program example - blinky</h3>
<ol>
<li>Include modules</li>
</ol>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#index-__codelineno-19-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#index-__codelineno-19-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/gpio.h&gt;</span>
</span></code></pre></div>
<ol>
<li>Define the node identifier</li>
</ol>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#index-__codelineno-20-1"></a><span class="cp">#define LED0_NODE DT_ALIAS(led0)</span>
</span></code></pre></div>
<ol>
<li>Retrieve the device pointer, pin number, and configuration flags.</li>
</ol>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#index-__codelineno-21-1"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">led</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">LED0_NODE</span><span class="p">,</span><span class="w">  </span><span class="n">gpios</span><span class="p">);</span>
</span></code></pre></div>
<ol>
<li>Verify that the device is ready for use</li>
</ol>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#index-__codelineno-22-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">led</span><span class="p">.</span><span class="n">port</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#index-__codelineno-22-2"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#index-__codelineno-22-3"></a><span class="p">}</span>
</span></code></pre></div>
<ol>
<li>Configure the GPIO pin</li>
</ol>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#index-__codelineno-23-1"></a><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#index-__codelineno-23-2"></a><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_OUTPUT_ACTIVE</span><span class="p">);</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#index-__codelineno-23-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#index-__codelineno-23-4"></a><span class="w">    </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#index-__codelineno-23-5"></a><span class="p">}</span>
</span></code></pre></div>
<ol>
<li>Continuously toggle the GPIO pin</li>
</ol>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#index-__codelineno-24-1"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#index-__codelineno-24-2"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_toggle_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">);</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#index-__codelineno-24-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#index-__codelineno-24-4"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#index-__codelineno-24-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#index-__codelineno-24-6"></a><span class="w">    </span><span class="n">k_msleep</span><span class="p">(</span><span class="n">SLEEP_TIME_MS</span><span class="p">);</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#index-__codelineno-24-7"></a><span class="p">}</span>
</span></code></pre></div>
<h2 id="index-lesson-3">Lesson 3</h2>
<p>Create a minimal working application from scratch and add our own custom files and configurations to customize the application.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#index-__codelineno-25-1"></a>app/
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#index-__codelineno-25-2"></a><span class="p">|</span>--<span class="w"> </span>CMakeLists.txt
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#index-__codelineno-25-3"></a><span class="p">|</span>--<span class="w"> </span>Kconfig
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#index-__codelineno-25-4"></a><span class="p">|</span>--<span class="w"> </span>prj.conf
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#index-__codelineno-25-5"></a><span class="p">|</span>--<span class="w"> </span>&lt;board_name&gt;.overlay
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#index-__codelineno-25-6"></a><span class="p">|</span>--<span class="w"> </span>src/
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#index-__codelineno-25-7"></a><span class="w">    </span><span class="p">|</span>--<span class="w"> </span>main.c
</span></code></pre></div>
<p>Objectives</p>
<ul>
<li>Understand the use of Kconfig configuration files to enable and configure the different software modules available in the nRF Connect SDK</li>
<li>Examine an application configuration file and a board configuration file and understand the relation between them</li>
<li>Learn how to explore the available configuration options of a certain software module using guiconfig</li>
<li>Understand multi-image builds, and how a child-image is added to your application</li>
<li>Practice through hands-on exercises how to create an application from scratch, and how to add modules using Kconfig and modify the devicetree</li>
</ul>
<h3 id="index-configuration-files">Configuration files</h3>
<h4 id="index-application-board">Application &amp; board</h4>
<p>Each configuration option must start with the prefix CONFIG_ followed by the name of the software module to configure, then the value to be set, with
no spaces around the equals sign.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#index-__codelineno-26-1"></a>CONFIG_&lt;symbol_name&gt;<span class="o">=</span>&lt;value&gt;
</span></code></pre></div>
<ul>
<li>App cfg: prj.conf</li>
<li>Brd cfg: <board_name>_defconfig in <nRF Connect SDK Installation Path>\zephyr\boards\arm\nrf52833dk_nrf52833.</li>
</ul>
<p>You should never modify any board configuration files. Instead, rely on the application configuration file to set newconfigurations
and subsequently overwrite any default board configurations if needed.  If you change the board configuration file directly, then these changes will
apply for all projects using that board.</p>
<h4 id="index-kernel-configuration-kconfig">Kernel Configuration (Kconfig)</h4>
<p>An alternative way to modify the contents of the prj.conf (application configuration file) is by using the Kconfig view.
It groups all functionalities provided by the Zephyr kernel into menus and submenus which can be viewed in a graphical tree format.</p>
<p>If instead of Kconfig, you find GUIconfig, you can still view Kconfig by viewing the submenu under Guiconfig.</p>
<p><img src="../assets/kconfig.png" alt="Image description"
style="display: block; margin: auto; width: 85%; height: auto; border-radius: 8px;"></p>
<h3 id="index-devicetree-overlays-cmake-and-multi-image-builds">Devicetree overlays, CMake, and multi-image builds</h3>
<p>(PATH to fully compiled devicetree of a build: application_path/build/zephyr/zephyr.dts)</p>
<p>It is not recommended to modify the devicetree directly, so instead we use devicetree overlays to do this.
The overlay only needs to include the node and property it wants to modify.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#index-__codelineno-27-1"></a><span class="p">&amp;</span>spi1<span class="o">{</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#index-__codelineno-27-2"></a><span class="w"> </span><span class="nv">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;okay&quot;</span><span class="p">;</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#index-__codelineno-27-3"></a><span class="o">}</span><span class="p">;</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#index-__codelineno-27-4"></a><span class="p">&amp;</span>pinctrl<span class="w"> </span><span class="o">{</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#index-__codelineno-27-5"></a><span class="w"> </span>spi1_default:<span class="w"> </span>spi1_default<span class="w"> </span><span class="o">{</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#index-__codelineno-27-6"></a><span class="w">  </span>group1<span class="w"> </span><span class="o">{</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#index-__codelineno-27-7"></a><span class="w">   </span><span class="nv">psels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>&lt;NRF_PSEL<span class="o">(</span>SPIM_MOSI,<span class="w"> </span><span class="m">0</span>,<span class="w"> </span><span class="m">25</span><span class="o">)</span>&gt;<span class="p">;</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#index-__codelineno-27-8"></a><span class="w">  </span><span class="o">}</span><span class="p">;</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#index-__codelineno-27-9"></a><span class="w"> </span><span class="o">}</span><span class="p">;</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#index-__codelineno-27-10"></a><span class="w"> </span>spi1_sleep:<span class="w"> </span>spi1_sleep<span class="w"> </span><span class="o">{</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#index-__codelineno-27-11"></a><span class="w">  </span>group1<span class="w"> </span><span class="o">{</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#index-__codelineno-27-12"></a><span class="w">   </span><span class="nv">psels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>&lt;NRF_PSEL<span class="o">(</span>SPIM_MOSI,<span class="w"> </span><span class="m">0</span>,<span class="w"> </span><span class="m">25</span><span class="o">)</span>&gt;<span class="p">;</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#index-__codelineno-27-13"></a><span class="w">  </span><span class="o">}</span><span class="p">;</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#index-__codelineno-27-14"></a><span class="w"> </span><span class="o">}</span><span class="p">;</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#index-__codelineno-27-15"></a><span class="o">}</span><span class="p">;</span>
</span></code></pre></div>
<p>The overlay file shown above will set node spi1 to have the status okay, essentially enabling this node. Then it is changing the pin configuration for
the SPIM_MOSI line to pin 25 by changing the appropriate sub-nodes and properties in the &amp;pinctrl node. Note that you must change the pin configuration
for both the default and sleep states.</p>
<h3 id="index-cmake">CMake</h3>
<p>The file <code>CMakeLists.txt</code> is the main CMake project file and the source of this build process configuration.</p>
<h3 id="index-multi-image-builds">Multi-Image Builds</h3>
<p>he firmware running on a device can consist of one application or image, or it can consist of multiple images, making it a multi-image build.</p>
<p>Multi-image builds are used in the following cases:</p>
<ul>
<li>Applications that have DFU enabled (serial, USB-CDC, BLE, etc.)</li>
<li>Multi-core or multi-partition targets (nRF53 and nRF9160)</li>
</ul>
<h3 id="index-app-from-scratch">App from scratch</h3>
<p>Necessary 3 files:</p>
<ul>
<li><code>/src/main.c</code></li>
<li><code>prj.conf</code></li>
<li><code>CMakeLists.txt</code></li>
</ul>
<p>CMakeLists</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#index-__codelineno-28-1"></a>cmake_minimum_required<span class="o">(</span>VERSION<span class="w"> </span><span class="m">3</span>.20.0<span class="o">)</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#index-__codelineno-28-2"></a>find_package<span class="o">(</span>Zephyr<span class="w"> </span>REQUIRED<span class="w"> </span>HINTS<span class="w"> </span><span class="nv">$ENV</span><span class="o">{</span>ZEPHYR_BASE<span class="o">})</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#index-__codelineno-28-3"></a>project<span class="o">(</span>hello_world<span class="o">)</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#index-__codelineno-28-4"></a>target_sources<span class="o">(</span>app<span class="w"> </span>PRIVATE<span class="w"> </span>src/main.c<span class="o">)</span>
</span></code></pre></div>
<p>main.c</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#index-__codelineno-29-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#index-__codelineno-29-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/sys/printk.h&gt;</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#index-__codelineno-29-3"></a>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#index-__codelineno-29-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#index-__codelineno-29-5"></a><span class="p">{</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6" href="#index-__codelineno-29-6"></a><span class="w"> </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7" href="#index-__codelineno-29-7"></a><span class="w">  </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Hello World!</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8" href="#index-__codelineno-29-8"></a><span class="w">  </span><span class="n">k_msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9" href="#index-__codelineno-29-9"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10" href="#index-__codelineno-29-10"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="index-adding-custom-configurations">Adding custom configurations</h3>
<p>Create a file called <code>Kconfig</code> in the application directory (the same location as CMakeLists.txt and prj.conf). Make sure the file does not have a file extension.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#index-__codelineno-30-1"></a><span class="nb">source</span><span class="w"> </span><span class="s2">&quot;Kconfig.zephyr&quot;</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#index-__codelineno-30-2"></a>config<span class="w"> </span>MYFUNCTION
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#index-__codelineno-30-3"></a><span class="w">  </span>bool<span class="w"> </span><span class="s2">&quot;Enable my function&quot;</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#index-__codelineno-30-4"></a><span class="w">  </span>default<span class="w"> </span>n
</span></code></pre></div>
<p>In CMakeLists.txt, we want the addition of the custom files to be conditional. Change the last line to use the function target_sources_ifdef(), like this:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#index-__codelineno-31-1"></a>target_sources_ifdef<span class="o">(</span>CONFIG_MYFUNCTION<span class="w"> </span>app<span class="w"> </span>PRIVATE<span class="w"> </span>src/myfunction.c<span class="o">)</span>
</span></code></pre></div>
<p>Enable the config by adding the following line to prj.conf</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#index-__codelineno-32-1"></a><span class="nv">CONFIG_MYFUNCTION</span><span class="o">=</span>y
</span></code></pre></div>
<p>Update main.c</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#index-__codelineno-33-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#index-__codelineno-33-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/sys/printk.h&gt;</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#index-__codelineno-33-3"></a><span class="cp">#ifdef CONFIG_MYFUNCTION</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#index-__codelineno-33-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;myfunction.h&quot;</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#index-__codelineno-33-5"></a><span class="cp">#endif</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6" href="#index-__codelineno-33-6"></a><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7" href="#index-__codelineno-33-7"></a><span class="p">{</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8" href="#index-__codelineno-33-8"></a><span class="w"> </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9" href="#index-__codelineno-33-9"></a><span class="w">  </span><span class="cp">#ifdef CONFIG_MYFUNCTION</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10" href="#index-__codelineno-33-10"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11" href="#index-__codelineno-33-11"></a><span class="w">   </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;The sum of %d and %d is %d</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12" href="#index-__codelineno-33-12"></a><span class="w">  </span><span class="cp">#else</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13" href="#index-__codelineno-33-13"></a><span class="w">   </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;MYFUNCTION not enabled</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14" href="#index-__codelineno-33-14"></a><span class="w">   </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15" href="#index-__codelineno-33-15"></a><span class="w">  </span><span class="cp">#endif</span>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16" href="#index-__codelineno-33-16"></a><span class="w">  </span><span class="n">k_msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17" href="#index-__codelineno-33-17"></a><span class="w"> </span><span class="p">}</span>
</span><span id="__span-33-18"><a id="__codelineno-33-18" name="__codelineno-33-18" href="#index-__codelineno-33-18"></a><span class="p">}</span>
</span></code></pre></div>
<p>Build and flash the application</p>
<p>If you will change in prj.conf to</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#index-__codelineno-34-1"></a><span class="nv">CONFIG_MYFUNCTION</span><span class="o">=</span>n
</span></code></pre></div>
<p>you will get the output: <code>MYFUNCTION not enabled</code></p>
<h3 id="index-modifying-the-devicetree-changing-the-baud-rate-at-which-information-is-sent-to-the-console">Modifying the devicetree - changing the baud rate at which information is sent to the console</h3>
<p>Create an overlay file in the application directory (the same location as CMakeLists.txt and prj.conf) with the name of the board you’re using,
in our case nrf52833dk_nrf52833.overlay</p>
<p>In nRF Connect for VS Code, in the Details View, there is an option to create an overlay file with the same board name used for the build.</p>
<p>Add the following to the overlay file, which can be found in the root directory of the application, to change this property:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#index-__codelineno-35-1"></a><span class="p">&amp;</span>uart0<span class="w"> </span><span class="o">{</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#index-__codelineno-35-2"></a><span class="w"> </span>current-speed<span class="w"> </span><span class="o">=</span><span class="w"> </span>&lt;<span class="m">9600</span>&gt;<span class="p">;</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#index-__codelineno-35-3"></a><span class="o">}</span><span class="p">;</span>
</span></code></pre></div>
<p>Do a <code>pristine build</code> and flash the sample to the board.</p>
<p>Observe that the serial terminal doesn’t show any output. This is because we changed the baud rate in the application to 9600 baud/sec while the
serial terminal is launched with the default baud rate of 115200 baud/sec</p>
<h2 id="index-lesson-4">Lesson 4</h2>
<p>We will learn more about logging using both the simple method of <code>printk()</code> and a sophisticated method using the advanced logging module.</p>
<ul>
<li>Learn how to print strings and formatted strings to a console using <code>printk()</code></li>
<li>Recognize the limitations of <code>printk()</code></li>
<li>Learn how to print strings and formatted strings to a console using the logger module</li>
<li>Learn how to hex dump variables using the logger module</li>
<li>Explore the logger module features</li>
<li>Practice through hands-on exercises enabling/configuring software modules</li>
</ul>
<h3 id="index-printk"><code>printk()</code></h3>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#index-__codelineno-36-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/sys/printk.h&gt;</span>
</span></code></pre></div>
<p>The syntax <code>printk()</code> is similar to the standard printf() in C.
However, <code>printk()</code> is a less advanced function that only supports a subset of the features that printf() does, making it optimized for embedded development.</p>
<p>A basic set of specifiers are supported:</p>
<ul>
<li>Signed decimal: %d, %i and its subcategories</li>
<li>Unsigned decimal: %u and its subcategories</li>
<li>Unsigned hexadecimal: %x (%X is treated as %x)</li>
<li>Pointer: %p</li>
<li>String: %s</li>
<li>Character: %c</li>
<li>Percent: %%</li>
<li>New line: \n</li>
<li>Carriage return: \r</li>
</ul>
<p>Field width (with or without leading zeroes) is supported. Length attributes h, hh, l, ll and z are supported.
However, integral values with lld and lli are only printed if they fit in a long, otherwise ERR is printed.
Full 64-bit values may be printed with llx. Flags and precision attributes (float and double) are not supported by default,
but can be enabled manually (lesson 6).</p>
<p>Examples of use:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#index-__codelineno-37-1"></a><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Button 1 was pressed!</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#index-__codelineno-37-2"></a>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#index-__codelineno-37-3"></a><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">44</span><span class="p">;</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4" href="#index-__codelineno-37-4"></a><span class="n">printk</span><span class="p">(</span><span class="s">&quot;The value of x is %d</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>
</span></code></pre></div>
<p>To use <code>printk()</code> you need to:</p>
<ol>
<li>Include the console drivers (enabling the configuration option CONFIG_CONSOLE in the application configuration file).</li>
<li>Select the console (UART console (CONFIG_UART_CONSOLE) and RTT console (CONFIG_RTT_CONSOLE)).</li>
<li>Include the header file <code>&lt;zephyr/sys/printk.h&gt;</code> in your application source code.</li>
</ol>
<h3 id="index-logger-module">Logger module</h3>
<p>prj.conf</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#index-__codelineno-38-1"></a><span class="nv">CONFIG_LOG</span><span class="o">=</span>y
</span></code></pre></div>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#index-__codelineno-39-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/logging/log.h&gt;</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#index-__codelineno-39-2"></a>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#index-__codelineno-39-3"></a><span class="n">LOG_MODULE_REGISTER</span><span class="p">(</span><span class="n">Less4_Exer2</span><span class="p">,</span><span class="n">LOG_LEVEL_DBG</span><span class="p">);</span>
</span></code></pre></div>
<p>Recommended method for sending messages to a console, unlike the <code>printk()</code> function, which will not return until all bytes of the message are sent.</p>
<ul>
<li>Multiple backends</li>
<li>Compile time filtering on module level</li>
<li>Run time filtering independent for each backend</li>
<li>Timestamping with user-provided function</li>
<li>Dedicated API for dumping data</li>
<li>Coloring of logs</li>
<li><code>printk()</code> support – printk message can be redirected to the logger</li>
</ul>
<p>By using proper configuration options, logs can be gradually removed from compilation to reduce image size and execution time when logs are not needed.
During compilation, logs can be filtered out based on module and severity level.</p>
<p>When logging is enabled globally, it works for all modules. However, modules can disable logging locally.
Every module can specify its own logging level (<code>LOG_LEVEL_[level]</code>) or use <code>LOG_LEVEL_NONE</code>, which will disable the logging for that module.</p>
<p>The logger module is designed to be thread-safe and minimizes the time needed to log the message.</p>
<h4 id="index-severity-levels">Severity levels</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>1 (most severe)</td>
<td>Error</td>
<td>Severe error conditions</td>
<td>LOG_LEVEL_ERR</td>
</tr>
<tr>
<td>2</td>
<td>Warning</td>
<td>Conditions that should be taken care of</td>
<td>LOG_LEVEL_WRN</td>
</tr>
<tr>
<td>3</td>
<td>Info</td>
<td>Informational messages that require no action</td>
<td>LOG_LEVEL_INF</td>
</tr>
<tr>
<td>4 (least severe)</td>
<td>Debug Debugging messages</td>
<td>LOG_LEVEL_DBG</td>
<td></td>
</tr>
</tbody>
</table>
<p><code>LOG_X</code> for standard printf-like messages, where <code>X</code> can be <code>DBG</code>, <code>INF</code>, <code>WRN</code>, or <code>ERR</code>.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#index-__codelineno-40-1"></a><span class="n">LOG_INF</span><span class="p">(</span><span class="s">&quot;Exercise %d&quot;</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#index-__codelineno-40-2"></a><span class="n">LOG_DBG</span><span class="p">(</span><span class="s">&quot;A log message in debug level&quot;</span><span class="p">);</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#index-__codelineno-40-3"></a><span class="n">LOG_WRN</span><span class="p">(</span><span class="s">&quot;A log message in warning level!&quot;</span><span class="p">);</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#index-__codelineno-40-4"></a><span class="n">LOG_ERR</span><span class="p">(</span><span class="s">&quot;A log message in Error level!&quot;</span><span class="p">);</span>
</span></code></pre></div>
<h4 id="index-dumping-data">Dumping data</h4>
<p><code>LOG_HEXDUMP_X</code>  macros for dumping data where <code>X</code> can be <code>DBG</code>, <code>INF</code>, <code>WRN</code>, or <code>ERR</code>.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#index-__codelineno-41-1"></a><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span><span class="p">,</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#index-__codelineno-41-2"></a><span class="w">                  </span><span class="mh">0x04</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x06</span><span class="p">,</span><span class="w"> </span><span class="mh">0x07</span><span class="p">,</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3" href="#index-__codelineno-41-3"></a><span class="w">                  </span><span class="sc">&#39;H&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="sc">&#39;o&#39;</span><span class="p">};</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4" href="#index-__codelineno-41-4"></a><span class="n">LOG_HEXDUMP_INF</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="s">&quot;Sample Data!&quot;</span><span class="p">);</span>
</span></code></pre></div>
<h4 id="index-kconfig-logging-options">Kconfig logging options</h4>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>LOG_MODE_DEFERRED</td>
<td>Deferred mode is used by default. Log messages are buffered and processed later. This mode has the least impact on the application. Time-consuming processing is deferred to the known context.</td>
</tr>
<tr>
<td>LOG_PROCESS_THREAD</td>
<td>A thread is created by the logger subsystem (deferred mode). This thread is woken up periodically (LOG_PROCESS_THREAD_SLEEP_MS) or whenever the number of buffered messages exceeds the threshold (LOG_PROCESS_TRIGGER_THR).</td>
</tr>
<tr>
<td>LOG_BACKEND_UART</td>
<td>Send logs to the UART console.</td>
</tr>
<tr>
<td>LOG_BACKEND_SHOW_COLOR</td>
<td>Prints errors in red and warnings in yellow. Not all terminal emulators support this feature.</td>
</tr>
<tr>
<td>LOG_BACKEND_FORMAT_TIMESTAMP</td>
<td>Timestamp is formatted to <code>hh:mm:ss.ms,us</code>.</td>
</tr>
<tr>
<td>LOG_MODE_OVERFLOW</td>
<td>If there is no space to log a new message, the oldest one is dropped.</td>
</tr>
</tbody>
</table>
<h2 id="index-lesson-5">Lesson 5</h2>
<p>Learn how to use the UART driver in an interrupt-driven fashion so that when new data arrives the application is interrupted and a callback
function (ISR) is called.</p>
<p>Objectives</p>
<ul>
<li>Learn how to send/receive data over UART in asynchronous mode (interrupt-driven)</li>
<li>Learn how to configure the UART peripheral hardware through the UART API</li>
<li>Examine and practice the use of the UART driver API</li>
</ul>
<p>Data transfer is done serially. It starts with a starting bit, usually by driving logic low for one clock cycle.
In the next n clock cycles, n bits are sent sequentially from the transmitter (n is usually 8). Optionally,
1 parity bit can be added to improve transfer reliability. In the end, the data wire is usually pulled up high to indicate the end of transfer.</p>
<p>Parity bit: A parity bit describes the evenness or oddness of the data and is a way for the receiver to tell if the data has changed during transmission.</p>
<h3 id="index-uart-driver">UART Driver</h3>
<p>In Zephyr, there are three different ways to access the UART peripheral, all with different API functions; polling, interrupts-driven and asynchronous.</p>
<p>Polling - <code>uart_poll_in()</code> reading function and <code>uart_poll_out()</code> writing function.
Asynchronous API - the most efficient way to use UART, it allows to read and write data in the background using EasyDMA.</p>
<h4 id="index-enable-driver">Enable driver</h4>
<ol>
<li>
<p>Enable for use by adding <code>prj.conf</code></p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#index-__codelineno-42-1"></a><span class="nv">CONFIG_SERIAL</span><span class="o">=</span>y
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#index-__codelineno-42-2"></a><span class="nv">CONFIG_UART_ASYNC_API</span><span class="o">=</span>y
</span></code></pre></div>
</li>
<li>
<p>Include the header file</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#index-__codelineno-43-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/uart.h&gt;</span>
</span></code></pre></div>
</li>
<li>
<p>Create an instance of uart device structure</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#index-__codelineno-44-1"></a><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">uart</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DEVICE_DT_GET</span><span class="p">(</span><span class="n">DT_NODELABEL</span><span class="p">(</span><span class="n">uart0</span><span class="p">));</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#index-__codelineno-44-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">uart</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#index-__codelineno-44-3"></a><span class="w">   </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#index-__codelineno-44-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>The pointer <code>uart</code> of type <code>struct device</code> is the structure that is used when interacting with the UART API.
  On the other hand, <code>uart0</code> is the node label of the devicetree node that represents the UART hardware controller on the chip.</p>
</li>
</ol>
<h4 id="index-uart-configurations">UART Configurations</h4>
<ol>
<li>
<p>Configuration of UART communication</p>
<p>The default static configuration of the UART hardware is obtained from the devicetree.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#index-__codelineno-45-1"></a><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">uart_config</span><span class="w"> </span><span class="n">uart_cfg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2" href="#index-__codelineno-45-2"></a><span class="p">.</span><span class="n">baudrate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">115200</span><span class="p">,</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3" href="#index-__codelineno-45-3"></a><span class="p">.</span><span class="n">parity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UART_CFG_PARITY_NONE</span><span class="p">,</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4" href="#index-__codelineno-45-4"></a><span class="p">.</span><span class="n">stop_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UART_CFG_STOP_BITS_1</span><span class="p">,</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5" href="#index-__codelineno-45-5"></a><span class="p">.</span><span class="n">data_bits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UART_CFG_DATA_BITS_8</span><span class="p">,</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6" href="#index-__codelineno-45-6"></a><span class="p">.</span><span class="n">flow_ctrl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UART_CFG_FLOW_CTRL_NONE</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7" href="#index-__codelineno-45-7"></a><span class="p">};</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8" href="#index-__codelineno-45-8"></a>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9" href="#index-__codelineno-45-9"></a><span class="kt">int</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uart_configure</span><span class="p">(</span><span class="n">uart</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">uart_cfg</span><span class="p">);</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10" href="#index-__codelineno-45-10"></a>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11" href="#index-__codelineno-45-11"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">-</span><span class="n">ENOSYS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12" href="#index-__codelineno-45-12"></a><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
</span><span id="__span-45-13"><a id="__codelineno-45-13" name="__codelineno-45-13" href="#index-__codelineno-45-13"></a><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>Define callback function</p>
<p>The callback function should have the following signature:</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#index-__codelineno-46-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">uart_cb</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">uart_event</span><span class="w"> </span><span class="o">*</span><span class="n">evt</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_data</span><span class="p">)</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2" href="#index-__codelineno-46-2"></a><span class="p">{</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3" href="#index-__codelineno-46-3"></a><span class="w">   </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4" href="#index-__codelineno-46-4"></a><span class="w">   </span><span class="p">{</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5" href="#index-__codelineno-46-5"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">UART_TX_DONE</span><span class="p">:</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6" href="#index-__codelineno-46-6"></a><span class="w">      </span><span class="c1">// do something</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7" href="#index-__codelineno-46-7"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8" href="#index-__codelineno-46-8"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">UART_TX_ABORTED</span><span class="p">:</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9" href="#index-__codelineno-46-9"></a><span class="w">      </span><span class="c1">// do something</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10" href="#index-__codelineno-46-10"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11" href="#index-__codelineno-46-11"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">UART_RX_RDY</span><span class="p">:</span>
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12" href="#index-__codelineno-46-12"></a><span class="w">      </span><span class="c1">// do something</span>
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13" href="#index-__codelineno-46-13"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-46-14"><a id="__codelineno-46-14" name="__codelineno-46-14" href="#index-__codelineno-46-14"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">UART_RX_BUF_REQUEST</span><span class="p">:</span>
</span><span id="__span-46-15"><a id="__codelineno-46-15" name="__codelineno-46-15" href="#index-__codelineno-46-15"></a><span class="w">      </span><span class="c1">// do something</span>
</span><span id="__span-46-16"><a id="__codelineno-46-16" name="__codelineno-46-16" href="#index-__codelineno-46-16"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-46-17"><a id="__codelineno-46-17" name="__codelineno-46-17" href="#index-__codelineno-46-17"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">UART_RX_BUF_RELEASED</span><span class="p">:</span>
</span><span id="__span-46-18"><a id="__codelineno-46-18" name="__codelineno-46-18" href="#index-__codelineno-46-18"></a><span class="w">      </span><span class="c1">// do something</span>
</span><span id="__span-46-19"><a id="__codelineno-46-19" name="__codelineno-46-19" href="#index-__codelineno-46-19"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-46-20"><a id="__codelineno-46-20" name="__codelineno-46-20" href="#index-__codelineno-46-20"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">UART_RX_DISABLED</span><span class="p">:</span>
</span><span id="__span-46-21"><a id="__codelineno-46-21" name="__codelineno-46-21" href="#index-__codelineno-46-21"></a><span class="w">      </span><span class="c1">// do something</span>
</span><span id="__span-46-22"><a id="__codelineno-46-22" name="__codelineno-46-22" href="#index-__codelineno-46-22"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-46-23"><a id="__codelineno-46-23" name="__codelineno-46-23" href="#index-__codelineno-46-23"></a><span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="no">UART_RX_STOPPED</span><span class="p">:</span>
</span><span id="__span-46-24"><a id="__codelineno-46-24" name="__codelineno-46-24" href="#index-__codelineno-46-24"></a><span class="w">      </span><span class="c1">// do something</span>
</span><span id="__span-46-25"><a id="__codelineno-46-25" name="__codelineno-46-25" href="#index-__codelineno-46-25"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-46-26"><a id="__codelineno-46-26" name="__codelineno-46-26" href="#index-__codelineno-46-26"></a><span class="w">      </span><span class="k">default</span><span class="o">:</span>
</span><span id="__span-46-27"><a id="__codelineno-46-27" name="__codelineno-46-27" href="#index-__codelineno-46-27"></a><span class="w">      </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-46-28"><a id="__codelineno-46-28" name="__codelineno-46-28" href="#index-__codelineno-46-28"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-46-29"><a id="__codelineno-46-29" name="__codelineno-46-29" href="#index-__codelineno-46-29"></a><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>Register the callback function by calling the function <code>uart_callback_set()</code>, which takes three parameters.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#index-__codelineno-47-1"></a><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uart_callback_set</span><span class="p">(</span><span class="n">uart</span><span class="p">,</span><span class="w"> </span><span class="n">uart_cb</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#index-__codelineno-47-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#index-__codelineno-47-3"></a><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#index-__codelineno-47-4"></a><span class="p">}</span>
</span></code></pre></div>
</li>
</ol>
<h4 id="index-receive-data">Receive data</h4>
<ol>
<li>
<p>Declare a receive buffer to store the incoming data.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#index-__codelineno-48-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">rx_buf</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="w"> </span><span class="c1">//A buffer to store incoming UART data</span>
</span></code></pre></div>
</li>
<li>
<p>To start receiving, call the uart_rx_enable() function, and pass the address of the receive buffer.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#index-__codelineno-49-1"></a><span class="n">uart_rx_enable</span><span class="p">(</span><span class="n">uart</span><span class="p">,</span><span class="w"> </span><span class="n">rx_buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_buf</span><span class="p">),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>The data received is accessible through the UART callback on the UART_RX_RDY event.
<code>evt-&gt;data.rx.len</code>, <code>evt-&gt;data.rx.offset</code>, <code>evt-&gt;rx.buf[rx.offset]</code>, <code>evt-&gt;rx.buf[rx.offset+rx.len]</code></p>
</li>
<li>
<p>Continuous reception is not enabled by default. Once the receive buffer is full, you must manually enable reception.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#index-__codelineno-50-1"></a><span class="k">case</span><span class="w"> </span><span class="no">UART_RX_DISABLED</span><span class="p">:</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#index-__codelineno-50-2"></a><span class="w">   </span><span class="n">uart_rx_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">rx_buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_buf</span><span class="p">),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#index-__codelineno-50-3"></a><span class="w">   </span><span class="k">break</span><span class="p">;</span>
</span></code></pre></div>
</li>
</ol>
<h4 id="index-transmit-data">Transmit data</h4>
<ol>
<li>Define a transmission buffer to hold the data to be sent.</li>
</ol>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#index-__codelineno-51-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">tx_buf</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="p">{</span><span class="s">&quot;nRF Connect SDK Fundamentals Course </span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">};</span>
</span></code></pre></div>
<ol>
<li>Call the function <code>uart_tx()</code> to send the data over UART.</li>
</ol>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#index-__codelineno-52-1"></a><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uart_tx</span><span class="p">(</span><span class="n">uart</span><span class="p">,</span><span class="w"> </span><span class="n">tx_buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">tx_buf</span><span class="p">),</span><span class="w"> </span><span class="n">SYS_FOREVER_US</span><span class="p">);</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#index-__codelineno-52-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3" href="#index-__codelineno-52-3"></a><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4" href="#index-__codelineno-52-4"></a><span class="p">}</span>
</span></code></pre></div>
<p>The function returns immediately and the sending is actually managed internally by the UART driver.</p>
<p>If your application needs to take action once the whole transmission buffer is transmitted, you could do that by using the <code>UART_TX_DONE</code> event
in the UART callback function.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#index-__codelineno-53-1"></a><span class="k">case</span><span class="w"> </span><span class="no">UART_TX_DONE</span><span class="p">:</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#index-__codelineno-53-2"></a><span class="w">  </span><span class="c1">// Do something here if needed  </span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#index-__codelineno-53-3"></a><span class="w">  </span><span class="k">break</span><span class="p">;</span>
</span></code></pre></div>
<p>UART driver in nRF Connect SDK doesn't support interrupts.</br>
CTS stands for clear to send and is used when hardware flow control is enabled to receive the other module’s RTS (ready to send) signal to indicate
that it can begin sending data.</br></p>
<h2 id="index-lesson-6">Lesson 6</h2>
<p>The basics of I2C and learn how to use the I2C driver in nRF.</p>
<p>Objectives</p>
<ul>
<li>Learn how to use the I2C driver in nRF Connect SDK</li>
<li>Practice using the I2C driver APIs through a hands-on exercise</li>
<li>Communicate with an external sensor using the I2C bus</li>
</ul>
<h3 id="index-i2c-protocol">I2C Protocol</h3>
<p>Since it uses 2-wire, the I2C protocol is also known as the Two-Wire Interface (TWI).</p>
<p>I2C controllers on Nordic’s chips support multiple speeds: 100 (I2C_BITRATE_STANDARD), 400 (I2C_BITRATE_FAST) and 1000 (I2C_BITRATE_FAST_PLUS) kbps.
The default speed is 100 kbps.
I2C wires are called serial clock (SCL) and serial data (SDA)</p>
<p>The SCL is generated by the I2C master to sync all devices on the bus to one clock, while the SDA line is bidirectional, so data can travel in
either direction (from master to slave or slave to master).</p>
<p>Each I2C slave device has a unique address that distinguishes it from the other I2C slave devices on the same bus. The address is usually a 7-bit
value, however, some I2C slave devices also use a 10-bit value.</p>
<h3 id="index-i2c-driver">I2C Driver</h3>
<ol>
<li>
<p>Enable driver in <code>prj.conf</code></p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#index-__codelineno-54-1"></a><span class="nv">CONFIG_I2C</span><span class="o">=</span>y
</span></code></pre></div>
</li>
<li>
<p>Include header of the I2C API in your source code file.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#index-__codelineno-55-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/i2c.h&gt;</span>
</span></code></pre></div>
</li>
<li>
<p>Specify which I2C controller your device (sensor) is connected to and its I2C address.</p>
<p>If the sensor is not already defined in the board’s devicetree, you need to manually add your sensor as a child devicetree node to the i2c
  controller, using a devicetree overlay file.</br></br></p>
<p>3.1 Create overlay files.</br></p>
<p>From the details panel, expand Input files and create an overlay file.
  This will create an empty overlay file in your application root directory.</br></br></p>
<p>3.2 In the overlay file, specify the I2C controller that your sensor is connected to and its address.</br></p>
<p>At a minimum, you need to specify the compatible, the address of the i2c target device, and its label.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#index-__codelineno-56-1"></a><span class="p">&amp;</span>i2c0<span class="w"> </span><span class="o">{</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#index-__codelineno-56-2"></a><span class="w">   </span>mysensor:<span class="w"> </span>mysensor@4a<span class="o">{</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#index-__codelineno-56-3"></a><span class="w">      </span><span class="nv">compatible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;i2c-device&quot;</span><span class="p">;</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#index-__codelineno-56-4"></a><span class="w">      </span><span class="nv">reg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>&lt;<span class="w"> </span>0x4a<span class="w"> </span>&gt;<span class="p">;</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#index-__codelineno-56-5"></a><span class="w">      </span><span class="nv">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;MYSENSOR&quot;</span><span class="p">;</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#index-__codelineno-56-6"></a><span class="w">   </span><span class="o">}</span><span class="p">;</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#index-__codelineno-56-7"></a><span class="o">}</span><span class="p">;</span>
</span></code></pre></div>
</li>
<li>
<p>Define the node identifier.</p>
<p>Use devicetree macro <code>DT_NODELABEL()</code> to get the node identifier symbol <code>I2C0_NODE</code>, which will represent the I2C hardware controller <code>i2c0</code>.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#index-__codelineno-57-1"></a><span class="cp">#define I2C0_NODE DT_NODELABEL(mysensor)</span>
</span></code></pre></div>
</li>
<li>
<p>Retrieve the API-specific device structure.</p>
<p>Macro call <code>I2C_DT_SPEC_GET()</code> returns the structure <code>i2c_dt_spec</code>, which contains the device pointer for the I2C bus, as well as the target address.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#index-__codelineno-58-1"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_dt_spec</span><span class="w"> </span><span class="n">dev_i2c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I2C_DT_SPEC_GET</span><span class="p">(</span><span class="n">I2C0_NODE</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>Use <code>device_is_ready()</code> to verify that the device is ready to use.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1" href="#index-__codelineno-59-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">dev_i2c</span><span class="p">.</span><span class="n">bus</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2" href="#index-__codelineno-59-2"></a><span class="w">   </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;I2C bus %s is not ready!</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev_i2c</span><span class="p">.</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3" href="#index-__codelineno-59-3"></a><span class="w">   </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4" href="#index-__codelineno-59-4"></a><span class="p">}</span>
</span></code></pre></div>
</li>
</ol>
<h3 id="index-i2c-write">I2C Write</h3>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1" href="#index-__codelineno-60-1"></a><span class="kt">uint8_t</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x8C</span><span class="p">};</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2" href="#index-__codelineno-60-2"></a><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_write_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_i2c</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">config</span><span class="p">));</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3" href="#index-__codelineno-60-3"></a><span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4" href="#index-__codelineno-60-4"></a><span class="w"> </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Failed to write to I2C device address %x at reg. %x n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dev_i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5" href="#index-__codelineno-60-5"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="index-i2c-read">I2C Read</h3>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1" href="#index-__codelineno-61-1"></a><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2" href="#index-__codelineno-61-2"></a><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_read_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_i2c</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3" href="#index-__codelineno-61-3"></a><span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4" href="#index-__codelineno-61-4"></a><span class="w"> </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Failed to read from I2C device address %x at Reg. %x n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dev_i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5" href="#index-__codelineno-61-5"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="index-i2c-writeread">I2C Write/Read</h3>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1" href="#index-__codelineno-62-1"></a><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sensor_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="p">{</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x00</span><span class="p">};</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2" href="#index-__codelineno-62-2"></a><span class="kt">uint8_t</span><span class="w"> </span><span class="n">temp_reading</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3" href="#index-__codelineno-62-3"></a><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_write_read_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_i2c</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sensor_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">temp_reading</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4" href="#index-__codelineno-62-4"></a><span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5" href="#index-__codelineno-62-5"></a><span class="w"> </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Failed to write/read I2C device address %x at Reg. %x n&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dev_i2c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span><span class="n">sensor_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6" href="#index-__codelineno-62-6"></a><span class="p">}</span>
</span></code></pre></div>
<p>Writing and subsequently reading is a common operation in the I2C protocol because you need to write the register you want to read from before reading.</p>
<h2 id="index-lesson-7-multithreaded-applications">Lesson 7 - Multithreaded applications</h2>
<p>How to create threads with different priorities and learn about the scheduler’s behavior through features like time slicing and workqueues in Zephyr RTOS.</p>
<p>Objectives:</p>
<ul>
<li>Understand the main difference between bare-metal vs RTOS programming, including both advantages and disadvantages in utilizing an RTOS</li>
<li>Get familiarized with Zephyr RTOS execution model, ISRs, threads, thread’s life-cycle and inter-task communication/synchronization mechanisms, and
the scheduler</li>
<li>Learn the basics of kernel services related to threads (user-defined threads, system threads, workqueue threads)</li>
<li>Learn about preemptive scheduling and time-slicing through hands-on exercises</li>
<li>Practice through hands-on exercises how to create threads, thread yielding and sleeping</li>
<li>Practice through hands-on exercises how to offload work to a workqueue</li>
</ul>
<h3 id="index-bare-metal-vs-rtos-based-application">Bare-metal vs RTOS-based application</h3>
<p>RTOS applications allow for multiple concurrent logics while bare-metal applications runs sequential logic.</p>
<h4 id="index-bare-metal">Bare-metal</h4>
<p>A bare-metal application, at its core, is just a big loop in the main function right after you have initialized the hardware/software at the device
powerup/reset routines. All the execution is sequential logic, in other words, all instructions are executed in sequence unless interrupted by an
interrupt service routine (ISR). So the only non-sequential logic you have in bare-metal programming makes use of exceptions.</br></p>
<p>In general, a bare-metal program is typically more power-efficient, uses less memory, and in some situations runs faster. For applications with simple
to average complexity, it is a good enough solution to have one sequential logic in a loop. Especially considering bare-metal programs are more
power-efficient and use less memory. However, your application can very easily get quite complex in terms of maintaining the architecture as sequential
logic. This is where using a real-time operating system (RTOS) becomes advantageous.</p>
<h4 id="index-rtos">RTOS</h4>
<p>Designing your application on top of an operating system allows you to have multiple concurrent logics in your application running in different
execution units called threads, making your architecture simple, as opposed to just one sequential logic running in your main function in standalone mode.</br></p>
<p>The core of an RTOS is called the kernel and controls everything in the system. The other big added advantage is the huge resources of libraries,
drivers, and protocol stacks that are natively available by an RTOS like Zephyr.</br></p>
<p>Interrupt Service Routines (ISRs) are available in both RTOS-based applications and bare-metal applications. They are generated asynchronously by the
different devices drivers configured(including callback functions) and protocols stacks.</br></p>
<p>Having the main() function is optional in Zephyr RTOS-based applications. This is because the main thread automatically spawned by the RTOS will do
the necessary RTOS initialization, including scheduler/kernel setup, and core drivers setup.</p>
<h3 id="index-zephyr-rtos-basics">Zephyr RTOS basics</h3>
<h4 id="index-threads">Threads</h4>
<p>A thread is the smallest logical unit of execution for the RTOS scheduler (covered later in this topic) that is competing for the CPU time.</p>
<ul>
<li>
<p>Running: The running thread is the one that is currently being executed by the CPU.</p>
</li>
<li>
<p>Runnable: A thread is marked as “Runnable” when it has no other dependencies with other threads or other system resources to proceed further in execution.
The only resource this thread is waiting for is the CPU time, also known as “Ready” state.</p>
</li>
<li>
<p>Non-runnable: A thread that has one or more factors that prevent its execution is deemed to be unready, and cannot be selected as the current thread.
This can, for example, be because they are waiting for some resource that is not yet available or they have been terminated or suspended,
also known as “Unready” state.</p>
</li>
</ul>
<h4 id="index-system-threads">System threads</h4>
<p>Thread that is spawned automatically by Zephyr RTOS during initialization.</p>
<ul>
<li>
<p>Main thread - executes the necessary RTOS initializations and calls the application’s main() function, if it exists.</p>
</li>
<li>
<p>Idle thread - runs when there is no other work to do.</p>
</li>
</ul>
<h4 id="index-user-created-threads">User-created threads</h4>
<p>User can define their own threads to assign tasks to.
For example, a user can create a thread to delegate reading sensor data, another thread to process data, and so on.</p>
<h4 id="index-workqueue-threads">Workqueue threads</h4>
<p><code>Common execution unit</code> in <code>nRF Connect SDK</code> is a <code>work item</code>, which is nothing more than a user-defined function that gets called by a dedicated thread
called a <code>workqueue thread</code>.</p>
<p>The main use of this is to offload non-urgent work from an ISR or a high-priority thread to a lower priority thread.
You do not need to create and initialize a workqueue if submitting work items to the system workqueue.
ISR or high priority thread submits work into a workqueue, and the dedicated workqueue thread pulls out a work item in a first in, first out (FIFO) order.</p>
<h4 id="index-threads-priority">Threads Priority</h4>
<p>Threads are assigned an integer value to indicate their priority, which can be either negative or non-negative.</p>
<p>A thread with a <code>negative priority</code> is classified as a <code>cooperative thread</code> (<code>CONFIG_NUM_COOP_PRIORITIES</code> and is, by default, equal to 16).
Thread with a <code>non-negative priority</code> is classified as a <code>preemptible thread</code> (<code>CONFIG_NUM_PREEMPT_PRIORITIES</code> and is, by default, equal to 15).</p>
<h4 id="index-scheduler">Scheduler</h4>
<p>The scheduler is the part of the RTOS responsible for scheduling which tasks are running, i.e using CPU time, at any given time.
It does this using a scheduling algorithm to determine which task should be the next to run.</p>
<h5 id="index-rescheduling-point">Rescheduling point</h5>
<p>Zephyr RTOS is by default a tickless RTOS. A tickless RTOS is completely event-driven, which means that instead of having periodic timer interrupts
to wake up the scheduler, it is woken based on events known as rescheduling points.</br></p>
<p>Rescheduling points are:</p>
<ul>
<li>When a thread calls <code>k_yield()</code>, the thread’s state is changed from “Running” to “Ready”.</li>
<li>Unblocking a thread by giving/sending a kernel synchronization object like a semaphore, mutex or alert, causes the thread’s state to be changed from
“Unready” to “Ready”.</li>
<li>When a receiving thread gets new data from other threads using data passing kernel objects, the data receiving thread’s state is changed from
“Waiting” to “Ready”.</li>
<li>When time slicing is enabled and the thread has run continuously for the maximum time slice time allowed, the thread’s state
is changed from “Running” to “Ready”.</li>
</ul>
<h4 id="index-isr">ISR</h4>
<p>Interrupt Service Routines (ISRs) are generated asynchronously by the device drivers and protocol stacks.
They are not scheduled (This includes callback functions).
ISRs preempt the execution of the current thread, allowing the response to occur with very low overhead.</p>
<h3 id="index-create-application-with-threads">Create application with threads</h3>
<ol>
<li>
<p>Define the stack size and scheduling priority of the two threads that we will use when defining them.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1" href="#index-__codelineno-63-1"></a><span class="cp">#define STACKSIZE 1024 </span><span class="c1">// Stack sizes should always be a power of two (512, 1024, 2048, etc.).</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2" href="#index-__codelineno-63-2"></a><span class="cp">#define THREAD0_PRIORITY 7</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3" href="#index-__codelineno-63-3"></a><span class="cp">#define THREAD1_PRIORITY 7</span>
</span></code></pre></div>
</li>
<li>
<p>Define the threads</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1" href="#index-__codelineno-64-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">thread1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2" href="#index-__codelineno-64-2"></a><span class="p">{</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3" href="#index-__codelineno-64-3"></a><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4" href="#index-__codelineno-64-4"></a><span class="w">   </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Hello, I am thread1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5" href="#index-__codelineno-64-5"></a>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6" href="#index-__codelineno-64-6"></a><span class="w">   </span><span class="n">k_yield</span><span class="p">();</span><span class="w"> </span><span class="c1">// Set to lower priority and allow to run other threads</span>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7" href="#index-__codelineno-64-7"></a><span class="w">   </span><span class="c1">// OR set thread to sleep</span>
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8" href="#index-__codelineno-64-8"></a><span class="w">   </span><span class="c1">//k_msleep(5);</span>
</span><span id="__span-64-9"><a id="__codelineno-64-9" name="__codelineno-64-9" href="#index-__codelineno-64-9"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-64-10"><a id="__codelineno-64-10" name="__codelineno-64-10" href="#index-__codelineno-64-10"></a><span class="p">}</span>
</span><span id="__span-64-11"><a id="__codelineno-64-11" name="__codelineno-64-11" href="#index-__codelineno-64-11"></a><span class="c1">// ...</span>
</span></code></pre></div>
</li>
<li>
<p>Initialize threads</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1" href="#index-__codelineno-65-1"></a><span class="n">K_THREAD_DEFINE</span><span class="p">(</span><span class="n">thread0_id</span><span class="p">,</span><span class="w"> </span><span class="n">STACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">thread0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2" href="#index-__codelineno-65-2"></a><span class="w">      </span><span class="n">THREAD0_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3" href="#index-__codelineno-65-3"></a><span class="n">K_THREAD_DEFINE</span><span class="p">(</span><span class="n">thread1_id</span><span class="p">,</span><span class="w"> </span><span class="n">STACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">thread1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4" href="#index-__codelineno-65-4"></a><span class="w">      </span><span class="n">THREAD1_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>If threads cannot sleep or yield, enable timeslicing in prj.conf to prevent starvation</p>
<p>The scheduler will preempt the running thread after the configured amount of time (10 ms in this case) regardless of what it is doing</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1" href="#index-__codelineno-66-1"></a><span class="nv">CONFIG_TIMESLICING</span><span class="o">=</span>y
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2" href="#index-__codelineno-66-2"></a><span class="nv">CONFIG_TIMESLICE_SIZE</span><span class="o">=</span><span class="m">10</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3" href="#index-__codelineno-66-3"></a><span class="nv">CONFIG_TIMESLICE_PRIORITY</span><span class="o">=</span><span class="m">0</span>
</span></code></pre></div>
<p>The scheduler will check and preempt only equal priority thread, thus if we will use code below, thread0 will starve thread1 forever</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1" href="#index-__codelineno-67-1"></a><span class="cp">#define THREAD0_PRIORITY 6</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2" href="#index-__codelineno-67-2"></a><span class="cp">#define THREAD1_PRIORITY 7</span>
</span></code></pre></div>
</li>
</ol>
<h3 id="index-workqueue-creation">Workqueue creation</h3>
<ol>
<li>
<p>Define threads with different priorities</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1" href="#index-__codelineno-68-1"></a><span class="cp">#define THREAD0_PRIORITY 2 </span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2" href="#index-__codelineno-68-2"></a><span class="cp">#define THREAD1_PRIORITY 3</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3" href="#index-__codelineno-68-3"></a><span class="cp">#define WORKQ_PRIORITY   4</span>
</span></code></pre></div>
</li>
<li>
<p>Create threads with delta times</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1" href="#index-__codelineno-69-1"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">emulate_work</span><span class="p">()</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2" href="#index-__codelineno-69-2"></a><span class="p">{</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3" href="#index-__codelineno-69-3"></a><span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">count_out</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">150000</span><span class="p">;</span><span class="w"> </span><span class="n">count_out</span><span class="w"> </span><span class="o">++</span><span class="p">);</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4" href="#index-__codelineno-69-4"></a><span class="p">}</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5" href="#index-__codelineno-69-5"></a>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6" href="#index-__codelineno-69-6"></a><span class="kt">void</span><span class="w"> </span><span class="nf">thread0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7" href="#index-__codelineno-69-7"></a><span class="p">{</span>
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8" href="#index-__codelineno-69-8"></a><span class="w">   </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">time_stamp</span><span class="p">;</span>
</span><span id="__span-69-9"><a id="__codelineno-69-9" name="__codelineno-69-9" href="#index-__codelineno-69-9"></a><span class="w">   </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">delta_time</span><span class="p">;</span>
</span><span id="__span-69-10"><a id="__codelineno-69-10" name="__codelineno-69-10" href="#index-__codelineno-69-10"></a><span class="w">   </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-11"><a id="__codelineno-69-11" name="__codelineno-69-11" href="#index-__codelineno-69-11"></a><span class="w">      </span><span class="n">time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k_uptime_get</span><span class="p">();</span>
</span><span id="__span-69-12"><a id="__codelineno-69-12" name="__codelineno-69-12" href="#index-__codelineno-69-12"></a><span class="w">      </span><span class="n">emulate_work</span><span class="p">();</span>
</span><span id="__span-69-13"><a id="__codelineno-69-13" name="__codelineno-69-13" href="#index-__codelineno-69-13"></a><span class="w">      </span><span class="n">delta_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k_uptime_delta</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time_stamp</span><span class="p">);</span>
</span><span id="__span-69-14"><a id="__codelineno-69-14" name="__codelineno-69-14" href="#index-__codelineno-69-14"></a><span class="w">      </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;thread0 yielding this round in %lld ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">);</span>
</span><span id="__span-69-15"><a id="__codelineno-69-15" name="__codelineno-69-15" href="#index-__codelineno-69-15"></a><span class="w">      </span><span class="n">k_msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
</span><span id="__span-69-16"><a id="__codelineno-69-16" name="__codelineno-69-16" href="#index-__codelineno-69-16"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-69-17"><a id="__codelineno-69-17" name="__codelineno-69-17" href="#index-__codelineno-69-17"></a><span class="p">}</span>
</span></code></pre></div>
<p>Offload work from high priority task if necessary</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1" href="#index-__codelineno-70-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">work_info</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2" href="#index-__codelineno-70-2"></a><span class="w">   </span><span class="k">struct</span><span class="w"> </span><span class="nc">k_work</span><span class="w"> </span><span class="n">work</span><span class="p">;</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3" href="#index-__codelineno-70-3"></a><span class="w">   </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">25</span><span class="p">];</span>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4" href="#index-__codelineno-70-4"></a><span class="p">}</span><span class="w"> </span><span class="n">my_work</span><span class="p">;</span>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5" href="#index-__codelineno-70-5"></a>
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6" href="#index-__codelineno-70-6"></a><span class="kt">void</span><span class="w"> </span><span class="nf">offload_function</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">k_work</span><span class="w"> </span><span class="o">*</span><span class="n">work_tem</span><span class="p">)</span>
</span><span id="__span-70-7"><a id="__codelineno-70-7" name="__codelineno-70-7" href="#index-__codelineno-70-7"></a><span class="p">{</span>
</span><span id="__span-70-8"><a id="__codelineno-70-8" name="__codelineno-70-8" href="#index-__codelineno-70-8"></a><span class="w">   </span><span class="n">emulate_work</span><span class="p">();</span>
</span><span id="__span-70-9"><a id="__codelineno-70-9" name="__codelineno-70-9" href="#index-__codelineno-70-9"></a><span class="p">}</span>
</span><span id="__span-70-10"><a id="__codelineno-70-10" name="__codelineno-70-10" href="#index-__codelineno-70-10"></a>
</span><span id="__span-70-11"><a id="__codelineno-70-11" name="__codelineno-70-11" href="#index-__codelineno-70-11"></a><span class="n">k_work_queue_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offload_work_q</span><span class="p">,</span><span class="w"> </span><span class="n">my_stack_area</span><span class="p">,</span>
</span><span id="__span-70-12"><a id="__codelineno-70-12" name="__codelineno-70-12" href="#index-__codelineno-70-12"></a><span class="w">                  </span><span class="n">K_THREAD_STACK_SIZEOF</span><span class="p">(</span><span class="n">my_stack_area</span><span class="p">),</span><span class="w"> </span><span class="n">WORKQ_PRIORITY</span><span class="p">,</span>
</span><span id="__span-70-13"><a id="__codelineno-70-13" name="__codelineno-70-13" href="#index-__codelineno-70-13"></a><span class="w">                  </span><span class="nb">NULL</span><span class="p">);</span>
</span><span id="__span-70-14"><a id="__codelineno-70-14" name="__codelineno-70-14" href="#index-__codelineno-70-14"></a><span class="n">strcpy</span><span class="p">(</span><span class="n">my_work</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Thread0 emulate_work()&quot;</span><span class="p">);</span>
</span><span id="__span-70-15"><a id="__codelineno-70-15" name="__codelineno-70-15" href="#index-__codelineno-70-15"></a><span class="n">k_work_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_work</span><span class="p">.</span><span class="n">work</span><span class="p">,</span><span class="w"> </span><span class="n">offload_function</span><span class="p">);</span>
</span><span id="__span-70-16"><a id="__codelineno-70-16" name="__codelineno-70-16" href="#index-__codelineno-70-16"></a>
</span><span id="__span-70-17"><a id="__codelineno-70-17" name="__codelineno-70-17" href="#index-__codelineno-70-17"></a><span class="n">k_work_submit_to_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offload_work_q</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">my_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
</span></code></pre></div>
</li>
</ol>
<h2 id="index-lesson-8-thread-synchronization">Lesson 8 - Thread synchronization</h2>
<p>Need for thread synchronization and how to use semaphores and mutexes as thread synchronization mechanisms.</p>
<p>Objective:</p>
<ul>
<li>Understand the need for thread synchronization mechanisms</li>
<li>Learn the basic properties of semaphores and mutexes</li>
<li>Practice through hands-on exercises how to use semaphores and mutexes for thread synchronization</li>
</ul>
<p>If more than one thread tries to access the same piece of code simultaneously, usually referred to as the critical section, this can lead to unexpected
or erroneous behavior. Two mechanisms you can utilize to achieve thread synchronization are semaphores or mutexes.</p>
<ul>
<li>Semaphores have a maximum value that is set at initialization</li>
<li>Mutexes have ownership property, i.e only the thread incrementing its value can decrement it, until zero when it is relinquished.</li>
</ul>
<h3 id="index-semaphores">Semaphores</h3>
<p>In its simplest form, a semaphore is merely a plain variable that is changed, indicating the status of the common resource. Semaphores can be seen as
a resource-sharing mechanism, where you have a finite instance of a resource that you want to manage access for multiple threads.
They are more of a signaling mechanism used to control access to a given number of instances of a resource.</p>
<p>Semaphores have the following properties:</p>
<ul>
<li>At initialization, you set an initial count (greater than 0) and a maximum limit.</li>
<li>“Give” will increment the semaphore count unless the count is already at the maximum limit, in which case the signal will not increment.
“Give” can be done from any thread or ISR.</li>
<li>“Take” will decrement the semaphore count unless the semaphore is unavailable (count at zero). Any thread that is trying to take a semaphore that is
unavailable needs to wait until some other thread makes it available (by giving the semaphore). “Take” can be done only in threads and not in ISR
(since ISRs should not block on anything).</li>
<li>There is no ownership of semaphores. This means a semaphore can be taken by one thread and can be given by any thread. It is not necessary that the
thread that has taken the semaphore is the one to give it.</li>
<li>The thread taking the semaphore is NOT eligible for priority inheritance since the taking thread does not own the semaphore and any other thread can
give the semaphore.</li>
</ul>
<p><img src="../assets/semaphore.png" alt="Image description"
style="display: block; margin: auto; width: 65%; height: auto; border-radius: 8px; background: white;"></p>
<h3 id="index-mutexes">Mutexes</h3>
<p>As opposed to semaphores, mutexes can only take two values, commonly referred to as locked or unlocked. Additionally, mutexes have ownership properties
in the sense that only the thread that locks the mutex can unlock it. Think of it as a locking/unlocking mechanism with a single key, where a thread
wishing to gain access to a single object. For instance, a code section or a resource needs to first gain access to an unlocked mutex, lock it and then
access the object. If the thread trying to gain access to the mutex sees that the mutex is already locked, then the thread gets blocked and will wait until
the mutex is unlocked by the thread that locked it.</p>
<p>A typical use of a mutex is to protect a critical section of the code that can be accessed from multiple threads. The critical section is a piece of
code that needs to be completed without interruptions from other threads, or else the global/static data within that critical section could be
misrepresented or get corrupted</p>
<p>Mutexes have the following properties:</p>
<ul>
<li>Locking a mutex will increment the lock count. Recursive locking (reentrant locking) will not make the locking thread block since it already owns
 the mutex. The thread should make sure that it unlocks the mutex the same number of times that it locked it to release the mutex so that other threads
 can attempt to own it.</li>
<li>Unlocking a mutex will decrement the lock count. When the lock count is zero, that means that the mutex is in an unlocked state.
Threads can attempt to own the mutex only when the mutex is in an unlocked state.</li>
<li>Only the thread that locked the mutex can unlock it.</li>
<li>Mutexes locking and unlocking can only be done in threads and not in ISRs. This is because ISRs cannot participate in the ownership and priority
inheritance mechanism of the scheduler.</li>
<li>The thread locking the mutex is eligible for priority inheritance since only that thread can unlock the mutex.</li>
</ul>
<p><img src="../assets/mutex.png" alt="Image description"
style="display: block; margin: auto; width: 65%; height: auto; border-radius: 8px; background: white;"></p>
<h3 id="index-use-semaphores">Use semaphores</h3>
<ol>
<li>
<p>Set the priority of the producer and consumer thread.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1" href="#index-__codelineno-71-1"></a><span class="cp">#define PRODUCER_PRIORITY        5 </span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2" href="#index-__codelineno-71-2"></a><span class="cp">#define CONSUMER_PRIORITY        4</span>
</span></code></pre></div>
</li>
<li>
<p>Initialize the number of instances of the limited resource to be 10 (just assume that we have 10 instances of that resource).</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1" href="#index-__codelineno-72-1"></a><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">available_instance_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</span></code></pre></div>
</li>
<li>
<p>Create the producer thread that just releases the resource without any checks and sleeps for a random (500-509ms) amount of time.
When it wakes up from this sleep, it repeats this step in a loop indefinitely.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1" href="#index-__codelineno-73-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">producer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2" href="#index-__codelineno-73-2"></a><span class="p">{</span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3" href="#index-__codelineno-73-3"></a><span class="w">   </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Producer thread started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4" href="#index-__codelineno-73-4"></a><span class="w">   </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5" href="#index-__codelineno-73-5"></a><span class="w">      </span><span class="n">release_access</span><span class="p">();</span>
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6" href="#index-__codelineno-73-6"></a><span class="w">      </span><span class="c1">// Assume the resource instance access is released at this point</span>
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7" href="#index-__codelineno-73-7"></a><span class="w">      </span><span class="n">k_msleep</span><span class="p">(</span><span class="mi">500</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sys_rand32_get</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
</span><span id="__span-73-8"><a id="__codelineno-73-8" name="__codelineno-73-8" href="#index-__codelineno-73-8"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-73-9"><a id="__codelineno-73-9" name="__codelineno-73-9" href="#index-__codelineno-73-9"></a><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>Create the consumer thread that gets access to the resource without any checks and assumes to get access before it goes to sleep for a random (0-9ms)
amount of time. When it wakes up, it repeats this step in a loop indefinitely.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1" href="#index-__codelineno-74-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">consumer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2" href="#index-__codelineno-74-2"></a><span class="p">{</span>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3" href="#index-__codelineno-74-3"></a><span class="w">   </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Consumer thread started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4" href="#index-__codelineno-74-4"></a><span class="w">   </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5" href="#index-__codelineno-74-5"></a><span class="w">      </span><span class="n">get_access</span><span class="p">();</span>
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6" href="#index-__codelineno-74-6"></a><span class="w">      </span><span class="c1">// Assume the resource instance access is released at this point</span>
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7" href="#index-__codelineno-74-7"></a><span class="w">      </span><span class="n">k_msleep</span><span class="p">(</span><span class="n">sys_rand32_get</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
</span><span id="__span-74-8"><a id="__codelineno-74-8" name="__codelineno-74-8" href="#index-__codelineno-74-8"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-74-9"><a id="__codelineno-74-9" name="__codelineno-74-9" href="#index-__codelineno-74-9"></a><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>Decrement the available resource in <code>get_access()</code> function.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1" href="#index-__codelineno-75-1"></a><span class="n">available_instance_count</span><span class="o">--</span><span class="p">;</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2" href="#index-__codelineno-75-2"></a><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Resource taken and available_instance_count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w">  </span><span class="n">available_instance_count</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>Increase the available resource in <code>release_access()</code> function.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1" href="#index-__codelineno-76-1"></a><span class="n">available_instance_count</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2" href="#index-__codelineno-76-2"></a><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Resource given and available_instance_count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">available_instance_count</span><span class="p">);</span>
</span></code></pre></div>
<p><code>If you compile and build project here - count will print negative numbers (which shouldnt happen with physical resource)</code></p>
</li>
<li>
<p>Add a semaphore by first defining the semaphore using <code>K_SEM_DEFINE()</code></p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1" href="#index-__codelineno-77-1"></a><span class="n">K_SEM_DEFINE</span><span class="p">(</span><span class="n">instance_monitor_sem</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>Before accessing the resource, take the semaphore using <code>k_sem_take()</code> in <code>get_access()</code>.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1" href="#index-__codelineno-78-1"></a><span class="n">k_sem_take</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance_monitor_sem</span><span class="p">,</span><span class="w"> </span><span class="n">K_FOREVER</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>After finishing accessing the resource release the semaphore using <code>k_sem_give()</code> in <code>release_access()</code>.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1" href="#index-__codelineno-79-1"></a><span class="n">k_sem_give</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance_monitor_sem</span><span class="p">);</span>
</span></code></pre></div>
</li>
</ol>
<p><code>Consumer</code> thread starts accessing all of the 10 resources very quickly but is forced to wait when the resource count becomes 0.
The <code>consumer</code> thread is then blocked until the <code>producer</code> thread gives the semaphore and the resource becomes available, unblocking the <code>consumer</code> thread.</p>
<h3 id="index-use-mutexes">Use mutexes</h3>
<p>Two threads running and accessing the same code section of code. The logic looks perfect when only one thread is accessing the critical section, but when
two different threads try to access the code section simultaneously, unexpected things happen(Race condition).</p>
<ol>
<li>
<p>Enable multithreading in the application in prj.conf
(This configuration defaults to yes in all nRF Connect SDK applications and isn’t strictly necessary to enable manually);</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1" href="#index-__codelineno-80-1"></a><span class="nv">CONFIG_MULTITHREADING</span><span class="o">=</span>y
</span></code></pre></div>
</li>
<li>
<p>Set the priority of threads to have equal priority.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1" href="#index-__codelineno-81-1"></a><span class="cp">#define THREAD0_PRIORITY        4 </span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2" href="#index-__codelineno-81-2"></a><span class="cp">#define THREAD1_PRIORITY        4</span>
</span></code></pre></div>
</li>
<li>
<p>Create the functions for the two threads.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1" href="#index-__codelineno-82-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">thread0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2" href="#index-__codelineno-82-2"></a><span class="p">{</span>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3" href="#index-__codelineno-82-3"></a><span class="w">   </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Thread 0 started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4" href="#index-__codelineno-82-4"></a><span class="w">   </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5" href="#index-__codelineno-82-5"></a><span class="w">      </span><span class="n">shared_code_section</span><span class="p">();</span>
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6" href="#index-__codelineno-82-6"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7" href="#index-__codelineno-82-7"></a><span class="p">}</span>
</span><span id="__span-82-8"><a id="__codelineno-82-8" name="__codelineno-82-8" href="#index-__codelineno-82-8"></a><span class="kt">void</span><span class="w"> </span><span class="nf">thread1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-82-9"><a id="__codelineno-82-9" name="__codelineno-82-9" href="#index-__codelineno-82-9"></a><span class="p">{</span>
</span><span id="__span-82-10"><a id="__codelineno-82-10" name="__codelineno-82-10" href="#index-__codelineno-82-10"></a><span class="w">   </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Thread 1 started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-82-11"><a id="__codelineno-82-11" name="__codelineno-82-11" href="#index-__codelineno-82-11"></a><span class="w">   </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-82-12"><a id="__codelineno-82-12" name="__codelineno-82-12" href="#index-__codelineno-82-12"></a><span class="w">      </span><span class="c1">//shared_code_section(); </span>
</span><span id="__span-82-13"><a id="__codelineno-82-13" name="__codelineno-82-13" href="#index-__codelineno-82-13"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-82-14"><a id="__codelineno-82-14" name="__codelineno-82-14" href="#index-__codelineno-82-14"></a><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>Define variables and implement logic in <code>shared_code_section()</code>.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1" href="#index-__codelineno-83-1"></a><span class="cp">#define COMBINED_TOTAL   40</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2" href="#index-__codelineno-83-2"></a><span class="kt">int32_t</span><span class="w"> </span><span class="n">increment_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3" href="#index-__codelineno-83-3"></a><span class="kt">int32_t</span><span class="w"> </span><span class="n">decrement_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COMBINED_TOTAL</span><span class="p">;</span>
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4" href="#index-__codelineno-83-4"></a>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5" href="#index-__codelineno-83-5"></a><span class="kt">void</span><span class="w"> </span><span class="nf">shared_code_section</span><span class="p">(){</span>
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6" href="#index-__codelineno-83-6"></a><span class="w">   </span><span class="n">increment_count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7" href="#index-__codelineno-83-7"></a><span class="w">   </span><span class="n">increment_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">increment_count</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">COMBINED_TOTAL</span><span class="p">;</span>
</span><span id="__span-83-8"><a id="__codelineno-83-8" name="__codelineno-83-8" href="#index-__codelineno-83-8"></a><span class="w">   </span><span class="n">decrement_count</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-83-9"><a id="__codelineno-83-9" name="__codelineno-83-9" href="#index-__codelineno-83-9"></a><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">decrement_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-83-10"><a id="__codelineno-83-10" name="__codelineno-83-10" href="#index-__codelineno-83-10"></a><span class="w">   </span><span class="p">{</span>
</span><span id="__span-83-11"><a id="__codelineno-83-11" name="__codelineno-83-11" href="#index-__codelineno-83-11"></a><span class="w">      </span><span class="n">decrement_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COMBINED_TOTAL</span><span class="p">;</span>
</span><span id="__span-83-12"><a id="__codelineno-83-12" name="__codelineno-83-12" href="#index-__codelineno-83-12"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-83-13"><a id="__codelineno-83-13" name="__codelineno-83-13" href="#index-__codelineno-83-13"></a><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p>Check for <code>race condition</code> in shared_code_section.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1" href="#index-__codelineno-84-1"></a><span class="k">if</span><span class="p">(</span><span class="n">increment_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">decrement_count</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">COMBINED_TOTAL</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2" href="#index-__codelineno-84-2"></a><span class="w">   </span><span class="p">{</span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3" href="#index-__codelineno-84-3"></a><span class="w">      </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Race condition happend!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4" href="#index-__codelineno-84-4"></a><span class="w">      </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Increment_count (%d) + Decrement_count (%d) = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5" href="#index-__codelineno-84-5"></a><span class="w">                  </span><span class="n">increment_count</span><span class="p">,</span><span class="w"> </span><span class="n">decrement_count</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">increment_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">decrement_count</span><span class="p">));</span>
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6" href="#index-__codelineno-84-6"></a><span class="w">      </span><span class="n">k_msleep</span><span class="p">(</span><span class="mi">400</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sys_rand32_get</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7" href="#index-__codelineno-84-7"></a><span class="w">   </span><span class="p">}</span>
</span></code></pre></div>
<p><code>If you compile and build project here - race condition will not happen, as thread1 is commented</code></p>
</li>
<li>
<p>let thread1 access <code>shared_code_section()</code></p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1" href="#index-__codelineno-85-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">thread1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2" href="#index-__codelineno-85-2"></a><span class="p">{</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3" href="#index-__codelineno-85-3"></a><span class="w">   </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Thread 1 started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4" href="#index-__codelineno-85-4"></a><span class="w">   </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5" href="#index-__codelineno-85-5"></a><span class="w">      </span><span class="n">shared_code_section</span><span class="p">();</span>
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6" href="#index-__codelineno-85-6"></a><span class="w">   </span><span class="p">}</span>
</span><span id="__span-85-7"><a id="__codelineno-85-7" name="__codelineno-85-7" href="#index-__codelineno-85-7"></a><span class="p">}</span>
</span></code></pre></div>
<p><code>If you compile and build project here - race condition will happen</code></p>
</li>
<li>
<p>Define <code>mutex</code></p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1" href="#index-__codelineno-86-1"></a><span class="n">K_MUTEX_DEFINE</span><span class="p">(</span><span class="n">test_mutex</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>Lock mutex before logic in <code>shared_code_section()</code></p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1" href="#index-__codelineno-87-1"></a><span class="n">k_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">test_mutex</span><span class="p">,</span><span class="w"> </span><span class="n">K_FOREVER</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>Unlock it right before if-statement checking race condition.</p>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1" href="#index-__codelineno-88-1"></a><span class="n">k_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">test_mutex</span><span class="p">);</span>
</span></code></pre></div>
</li>
</ol></section><section class="print-page" id="ble"><h1 id="ble-bluetooth-low-energy">Bluetooth Low Energy</h1>
<p><a href="https://developer.nordicsemi.com/nRF_Connect_SDK/doc/latest/zephyr/connectivity/bluetooth/bluetooth-arch.html#host">Zephyr Bluetooth Host</a></p>
<p><a href="https://infocenter.nordicsemi.com/index.jsp?topic=%2Fug_sniffer_ble%2FUG%2Fsniffer_ble%2Fintro.html">nRF Sniffer</a></p>
<p><a href="https://www.wireshark.org/docs/wsug_html_chunked/ChBuildInstallUnixInstallBins.html#_installing_from_debs_under_debian_ubuntu_and_other_debian_derivatives">Wireshark</a></p>
<h2 id="ble-fundamentals">Fundamentals</h2>
<p><img src="../ble/assets/BLEprotocolStack.png" alt="Image description"
style="display: block; margin: auto; width: 85%; height: auto; border-radius: 8px;"></p>
<h3 id="ble-host">Host</h3>
<p>The Bluetooth LE host consists of the following layers:</p>
<ul>
<li>Logical Link Control &amp; Adaptation Protocol (L2CAP): provides data encapsulation services to the upper layers.</li>
<li>Security Manager Protocol (SMP): defines and provides methods for secure communication.</li>
<li>Attribute Protocol (ATT): allows a device to expose certain pieces of data to another device.</li>
<li>Generic Attribute Profile (GATT): defines the necessary sub-procedures for using the ATT layer.</li>
<li>Generic Access Profile (GAP): interfaces directly with the application to handle device discovery and connection-related services.</li>
</ul>
<p>The Zephyr Bluetooth Host implements all these layers and provides an API for applications.</p>
<h3 id="ble-controller">Controller</h3>
<p>The Bluetooth LE controller is comprised of the following layers:</p>
<ul>
<li>Physical Layer (PHY): determines how the actual data is modulated onto the radio waves, and how it is transmitted and received.</li>
<li>Link Layer (LL): manages the state of the radio, defined as one of the following – standby, advertising, scanning, initiating, connection.</li>
</ul>
<h3 id="ble-definitions">Definitions</h3>
<ul>
<li>Advertising: The process of transmitting advertising packets, either just to broadcast data or to be discovered by another device.</li>
<li>Scanning: The process of listening for advertising packets.</li>
<li>Central: A device role that scans and initiates connections with peripherals.</li>
<li>Peripheral: A device role that advertises and accepts connections from centrals.</li>
<li>Broadcaster: A special kind of peripheral that broadcasts advertisement packets without accepting any connection requests.</li>
<li>Observer: A special kind of central that listens to advertising packets without initiating a connection.</li>
</ul>
<h3 id="ble-network-topologies">Network topologies</h3>
<ul>
<li><code>Broadcast</code> data transfer happens without the devices ever establishing a connection. This is done by using the advertisement packets to broadcast
the data to any device that is in range to receive the packets.</li>
<li><code>Connected</code> network topology establishes a connection before data transfer occurs. Unlike the broadcast topology, the communication is now bidirectional.</li>
<li><code>Multi-role</code> A single device can also operate in multiple different roles simultaneously. For instance, the same device can act as a peripheral in
one setting, and a central in another.</li>
</ul>
<h3 id="ble-att-gatt">ATT &amp; GATT</h3>
<ul>
<li>Attribute Protocol - ATT layer is the basis on which data is transmitted, received, and handled in the connection phase of Bluetooth LE devices.
It is based on a client-server architecture.</li>
<li>GATT server: Device that stores data and provides methods for the GATT client to access the data.</li>
<li>GATT client: Device that accesses the data on the GATT server, through specific GATT operations which will be explained in Lesson 4.</li>
<li>
<p>Attribute: A standardized data representation format defined by the ATT protocol</p>
</li>
<li>
<p>Generic Attribute Profile - GATT layer sits directly on top of the ATT layer, and builds on it by hierarchically classifying attributes into profiles,
services and characteristics. The GATT layer uses these concepts to govern the data transfer between Bluetooth LE devices.</p>
</li>
</ul>
<p><img src="../ble/assets/GATT.png" alt="Image description"
style="display: block; margin: auto; width: 85%; height: auto; border-radius: 8px;"></p>
<h3 id="ble-phy-physical-layer">PHY - Physical Layer</h3>
<ul>
<li>1M PHY - classic 1 Megabit PHY supported by all Bluetooth</li>
<li>2M PHY - 2 Megabit PHY is supported Bluetooth v5.0, decreased battery usage with less communication range</li>
<li>Coded PHY - longer communication range by sacrificing data rate</li>
</ul>
<h3 id="ble-advertising-types">Advertising types</h3>
<ul>
<li>Connectable vs. non-connectable: Determines whether the central can connect to the peripheral or not.</li>
<li>Scannable vs. non-scannable: Determines if the peripheral accepts scan requests from a scanner.</li>
<li>Directed vs. undirected: Determines whether advertisement packets are targeted to a specific scanner or not.</li>
</ul>
<p><code>Scannable and connectable (ADV_IND)</code>
<code>Directed connectable (ADV_DIRECT_IND)</code>
<code>Non-connectable and scannable (ADV_SCAN_IND)</code>
<code>Non-connectable and non-scannable (ADV_NONCONN_IND)</code></p>
<h3 id="ble-advertisement-packet">Advertisement packet</h3>
<p>Protocol Data Unit (PDU) consists of either an advertising PDU (advertising channel PDU) or a data PDU (channel PDU)</p>
<p><img src="../ble/assets/advPackets.png" alt="Image description"
style="display: block; margin: auto; width: 85%; height: auto; border-radius: 8px;"></p>
<p>The advertisement payload structure depends on the kind of advertising being used. For example, when doing directed advertisement, some
space is needed to also specify the receiver’s address.</p>
<h2 id="ble-connection-process">Connection process</h2>
<p>When the central sends a connection request, the peripheral and central have established a bi-directional connection (connection-oriented) channel.</p>
<p>connection interval in Bluetooth LE - The interval at which the devices wake up to exchange data</p>
<h3 id="ble-disconnected-by-supervision-timeout">Disconnected by supervision timeout</h3>
<p>The other reason a device may disconnect is if it stops responding to packets. There can be several reasons for this. Either the application on the
connected device crashed and reset (which is not too uncommon, especially during the development phase), the connected device ran out of battery, or
the connected device was taken out of radio range. The amount of time it takes before the connection times out is set by the connection supervision
timeout parameter, which we will discuss in more detail in the next topic.</p>
<ul>
<li>The <code>MTU</code> is the number of bytes that can be sent in one GATT operation (for example, a send operation), while <code>data length</code> is the number of bytes
that can be sent in one Bluetooth LE packet.
<code>MTU</code> has a default value of <code>23 bytes</code>, and <code>data length</code> has a default value of <code>27 bytes</code>.</li>
</ul>
<h2 id="ble-data-exchange-in-bluetooth-le">Data exchange in Bluetooth LE</h2>
<p>Closer look at the Generic Attribute Protocol (GATT), its underlayer Attribute Protocol (ATT).
Learn how to represent and exchange data between two connected Bluetooth LE devices using different GATT operations.</p>
<h3 id="ble-client-initiated-operations">Client-initiated operations</h3>
<p>GATT operations where the client requests data from the GATT server.</p>
<p>Operation used byclient to retrieve services: service discovery,service discovery operation,discovery</p>
<ul>
<li>Read - read request to the server. To which the server responds by returning the attribute value.</li>
<li>Write - sends a write request and provides data that matches the same format of the target attribute. If the server accepts the write operation,
it responds with an acknowledgement.</li>
<li>Write without response - client can write data to an attribute without waiting for an acknowledgment from the server.</li>
</ul>
<h3 id="ble-server-initiated-operations">Server-initiated operations</h3>
<p>These operations are initiated by the server, but the client is required to enable them first by subscribing to the characteristic and enabling either
notifications or indications.</p>
<ul>
<li>Notify - server automatically push the value of a certain attribute to the client, without the client asking for it.</li>
<li>Indicate - Indicate will also push the attribute value directly to the client. However, in this case, an acknowledgment from the client is required
(for this you can only send one Indication per connection interval)</li>
</ul>
<h2 id="ble-services-and-characteristics">Services and characteristics</h2>
<p>ATT layer defines attributes and how data is exposed between a client and a server.</p>
<h3 id="ble-attributes">Attributes</h3>
<p>ATT layer defines how data is stored and accessed in a server’s database.
Data is stored in the form of data structures called Attributes.</p>
<p><img src="../ble/assets/att_server.png" alt="Image description"
style="display: block; margin: auto; width: 85%; height: auto; border-radius: 8px;"></p>
<ul>
<li>Handle: A 16-bit unique index to a specific attribute in the attribute table, assigned by the stack.</li>
<li>Type (UUID): Universally unique ID (UUID), which tells us the attribute type.</li>
<li>Permissions: The security level required (encryption and/or authorization) to handle that attribute, in addition to indicating whether it’s a
readable and/or writeable attribute.</li>
<li>Value:</li>
<li>User data (ex: sensor reading) that is stored in the attribute. This field accepts any data type.</li>
<li>It can also hold information (metadata) about another attribute.</li>
</ul>
<h3 id="ble-universally-unique-id-uuid">Universally unique ID (UUID)</h3>
<p>It is a unique number used to identify attributes and tells us about their significance. UUIDs have two types.</p>
<ul>
<li>SIG-defined 16-bit UUID.</li>
<li>128-bit UUID, sometimes referred to as a vendor-specific UUID. This is the type of UUID you need to use when you are making your own custom
services and characteristics.</li>
</ul>
<h3 id="ble-services">Services</h3>
<p>Attributes are the main building blocks for services.</p>
<ul>
<li>service definition - is comprised of multiple attributes arranged in a GATT-specified format which facilitates standardized data exchange between
Bluetooth LE devices. Service definitions always start with a <strong>service declaration attribute</strong>.</li>
<li>service declaration attribute - holds metadata about the service, it also indicates the beginning of a service in the sequence of services stored
on a GATT server.</li>
<li>characteristic declaration attribute - characteristic is comprised of at least two attributes and optionally more.
Characteristic definition starts with a declaration attribute, to indicate the beginning of a characteristic in the sequence of characteristics in a
service definition attributes:</li>
</ul>
<p><img src="../ble/assets/CharDescAtt.png" alt="Image description"
  style="display: block; margin: auto; width: 75%; height: auto; border-radius: 8px;"></p>
<ul>
<li>Characteristic declaration attribute: Holds metadata about the Characteristic Value Attribute.<ul>
<li>Characteristic properties: What kind of GATT operations are permitted on this characteristic.</li>
<li>Characteristic value handle: The handle (address) of the attribute that contains the user data (value), i.e the characteristic value attribute.</li>
<li>Characteristic UUID: The UUID of the characteristic being declared.</li>
</ul>
</li>
<li>Characteristic value attribute: Holds the actual user data.</li>
<li>Characteristic descriptor attribute (optional): Holds more metadata about the characteristic (GATT-defined Client Characteristic
  Configuration Descriptor (CCCD) is the most commonly used)<ul>
<li>CCCD is a specific type of characteristic descriptor that is necessary when the characteristic supports server-initiated
operations (i.e Notify and Indicate). This is a writable descriptor that allows the GATT client to enable and
disable notifications or indications for that characteristic.</li>
</ul>
</li>
</ul>
<p>A service can have zero or more characteristic definitions (commonly referred to as characteristics).
A characteristic is comprised of at least two attributes and optionally more.</p>
<h2 id="ble-security-in-ble">Security in BLE</h2>
<ul>
<li>Pairing: The process of generating, distributing, and authenticating keys for encryption purposes.</li>
<li>Bonding: The process of pairing followed by distribution of keys used to encrypt the link in future reconnections.</li>
</ul>
<h3 id="ble-pairing">Pairing</h3>
<ul>
<li>Initiation: send pairing request (only contral), peripheral sends pairing response (<code>Security Request</code> or <code>I/O capabilities</code>: DisplayOnly/DisplayTesNo/KeyboardOnly/NoInputNoOutput/KeyboardDispay)</li>
<li>Perform pairing: Just Works (plain text, unauthenticated), Passkey Entry (6-digit), Out of Band, Numeric Comparison)</li>
<li>Key distribution: LTK (Long Term Key) is used to distribute the rest of the keys</li>
</ul>
<h3 id="ble-legacy-pairing">Legacy Pairing</h3>
<p>Prior to Bluetooth v4.2.
STK (Short Term Key) encrypting link can be easly cracked (999999 combinations) and have no MITM protection.</p>
<h3 id="ble-le-secure-connections">LE Secure Connections</h3>
<p>Use Elliptic-Curve Diffie-Hellman (ECDH) cryptography to generate a public-private key pair.
They will use one of the four pairing methods (Just Works, Passkey entry, OOB or Numeric Comparison)
The only data exchanged between the peers is the public keys. The use of the ECDH public key cryptography makes it extremely difficult to crack the LTK</p>
<h3 id="ble-security-concerns">Security concerns</h3>
<ul>
<li>Identity tracking</li>
<li>Sniffing (Passive eavesdropping)</li>
<li>MITM (Active eavesdropping - Man-In-The-Middle attack)</li>
</ul>
<h3 id="ble-security-levels">Security Levels</h3>
<ol>
<li>No security (open text, meaning no authentication and no encryption)</li>
<li>Encryption with unauthenticated pairing (Just Works)</li>
<li>Authenticated pairing with encryption (Passkey entry or OOB)</li>
<li>Authenticated LE Secure Connections pairing with encryption</li>
</ol>
<p><code>Permissions</code> field  of <code>attribute</code> - determines security level of connection if accesible</p>
<h3 id="ble-filter-accept-list">Filter Accept List</h3>
<p>Accepting only connection from whitelist</p>
<h2 id="ble-ble-sniffer">BLE Sniffer</h2>
<p>Intercept the Bluetooth LE packets as they are transmitted, ie. “sniff” the packets, and view them in real-time.</p>
<p>After <strong>WireShark</strong> installation, download <strong>nRF sniffer</strong> and configure it: <a href="https://infocenter.nordicsemi.com/index.jsp?topic=/ug_sniffer_ble/UG/sniffer_ble/intro.html">configuration instruction</a> </p>
<p><img src="../ble/assets/nrf_sniffer.png" alt="Image description"
  style="display: block; margin: auto; width: 75%; height: auto; border-radius: 8px;"></p></section><section class="print-page" id="briefcode"><h1 id="briefcode-brief-of-all-codeconfig">Brief of all code/config</h1>
<p><button id="toggle-admonitions" class="md-button">Collapse All/Expand All Code</button></p>
<script>
  document.getElementById('toggle-admonitions').addEventListener('click', function (event) {

    event.preventDefault();
    var admonitions = document.querySelectorAll('details');
    var anyOpen = false;

    var button = document.getElementById('toggle-admonitions');
    admonitions.forEach(function (admonition) {
      var admonitions = document.querySelectorAll('details');
      admonitions.forEach(function (admonition) {
        if (button.textContent == 'Collapse All') {
          if (admonition.hasAttribute('open')) {
            admonition.removeAttribute('open');
          }
        }
        else {
          admonition.setAttribute('open', '');
          anyOpen = true;
        }
      });
    });

    if (anyOpen) {
      button.textContent = 'Collapse All';
    } else {
      button.textContent = 'Expand All';
    }

  });

</script>

<h2 id="briefcode-paths">~PATHs</h2>
<p>Device tree file</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#briefcode-__codelineno-0-1"></a>&lt;install_path&gt;<span class="se">\z</span>ephyr<span class="se">\b</span>oards<span class="se">\a</span>rm<span class="se">\&lt;</span>board_name&gt;
</span></code></pre></div>
<h2 id="briefcode-cmakeliststxt"><code>CMakeLists.txt</code></h2>
<div class="language-apacheconf highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#briefcode-__codelineno-1-1"></a><span class="nb">cmake_minimum_required</span>(VERSION<span class="w"> </span><span class="m">3</span>.20.0)
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#briefcode-__codelineno-1-2"></a><span class="nb">find_package</span>(Zephyr<span class="w"> </span>REQUIRED<span class="w"> </span>HINTS<span class="w"> </span>$ENV{ZEPHYR_BASE})
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#briefcode-__codelineno-1-3"></a><span class="nb">project</span>(nrf_connect_sdk_fundamentals)
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#briefcode-__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#briefcode-__codelineno-1-5"></a><span class="nb">target_sources</span>(app<span class="w"> </span>PRIVATE<span class="w"> </span>src/main.c)
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#briefcode-__codelineno-1-6"></a><span class="c"># target_sources_ifdef(CONFIG_MYFUNCTION app PRIVATE src/myfunction.c) # myfunction.c (in this case) in the same folder as main.c</span>
</span></code></pre></div>
<details class="example">
<summary>myfunction.c &amp; myfunction.h</summary>
<ul>
<li>myfunction.c</li>
</ul>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#briefcode-__codelineno-2-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;myfunction.h&quot;</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#briefcode-__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#briefcode-__codelineno-2-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">){</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#briefcode-__codelineno-2-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="o">+</span><span class="n">b</span><span class="p">;</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#briefcode-__codelineno-2-5"></a><span class="p">}</span>
</span></code></pre></div>
<ul>
<li>myfunction.h</li>
</ul>
<div class="language-cpp highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#briefcode-__codelineno-3-1"></a><span class="cp">#ifndef MY_FUNCTION_H</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#briefcode-__codelineno-3-2"></a><span class="cp">#define MY_FUNCTION_H</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#briefcode-__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#briefcode-__codelineno-3-4"></a><span class="kt">int</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">b</span><span class="p">);</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#briefcode-__codelineno-3-5"></a>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#briefcode-__codelineno-3-6"></a><span class="cp">#endif</span>
</span></code></pre></div>
</details>
<h2 id="briefcode-prjconf"><code>prj.conf</code></h2>
<div class="language-apacheconf highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#briefcode-__codelineno-4-1"></a><span class="c">## IO</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#briefcode-__codelineno-4-2"></a><span class="nb">CONFIG_GPIO</span>=y
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#briefcode-__codelineno-4-3"></a><span class="nb">CONFIG_SERIAL</span>=y<span class="w">                 </span>##Enable<span class="w"> </span>the<span class="w"> </span>serial<span class="w"> </span>driver<span class="w"> </span>in<span class="w"> </span>asynchronous<span class="w"> </span>mode<span class="w"> </span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#briefcode-__codelineno-4-4"></a><span class="nb">CONFIG_UART_ASYNC_API</span>=y<span class="w">         </span>#<span class="w"> </span>↑
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#briefcode-__codelineno-4-5"></a><span class="nb">CONFIG_I2C</span>=y<span class="w">                    </span>#<span class="w"> </span>Enable<span class="w"> </span>the<span class="w"> </span>I2C<span class="w"> </span>driver
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#briefcode-__codelineno-4-6"></a>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#briefcode-__codelineno-4-7"></a><span class="nb">CONFIG_CBPRINTF_FP_SUPPORT</span>=y<span class="w">    </span>#<span class="w"> </span>Enable<span class="w"> </span>floating<span class="w"> </span>point<span class="w"> </span>format<span class="w"> </span>specifiers
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#briefcode-__codelineno-4-8"></a><span class="nb">CONFIG_PRINTK</span>=y<span class="w">                 </span>#<span class="w"> </span>Enable<span class="w"> </span>the<span class="w"> </span>printk<span class="w"> </span>function
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#briefcode-__codelineno-4-9"></a><span class="nb">CONFIG_ENTROPY_GENERATOR</span>=y
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#briefcode-__codelineno-4-10"></a><span class="nb">CONFIG_TEST_RANDOM_GENERATOR</span>=y
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#briefcode-__codelineno-4-11"></a>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#briefcode-__codelineno-4-12"></a><span class="c">## LOGS</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#briefcode-__codelineno-4-13"></a><span class="nb">CONFIG_LOG</span>=y<span class="w">                    </span>#<span class="w"> </span>Enable<span class="w"> </span>logger<span class="w"> </span>module
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#briefcode-__codelineno-4-14"></a><span class="nb">CONFIG_LOG_BACKEND_SHOW_COLOR</span>=n<span class="w"> </span>#<span class="w"> </span>Disable<span class="w"> </span>colors<span class="w"> </span>in<span class="w"> </span>the<span class="w"> </span>backend
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#briefcode-__codelineno-4-15"></a><span class="nb">CONFIG_LOG_MODE_MINIMAL</span>=y<span class="w">       </span>#<span class="w"> </span>Enable<span class="w"> </span><span class="k">minimal</span><span class="w"> </span>logging
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#briefcode-__codelineno-4-16"></a>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#briefcode-__codelineno-4-17"></a><span class="c">## CUSTOM</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#briefcode-__codelineno-4-18"></a><span class="nb">CONFIG_MYFUNCTION</span>=y<span class="w"> </span>#<span class="w"> </span>allows:<span class="w"> </span>#ifdef<span class="w"> </span>CONFIG_MYFUNCTION
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#briefcode-__codelineno-4-19"></a>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#briefcode-__codelineno-4-20"></a><span class="c">## THREADS</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#briefcode-__codelineno-4-21"></a><span class="nb">CONFIG_TIMESLICING</span>=y<span class="w">            </span>##enable<span class="w"> </span>timeslicing
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#briefcode-__codelineno-4-22"></a><span class="nb">CONFIG_TIMESLICE_SIZE</span>=10<span class="w">        </span>#<span class="w"> </span>↑
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#briefcode-__codelineno-4-23"></a><span class="nb">CONFIG_TIMESLICE_PRIORITY</span>=0<span class="w">     </span>#<span class="w"> </span>↑
</span></code></pre></div>
<h2 id="briefcode-overlay"><code>.overlay</code></h2>
<p>In the <code>Details View</code>, there is an option to create an overlay file with the same board name used for the build. To apply changes do <code>pristine build</code>.
In the same folder as prj.conf, eg: <code>nrf52833dk_nrf52833.overlay</code>.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#briefcode-__codelineno-5-1"></a><span class="p">&amp;</span>uart0<span class="w"> </span><span class="o">{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#briefcode-__codelineno-5-2"></a><span class="w"> </span>current-speed<span class="w"> </span><span class="o">=</span><span class="w"> </span>&lt;<span class="m">9600</span>&gt;<span class="p">;</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#briefcode-__codelineno-5-3"></a><span class="o">}</span><span class="p">;</span>
</span></code></pre></div>
<h2 id="briefcode-kconfigzephyr"><code>Kconfig.zephyr</code></h2>
<p>Configuring system parameters</p>
<details class="example">
<summary>MYFUNCTION</summary>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#briefcode-__codelineno-6-1"></a><span class="nb">source</span><span class="w"> </span><span class="s2">&quot;Kconfig.zephyr&quot;</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#briefcode-__codelineno-6-2"></a>config<span class="w"> </span>MYFUNCTION
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#briefcode-__codelineno-6-3"></a><span class="w">    </span>bool<span class="w"> </span><span class="s2">&quot;Enable my function&quot;</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#briefcode-__codelineno-6-4"></a><span class="w">    </span>default<span class="w"> </span>n
</span></code></pre></div>
<ul>
<li>
<p><code>source "Kconfig.zephyr"</code>: This line includes the contents of the file named "Kconfig.zephyr". This is typically used to include configuration
options from another file.</p>
</li>
<li>
<p><code>config MYFUNCTION</code>: This line declares a new configuration option named "MYFUNCTION".</p>
</li>
<li>
<p><code>bool "Enable my function"</code>: This line sets the type of the configuration option to boolean, and provides a prompt string "Enable my function"
that will be displayed to the user when they are configuring the system.</p>
</li>
<li>
<p><code>default n</code>: This line sets the default value of the configuration option to 'n' (no). If the user does not explicitly set this option,
it will be 'n'.</p>
</li>
</ul>
</details>
<h2 id="briefcode-mainc"><code>main.c</code></h2>
<details class="example">
<summary>blinky - pooling data</summary>
<div class="language-c highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#briefcode-__codelineno-7-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#briefcode-__codelineno-7-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/device.h&gt;</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#briefcode-__codelineno-7-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/devicetree.h&gt;</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#briefcode-__codelineno-7-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/gpio.h&gt;</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#briefcode-__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#briefcode-__codelineno-7-6"></a><span class="cm">/* STEP 7 - Change the sleep time from 1000 ms to 100 ms */</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#briefcode-__codelineno-7-7"></a><span class="cp">#define SLEEP_TIME_MS   100</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8" href="#briefcode-__codelineno-7-8"></a>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9" href="#briefcode-__codelineno-7-9"></a><span class="cm">/* STEP 3.1 - Get the node identifier for button 1 through its alias sw0 */</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10" href="#briefcode-__codelineno-7-10"></a><span class="cp">#define SW0_NODE    DT_ALIAS(sw0)</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11" href="#briefcode-__codelineno-7-11"></a>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12" href="#briefcode-__codelineno-7-12"></a><span class="cm">/* STEP 3.2 - Get the device pointer. pin number, and pin&#39;s configuration flags through gpio_dt_spec */</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13" href="#briefcode-__codelineno-7-13"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">SW0_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">gpios</span><span class="p">);</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14" href="#briefcode-__codelineno-7-14"></a>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15" href="#briefcode-__codelineno-7-15"></a><span class="cm">/* LED0_NODE is the devicetree node identifier for the &quot;led0&quot; alias. */</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16" href="#briefcode-__codelineno-7-16"></a><span class="cp">#define LED0_NODE DT_ALIAS(led0)</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17" href="#briefcode-__codelineno-7-17"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">led</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">LED0_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">gpios</span><span class="p">);</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18" href="#briefcode-__codelineno-7-18"></a>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19" href="#briefcode-__codelineno-7-19"></a>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20" href="#briefcode-__codelineno-7-20"></a><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21" href="#briefcode-__codelineno-7-21"></a><span class="p">{</span>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22" href="#briefcode-__codelineno-7-22"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23" href="#briefcode-__codelineno-7-23"></a>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24" href="#briefcode-__codelineno-7-24"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">led</span><span class="p">.</span><span class="n">port</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25" href="#briefcode-__codelineno-7-25"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26" href="#briefcode-__codelineno-7-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27" href="#briefcode-__codelineno-7-27"></a><span class="w">    </span><span class="cm">/* STEP 4 - Verify that the device is ready for use */</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28" href="#briefcode-__codelineno-7-28"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">button</span><span class="p">.</span><span class="n">port</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29" href="#briefcode-__codelineno-7-29"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30" href="#briefcode-__codelineno-7-30"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31" href="#briefcode-__codelineno-7-31"></a>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32" href="#briefcode-__codelineno-7-32"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_OUTPUT_ACTIVE</span><span class="p">);</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33" href="#briefcode-__codelineno-7-33"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34" href="#briefcode-__codelineno-7-34"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35" href="#briefcode-__codelineno-7-35"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36" href="#briefcode-__codelineno-7-36"></a>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37" href="#briefcode-__codelineno-7-37"></a><span class="w">    </span><span class="cm">/* STEP 5 - Configure the pin connected to the button to be an input pin and set its hardware specifications */</span>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38" href="#briefcode-__codelineno-7-38"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">button</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_INPUT</span><span class="p">);</span>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39" href="#briefcode-__codelineno-7-39"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40" href="#briefcode-__codelineno-7-40"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41" href="#briefcode-__codelineno-7-41"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42" href="#briefcode-__codelineno-7-42"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43" href="#briefcode-__codelineno-7-43"></a><span class="w">        </span><span class="cm">/* STEP 6.1 - Read the status of the button and store it */</span>
</span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44" href="#briefcode-__codelineno-7-44"></a><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_get_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">button</span><span class="p">);</span>
</span><span id="__span-7-45"><a id="__codelineno-7-45" name="__codelineno-7-45" href="#briefcode-__codelineno-7-45"></a>
</span><span id="__span-7-46"><a id="__codelineno-7-46" name="__codelineno-7-46" href="#briefcode-__codelineno-7-46"></a><span class="w">        </span><span class="cm">/* STEP 6.2 - Update the LED to the status of the button */</span>
</span><span id="__span-7-47"><a id="__codelineno-7-47" name="__codelineno-7-47" href="#briefcode-__codelineno-7-47"></a><span class="w">        </span><span class="n">gpio_pin_set_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">,</span><span class="n">val</span><span class="p">);</span>
</span><span id="__span-7-48"><a id="__codelineno-7-48" name="__codelineno-7-48" href="#briefcode-__codelineno-7-48"></a>
</span><span id="__span-7-49"><a id="__codelineno-7-49" name="__codelineno-7-49" href="#briefcode-__codelineno-7-49"></a><span class="w">        </span><span class="n">k_msleep</span><span class="p">(</span><span class="n">SLEEP_TIME_MS</span><span class="p">);</span><span class="w"> </span><span class="c1">// Put the main thread to sleep for 100ms for power optimization</span>
</span><span id="__span-7-50"><a id="__codelineno-7-50" name="__codelineno-7-50" href="#briefcode-__codelineno-7-50"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-7-51"><a id="__codelineno-7-51" name="__codelineno-7-51" href="#briefcode-__codelineno-7-51"></a><span class="p">}</span>
</span></code></pre></div>
</details>
<details class="example">
<summary>blinky2 - button with callback</summary>
<div class="language-c highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#briefcode-__codelineno-8-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#briefcode-__codelineno-8-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/device.h&gt;</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#briefcode-__codelineno-8-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/devicetree.h&gt;</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#briefcode-__codelineno-8-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/gpio.h&gt;</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#briefcode-__codelineno-8-5"></a>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#briefcode-__codelineno-8-6"></a><span class="cm">/* STEP 9 - Increase the sleep time from 100ms to 10 minutes  */</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#briefcode-__codelineno-8-7"></a><span class="cp">#define SLEEP_TIME_MS   10*60*1000</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#briefcode-__codelineno-8-8"></a>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#briefcode-__codelineno-8-9"></a><span class="cm">/* SW0_NODE is the devicetree node identifier for the node with alias &quot;sw0&quot; */</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#briefcode-__codelineno-8-10"></a><span class="cp">#define SW0_NODE    DT_ALIAS(sw0) </span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#briefcode-__codelineno-8-11"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">SW0_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">gpios</span><span class="p">);</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#briefcode-__codelineno-8-12"></a>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#briefcode-__codelineno-8-13"></a><span class="cm">/* LED0_NODE is the devicetree node identifier for the node with alias &quot;led0&quot;. */</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#briefcode-__codelineno-8-14"></a><span class="cp">#define LED0_NODE   DT_ALIAS(led0)</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#briefcode-__codelineno-8-15"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">led</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">LED0_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">gpios</span><span class="p">);</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#briefcode-__codelineno-8-16"></a>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#briefcode-__codelineno-8-17"></a>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#briefcode-__codelineno-8-18"></a><span class="cm">/* STEP 4 - Define the callback function */</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#briefcode-__codelineno-8-19"></a><span class="kt">void</span><span class="w"> </span><span class="nf">button_pressed</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_callback</span><span class="w"> </span><span class="o">*</span><span class="n">cb</span><span class="p">,</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">pins</span><span class="p">)</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#briefcode-__codelineno-8-20"></a><span class="p">{</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#briefcode-__codelineno-8-21"></a><span class="w">    </span><span class="n">gpio_pin_toggle_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">);</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#briefcode-__codelineno-8-22"></a><span class="p">}</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#briefcode-__codelineno-8-23"></a><span class="cm">/* STEP 5 - Define a variable of type static struct gpio_callback */</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#briefcode-__codelineno-8-24"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_callback</span><span class="w"> </span><span class="n">button_cb_data</span><span class="p">;</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#briefcode-__codelineno-8-25"></a>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#briefcode-__codelineno-8-26"></a><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#briefcode-__codelineno-8-27"></a><span class="p">{</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#briefcode-__codelineno-8-28"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="#briefcode-__codelineno-8-29"></a>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30" href="#briefcode-__codelineno-8-30"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">led</span><span class="p">.</span><span class="n">port</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31" href="#briefcode-__codelineno-8-31"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32" href="#briefcode-__codelineno-8-32"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33" href="#briefcode-__codelineno-8-33"></a>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34" href="#briefcode-__codelineno-8-34"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">button</span><span class="p">.</span><span class="n">port</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35" href="#briefcode-__codelineno-8-35"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36" href="#briefcode-__codelineno-8-36"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-37"><a id="__codelineno-8-37" name="__codelineno-8-37" href="#briefcode-__codelineno-8-37"></a>
</span><span id="__span-8-38"><a id="__codelineno-8-38" name="__codelineno-8-38" href="#briefcode-__codelineno-8-38"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_OUTPUT_ACTIVE</span><span class="p">);</span>
</span><span id="__span-8-39"><a id="__codelineno-8-39" name="__codelineno-8-39" href="#briefcode-__codelineno-8-39"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-40"><a id="__codelineno-8-40" name="__codelineno-8-40" href="#briefcode-__codelineno-8-40"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-8-41"><a id="__codelineno-8-41" name="__codelineno-8-41" href="#briefcode-__codelineno-8-41"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-42"><a id="__codelineno-8-42" name="__codelineno-8-42" href="#briefcode-__codelineno-8-42"></a>
</span><span id="__span-8-43"><a id="__codelineno-8-43" name="__codelineno-8-43" href="#briefcode-__codelineno-8-43"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">button</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_INPUT</span><span class="p">);</span>
</span><span id="__span-8-44"><a id="__codelineno-8-44" name="__codelineno-8-44" href="#briefcode-__codelineno-8-44"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-45"><a id="__codelineno-8-45" name="__codelineno-8-45" href="#briefcode-__codelineno-8-45"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-8-46"><a id="__codelineno-8-46" name="__codelineno-8-46" href="#briefcode-__codelineno-8-46"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-47"><a id="__codelineno-8-47" name="__codelineno-8-47" href="#briefcode-__codelineno-8-47"></a><span class="w">    </span><span class="cm">/* STEP 3 - Configure the interrupt on the button&#39;s pin */</span>
</span><span id="__span-8-48"><a id="__codelineno-8-48" name="__codelineno-8-48" href="#briefcode-__codelineno-8-48"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_interrupt_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">button</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_INT_EDGE_TO_ACTIVE</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-8-49"><a id="__codelineno-8-49" name="__codelineno-8-49" href="#briefcode-__codelineno-8-49"></a>
</span><span id="__span-8-50"><a id="__codelineno-8-50" name="__codelineno-8-50" href="#briefcode-__codelineno-8-50"></a><span class="w">    </span><span class="cm">/* STEP 6 - Initialize the static struct gpio_callback variable   */</span>
</span><span id="__span-8-51"><a id="__codelineno-8-51" name="__codelineno-8-51" href="#briefcode-__codelineno-8-51"></a><span class="w">    </span><span class="n">gpio_init_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">button_cb_data</span><span class="p">,</span><span class="w"> </span><span class="n">button_pressed</span><span class="p">,</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="n">button</span><span class="p">.</span><span class="n">pin</span><span class="p">));</span><span class="w">   </span>
</span><span id="__span-8-52"><a id="__codelineno-8-52" name="__codelineno-8-52" href="#briefcode-__codelineno-8-52"></a>
</span><span id="__span-8-53"><a id="__codelineno-8-53" name="__codelineno-8-53" href="#briefcode-__codelineno-8-53"></a><span class="w">    </span><span class="cm">/* STEP 7 - Add the callback function by calling gpio_add_callback()   */</span>
</span><span id="__span-8-54"><a id="__codelineno-8-54" name="__codelineno-8-54" href="#briefcode-__codelineno-8-54"></a><span class="w">     </span><span class="n">gpio_add_callback</span><span class="p">(</span><span class="n">button</span><span class="p">.</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">button_cb_data</span><span class="p">);</span>
</span><span id="__span-8-55"><a id="__codelineno-8-55" name="__codelineno-8-55" href="#briefcode-__codelineno-8-55"></a>
</span><span id="__span-8-56"><a id="__codelineno-8-56" name="__codelineno-8-56" href="#briefcode-__codelineno-8-56"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-57"><a id="__codelineno-8-57" name="__codelineno-8-57" href="#briefcode-__codelineno-8-57"></a><span class="w">        </span><span class="cm">/* STEP 8 - Remove the polling code */</span>
</span><span id="__span-8-58"><a id="__codelineno-8-58" name="__codelineno-8-58" href="#briefcode-__codelineno-8-58"></a>
</span><span id="__span-8-59"><a id="__codelineno-8-59" name="__codelineno-8-59" href="#briefcode-__codelineno-8-59"></a><span class="w">        </span><span class="n">k_msleep</span><span class="p">(</span><span class="n">SLEEP_TIME_MS</span><span class="p">);</span>
</span><span id="__span-8-60"><a id="__codelineno-8-60" name="__codelineno-8-60" href="#briefcode-__codelineno-8-60"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-61"><a id="__codelineno-8-61" name="__codelineno-8-61" href="#briefcode-__codelineno-8-61"></a><span class="p">}</span>
</span></code></pre></div>
</details>
<details class="example">
<summary>myfun - enabled MYFUNCTION (need <code>Kconfig.zephyr</code> and <code>myfunction.h &amp; c</code>)</summary>
<div class="language-c highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#briefcode-__codelineno-9-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#briefcode-__codelineno-9-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/sys/printk.h&gt;</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#briefcode-__codelineno-9-3"></a>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#briefcode-__codelineno-9-4"></a><span class="cp">#ifdef CONFIG_MYFUNCTION</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5" href="#briefcode-__codelineno-9-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;myfunction.h&quot;</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6" href="#briefcode-__codelineno-9-6"></a><span class="cp">#endif</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7" href="#briefcode-__codelineno-9-7"></a>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8" href="#briefcode-__codelineno-9-8"></a><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9" href="#briefcode-__codelineno-9-9"></a><span class="p">{</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10" href="#briefcode-__codelineno-9-10"></a>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11" href="#briefcode-__codelineno-9-11"></a><span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12" href="#briefcode-__codelineno-9-12"></a><span class="w">        </span><span class="cp">#ifdef CONFIG_MYFUNCTION</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13" href="#briefcode-__codelineno-9-13"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14" href="#briefcode-__codelineno-9-14"></a><span class="w">            </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;The sum of %d and %d is %d</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">sum</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">));</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15" href="#briefcode-__codelineno-9-15"></a><span class="w">        </span><span class="cp">#else</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16" href="#briefcode-__codelineno-9-16"></a><span class="w">            </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;MYFUNCTION not enabled</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17" href="#briefcode-__codelineno-9-17"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18" href="#briefcode-__codelineno-9-18"></a><span class="w">        </span><span class="cp">#endif</span>
</span><span id="__span-9-19"><a id="__codelineno-9-19" name="__codelineno-9-19" href="#briefcode-__codelineno-9-19"></a><span class="w">        </span><span class="n">k_msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span><span id="__span-9-20"><a id="__codelineno-9-20" name="__codelineno-9-20" href="#briefcode-__codelineno-9-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-21"><a id="__codelineno-9-21" name="__codelineno-9-21" href="#briefcode-__codelineno-9-21"></a><span class="p">}</span>
</span></code></pre></div>
</details>
<details class="example">
<summary>factorial - (ISR)Calculate and print factorials after button click</summary>
<div class="language-c highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#briefcode-__codelineno-10-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#briefcode-__codelineno-10-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/device.h&gt;</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#briefcode-__codelineno-10-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/devicetree.h&gt;</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#briefcode-__codelineno-10-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/gpio.h&gt;</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#briefcode-__codelineno-10-5"></a><span class="cm">/* STEP 6 - Include the header file of printk */</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#briefcode-__codelineno-10-6"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/sys/printk.h&gt;</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#briefcode-__codelineno-10-7"></a>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#briefcode-__codelineno-10-8"></a><span class="cm">/* STEP 8.1 - Define the macro MAX_NUMBER_FACT that represents the maximum number to calculate its factorial  */</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#briefcode-__codelineno-10-9"></a><span class="cp">#define MAX_NUMBER_FACT 10</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#briefcode-__codelineno-10-10"></a>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#briefcode-__codelineno-10-11"></a><span class="cp">#define SLEEP_TIME_MS   10*60*1000</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#briefcode-__codelineno-10-12"></a>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#briefcode-__codelineno-10-13"></a><span class="cp">#define SW0_NODE    DT_ALIAS(sw0)</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#briefcode-__codelineno-10-14"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">SW0_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">gpios</span><span class="p">);</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#briefcode-__codelineno-10-15"></a>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#briefcode-__codelineno-10-16"></a><span class="cp">#define LED0_NODE DT_ALIAS(led0)</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#briefcode-__codelineno-10-17"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">led</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">LED0_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">gpios</span><span class="p">);</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#briefcode-__codelineno-10-18"></a>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#briefcode-__codelineno-10-19"></a><span class="cm">/* STEP 8.2 - Replace the button callback function */</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#briefcode-__codelineno-10-20"></a><span class="kt">void</span><span class="w"> </span><span class="nf">button_pressed</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_callback</span><span class="w"> </span><span class="o">*</span><span class="n">cb</span><span class="p">,</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#briefcode-__codelineno-10-21"></a><span class="w">            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">pins</span><span class="p">)</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#briefcode-__codelineno-10-22"></a><span class="p">{</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#briefcode-__codelineno-10-23"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#briefcode-__codelineno-10-24"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#briefcode-__codelineno-10-25"></a><span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">factorial</span><span class="p">;</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#briefcode-__codelineno-10-26"></a><span class="w">  </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Calculating the factorials of numbers from 1 to %d:</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span><span class="n">MAX_NUMBER_FACT</span><span class="p">);</span>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#briefcode-__codelineno-10-27"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">MAX_NUMBER_FACT</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#briefcode-__codelineno-10-28"></a><span class="w">       </span><span class="n">factorial</span><span class="w"> </span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="#briefcode-__codelineno-10-29"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;=</span><span class="n">i</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">){</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="#briefcode-__codelineno-10-30"></a><span class="w">            </span><span class="n">factorial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factorial</span><span class="o">*</span><span class="n">j</span><span class="p">;</span>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="#briefcode-__codelineno-10-31"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32" href="#briefcode-__codelineno-10-32"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;The factorial of %2d = %ld</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">factorial</span><span class="p">);</span>
</span><span id="__span-10-33"><a id="__codelineno-10-33" name="__codelineno-10-33" href="#briefcode-__codelineno-10-33"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-10-34"><a id="__codelineno-10-34" name="__codelineno-10-34" href="#briefcode-__codelineno-10-34"></a><span class="w">  </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;_______________________________________________________</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-10-35"><a id="__codelineno-10-35" name="__codelineno-10-35" href="#briefcode-__codelineno-10-35"></a><span class="w">  </span><span class="cm">/*Important note! </span>
</span><span id="__span-10-36"><a id="__codelineno-10-36" name="__codelineno-10-36" href="#briefcode-__codelineno-10-36"></a><span class="cm">  Code in ISR runs at a high priority, therefore, it should be written with timing in mind.</span>
</span><span id="__span-10-37"><a id="__codelineno-10-37" name="__codelineno-10-37" href="#briefcode-__codelineno-10-37"></a><span class="cm">  Too lengthy or too complex tasks should not be performed by an ISR, they should be deferred to a thread. </span>
</span><span id="__span-10-38"><a id="__codelineno-10-38" name="__codelineno-10-38" href="#briefcode-__codelineno-10-38"></a><span class="cm">  */</span>
</span><span id="__span-10-39"><a id="__codelineno-10-39" name="__codelineno-10-39" href="#briefcode-__codelineno-10-39"></a><span class="p">}</span>
</span><span id="__span-10-40"><a id="__codelineno-10-40" name="__codelineno-10-40" href="#briefcode-__codelineno-10-40"></a>
</span><span id="__span-10-41"><a id="__codelineno-10-41" name="__codelineno-10-41" href="#briefcode-__codelineno-10-41"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_callback</span><span class="w"> </span><span class="n">button_cb_data</span><span class="p">;</span>
</span><span id="__span-10-42"><a id="__codelineno-10-42" name="__codelineno-10-42" href="#briefcode-__codelineno-10-42"></a>
</span><span id="__span-10-43"><a id="__codelineno-10-43" name="__codelineno-10-43" href="#briefcode-__codelineno-10-43"></a><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-10-44"><a id="__codelineno-10-44" name="__codelineno-10-44" href="#briefcode-__codelineno-10-44"></a><span class="p">{</span>
</span><span id="__span-10-45"><a id="__codelineno-10-45" name="__codelineno-10-45" href="#briefcode-__codelineno-10-45"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-10-46"><a id="__codelineno-10-46" name="__codelineno-10-46" href="#briefcode-__codelineno-10-46"></a><span class="w">    </span><span class="cm">/* STEP 7 - Print a simple banner */</span>
</span><span id="__span-10-47"><a id="__codelineno-10-47" name="__codelineno-10-47" href="#briefcode-__codelineno-10-47"></a><span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;nRF Connect SDK Fundamentals - Lesson 4 - Exercise 1</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-10-48"><a id="__codelineno-10-48" name="__codelineno-10-48" href="#briefcode-__codelineno-10-48"></a>
</span><span id="__span-10-49"><a id="__codelineno-10-49" name="__codelineno-10-49" href="#briefcode-__codelineno-10-49"></a><span class="w">    </span><span class="cm">/* Only checking one since led.port and button.port point to the same device, &amp;gpio0 */</span>
</span><span id="__span-10-50"><a id="__codelineno-10-50" name="__codelineno-10-50" href="#briefcode-__codelineno-10-50"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">led</span><span class="p">.</span><span class="n">port</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-51"><a id="__codelineno-10-51" name="__codelineno-10-51" href="#briefcode-__codelineno-10-51"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-10-52"><a id="__codelineno-10-52" name="__codelineno-10-52" href="#briefcode-__codelineno-10-52"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-53"><a id="__codelineno-10-53" name="__codelineno-10-53" href="#briefcode-__codelineno-10-53"></a>
</span><span id="__span-10-54"><a id="__codelineno-10-54" name="__codelineno-10-54" href="#briefcode-__codelineno-10-54"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_OUTPUT_ACTIVE</span><span class="p">);</span>
</span><span id="__span-10-55"><a id="__codelineno-10-55" name="__codelineno-10-55" href="#briefcode-__codelineno-10-55"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-56"><a id="__codelineno-10-56" name="__codelineno-10-56" href="#briefcode-__codelineno-10-56"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-10-57"><a id="__codelineno-10-57" name="__codelineno-10-57" href="#briefcode-__codelineno-10-57"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-58"><a id="__codelineno-10-58" name="__codelineno-10-58" href="#briefcode-__codelineno-10-58"></a>
</span><span id="__span-10-59"><a id="__codelineno-10-59" name="__codelineno-10-59" href="#briefcode-__codelineno-10-59"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">button</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_INPUT</span><span class="p">);</span>
</span><span id="__span-10-60"><a id="__codelineno-10-60" name="__codelineno-10-60" href="#briefcode-__codelineno-10-60"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-61"><a id="__codelineno-10-61" name="__codelineno-10-61" href="#briefcode-__codelineno-10-61"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-10-62"><a id="__codelineno-10-62" name="__codelineno-10-62" href="#briefcode-__codelineno-10-62"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-63"><a id="__codelineno-10-63" name="__codelineno-10-63" href="#briefcode-__codelineno-10-63"></a>
</span><span id="__span-10-64"><a id="__codelineno-10-64" name="__codelineno-10-64" href="#briefcode-__codelineno-10-64"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_interrupt_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">button</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_INT_EDGE_TO_ACTIVE</span><span class="p">);</span>
</span><span id="__span-10-65"><a id="__codelineno-10-65" name="__codelineno-10-65" href="#briefcode-__codelineno-10-65"></a>
</span><span id="__span-10-66"><a id="__codelineno-10-66" name="__codelineno-10-66" href="#briefcode-__codelineno-10-66"></a><span class="w">    </span><span class="n">gpio_init_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">button_cb_data</span><span class="p">,</span><span class="w"> </span><span class="n">button_pressed</span><span class="p">,</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="n">button</span><span class="p">.</span><span class="n">pin</span><span class="p">));</span><span class="w">   </span>
</span><span id="__span-10-67"><a id="__codelineno-10-67" name="__codelineno-10-67" href="#briefcode-__codelineno-10-67"></a>
</span><span id="__span-10-68"><a id="__codelineno-10-68" name="__codelineno-10-68" href="#briefcode-__codelineno-10-68"></a><span class="w">    </span><span class="n">gpio_add_callback</span><span class="p">(</span><span class="n">button</span><span class="p">.</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">button_cb_data</span><span class="p">);</span><span class="w">    </span>
</span><span id="__span-10-69"><a id="__codelineno-10-69" name="__codelineno-10-69" href="#briefcode-__codelineno-10-69"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-70"><a id="__codelineno-10-70" name="__codelineno-10-70" href="#briefcode-__codelineno-10-70"></a><span class="w">        </span><span class="n">k_msleep</span><span class="p">(</span><span class="n">SLEEP_TIME_MS</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-10-71"><a id="__codelineno-10-71" name="__codelineno-10-71" href="#briefcode-__codelineno-10-71"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-72"><a id="__codelineno-10-72" name="__codelineno-10-72" href="#briefcode-__codelineno-10-72"></a><span class="p">}</span>
</span></code></pre></div>
</details>
<details class="example">
<summary>factorial_log - (ISR + Logger)Calculate and print factorials after button click</summary>
<div class="language-c highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#briefcode-__codelineno-11-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#briefcode-__codelineno-11-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/device.h&gt;</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#briefcode-__codelineno-11-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/devicetree.h&gt;</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#briefcode-__codelineno-11-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/gpio.h&gt;</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#briefcode-__codelineno-11-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/sys/printk.h&gt;</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#briefcode-__codelineno-11-6"></a><span class="cm">/* STEP 4 - Include the header file of the logger module */</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#briefcode-__codelineno-11-7"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/logging/log.h&gt;</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#briefcode-__codelineno-11-8"></a>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#briefcode-__codelineno-11-9"></a><span class="cp">#define MAX_NUMBER_FACT 10</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#briefcode-__codelineno-11-10"></a><span class="cp">#define SLEEP_TIME_MS   10*60*1000</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#briefcode-__codelineno-11-11"></a>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#briefcode-__codelineno-11-12"></a><span class="cp">#define SW0_NODE    DT_ALIAS(sw0)</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#briefcode-__codelineno-11-13"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">SW0_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">gpios</span><span class="p">);</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#briefcode-__codelineno-11-14"></a>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#briefcode-__codelineno-11-15"></a><span class="cp">#define LED0_NODE DT_ALIAS(led0)</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#briefcode-__codelineno-11-16"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">led</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">LED0_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">gpios</span><span class="p">);</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#briefcode-__codelineno-11-17"></a>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#briefcode-__codelineno-11-18"></a><span class="cm">/* STEP 5 - Register your code with the logger */</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#briefcode-__codelineno-11-19"></a><span class="n">LOG_MODULE_REGISTER</span><span class="p">(</span><span class="n">Less4_Exer2</span><span class="p">,</span><span class="n">LOG_LEVEL_DBG</span><span class="p">);</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#briefcode-__codelineno-11-20"></a>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#briefcode-__codelineno-11-21"></a><span class="cm">/* STEP 7 - Replace the callback function button_pressed() */</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#briefcode-__codelineno-11-22"></a><span class="kt">void</span><span class="w"> </span><span class="nf">button_pressed</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_callback</span><span class="w"> </span><span class="o">*</span><span class="n">cb</span><span class="p">,</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#briefcode-__codelineno-11-23"></a><span class="w">            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">pins</span><span class="p">)</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#briefcode-__codelineno-11-24"></a><span class="p">{</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#briefcode-__codelineno-11-25"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#briefcode-__codelineno-11-26"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#briefcode-__codelineno-11-27"></a><span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">factorial</span><span class="p">;</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#briefcode-__codelineno-11-28"></a><span class="w">  </span><span class="n">LOG_INF</span><span class="p">(</span><span class="s">&quot;Calculating the factorials of numbers 1 to %d:&quot;</span><span class="p">,</span><span class="n">MAX_NUMBER_FACT</span><span class="p">);</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#briefcode-__codelineno-11-29"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">MAX_NUMBER_FACT</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span><span id="__span-11-30"><a id="__codelineno-11-30" name="__codelineno-11-30" href="#briefcode-__codelineno-11-30"></a><span class="w">       </span><span class="n">factorial</span><span class="w"> </span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-11-31"><a id="__codelineno-11-31" name="__codelineno-11-31" href="#briefcode-__codelineno-11-31"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;=</span><span class="n">i</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">){</span>
</span><span id="__span-11-32"><a id="__codelineno-11-32" name="__codelineno-11-32" href="#briefcode-__codelineno-11-32"></a><span class="w">            </span><span class="n">factorial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factorial</span><span class="o">*</span><span class="n">j</span><span class="p">;</span>
</span><span id="__span-11-33"><a id="__codelineno-11-33" name="__codelineno-11-33" href="#briefcode-__codelineno-11-33"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-11-34"><a id="__codelineno-11-34" name="__codelineno-11-34" href="#briefcode-__codelineno-11-34"></a><span class="w">        </span><span class="n">LOG_INF</span><span class="p">(</span><span class="s">&quot;The factorial of %2d = %ld&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">factorial</span><span class="p">);</span>
</span><span id="__span-11-35"><a id="__codelineno-11-35" name="__codelineno-11-35" href="#briefcode-__codelineno-11-35"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-11-36"><a id="__codelineno-11-36" name="__codelineno-11-36" href="#briefcode-__codelineno-11-36"></a><span class="w">  </span><span class="cm">/*Important note! </span>
</span><span id="__span-11-37"><a id="__codelineno-11-37" name="__codelineno-11-37" href="#briefcode-__codelineno-11-37"></a><span class="cm">  Code in ISR runs at a high priority, therefore, it should be written with timing in mind.</span>
</span><span id="__span-11-38"><a id="__codelineno-11-38" name="__codelineno-11-38" href="#briefcode-__codelineno-11-38"></a><span class="cm">  Too lengthy or too complex tasks should not be performed by an ISR, they should be deferred to a thread </span>
</span><span id="__span-11-39"><a id="__codelineno-11-39" name="__codelineno-11-39" href="#briefcode-__codelineno-11-39"></a><span class="cm">  */</span>
</span><span id="__span-11-40"><a id="__codelineno-11-40" name="__codelineno-11-40" href="#briefcode-__codelineno-11-40"></a><span class="p">}</span>
</span><span id="__span-11-41"><a id="__codelineno-11-41" name="__codelineno-11-41" href="#briefcode-__codelineno-11-41"></a>
</span><span id="__span-11-42"><a id="__codelineno-11-42" name="__codelineno-11-42" href="#briefcode-__codelineno-11-42"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_callback</span><span class="w"> </span><span class="n">button_cb_data</span><span class="p">;</span>
</span><span id="__span-11-43"><a id="__codelineno-11-43" name="__codelineno-11-43" href="#briefcode-__codelineno-11-43"></a>
</span><span id="__span-11-44"><a id="__codelineno-11-44" name="__codelineno-11-44" href="#briefcode-__codelineno-11-44"></a><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-11-45"><a id="__codelineno-11-45" name="__codelineno-11-45" href="#briefcode-__codelineno-11-45"></a><span class="p">{</span>
</span><span id="__span-11-46"><a id="__codelineno-11-46" name="__codelineno-11-46" href="#briefcode-__codelineno-11-46"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-11-47"><a id="__codelineno-11-47" name="__codelineno-11-47" href="#briefcode-__codelineno-11-47"></a><span class="w">    </span><span class="cm">/* STEP 6 - Write some logs */</span>
</span><span id="__span-11-48"><a id="__codelineno-11-48" name="__codelineno-11-48" href="#briefcode-__codelineno-11-48"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">exercise_num</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
</span><span id="__span-11-49"><a id="__codelineno-11-49" name="__codelineno-11-49" href="#briefcode-__codelineno-11-49"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span><span class="p">,</span>
</span><span id="__span-11-50"><a id="__codelineno-11-50" name="__codelineno-11-50" href="#briefcode-__codelineno-11-50"></a><span class="w">                      </span><span class="mh">0x04</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x06</span><span class="p">,</span><span class="w"> </span><span class="mh">0x07</span><span class="p">,</span>
</span><span id="__span-11-51"><a id="__codelineno-11-51" name="__codelineno-11-51" href="#briefcode-__codelineno-11-51"></a><span class="w">                      </span><span class="sc">&#39;H&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="sc">&#39;o&#39;</span><span class="p">};</span>
</span><span id="__span-11-52"><a id="__codelineno-11-52" name="__codelineno-11-52" href="#briefcode-__codelineno-11-52"></a><span class="w">    </span><span class="c1">//Printf-like messages</span>
</span><span id="__span-11-53"><a id="__codelineno-11-53" name="__codelineno-11-53" href="#briefcode-__codelineno-11-53"></a><span class="w">    </span><span class="n">LOG_INF</span><span class="p">(</span><span class="s">&quot;nRF Connect SDK Fundamentals&quot;</span><span class="p">);</span>
</span><span id="__span-11-54"><a id="__codelineno-11-54" name="__codelineno-11-54" href="#briefcode-__codelineno-11-54"></a><span class="w">    </span><span class="n">LOG_INF</span><span class="p">(</span><span class="s">&quot;Exercise %d&quot;</span><span class="p">,</span><span class="n">exercise_num</span><span class="p">);</span><span class="w">    </span>
</span><span id="__span-11-55"><a id="__codelineno-11-55" name="__codelineno-11-55" href="#briefcode-__codelineno-11-55"></a><span class="w">    </span><span class="n">LOG_DBG</span><span class="p">(</span><span class="s">&quot;A log message in debug level&quot;</span><span class="p">);</span>
</span><span id="__span-11-56"><a id="__codelineno-11-56" name="__codelineno-11-56" href="#briefcode-__codelineno-11-56"></a><span class="w">    </span><span class="n">LOG_WRN</span><span class="p">(</span><span class="s">&quot;A log message in warning level!&quot;</span><span class="p">);</span>
</span><span id="__span-11-57"><a id="__codelineno-11-57" name="__codelineno-11-57" href="#briefcode-__codelineno-11-57"></a><span class="w">    </span><span class="n">LOG_ERR</span><span class="p">(</span><span class="s">&quot;A log message in Error level!&quot;</span><span class="p">);</span>
</span><span id="__span-11-58"><a id="__codelineno-11-58" name="__codelineno-11-58" href="#briefcode-__codelineno-11-58"></a><span class="w">    </span><span class="c1">//Hexdump some data</span>
</span><span id="__span-11-59"><a id="__codelineno-11-59" name="__codelineno-11-59" href="#briefcode-__codelineno-11-59"></a><span class="w">    </span><span class="n">LOG_HEXDUMP_INF</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="s">&quot;Sample Data!&quot;</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-11-60"><a id="__codelineno-11-60" name="__codelineno-11-60" href="#briefcode-__codelineno-11-60"></a>
</span><span id="__span-11-61"><a id="__codelineno-11-61" name="__codelineno-11-61" href="#briefcode-__codelineno-11-61"></a><span class="w">    </span><span class="cm">/* Only checking one since led.port and button.port point to the same device, &amp;gpio0 */</span>
</span><span id="__span-11-62"><a id="__codelineno-11-62" name="__codelineno-11-62" href="#briefcode-__codelineno-11-62"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">led</span><span class="p">.</span><span class="n">port</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-63"><a id="__codelineno-11-63" name="__codelineno-11-63" href="#briefcode-__codelineno-11-63"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-11-64"><a id="__codelineno-11-64" name="__codelineno-11-64" href="#briefcode-__codelineno-11-64"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-65"><a id="__codelineno-11-65" name="__codelineno-11-65" href="#briefcode-__codelineno-11-65"></a>
</span><span id="__span-11-66"><a id="__codelineno-11-66" name="__codelineno-11-66" href="#briefcode-__codelineno-11-66"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_OUTPUT_ACTIVE</span><span class="p">);</span>
</span><span id="__span-11-67"><a id="__codelineno-11-67" name="__codelineno-11-67" href="#briefcode-__codelineno-11-67"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-68"><a id="__codelineno-11-68" name="__codelineno-11-68" href="#briefcode-__codelineno-11-68"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-11-69"><a id="__codelineno-11-69" name="__codelineno-11-69" href="#briefcode-__codelineno-11-69"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-70"><a id="__codelineno-11-70" name="__codelineno-11-70" href="#briefcode-__codelineno-11-70"></a>
</span><span id="__span-11-71"><a id="__codelineno-11-71" name="__codelineno-11-71" href="#briefcode-__codelineno-11-71"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">button</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_INPUT</span><span class="p">);</span>
</span><span id="__span-11-72"><a id="__codelineno-11-72" name="__codelineno-11-72" href="#briefcode-__codelineno-11-72"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-73"><a id="__codelineno-11-73" name="__codelineno-11-73" href="#briefcode-__codelineno-11-73"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-11-74"><a id="__codelineno-11-74" name="__codelineno-11-74" href="#briefcode-__codelineno-11-74"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-75"><a id="__codelineno-11-75" name="__codelineno-11-75" href="#briefcode-__codelineno-11-75"></a>
</span><span id="__span-11-76"><a id="__codelineno-11-76" name="__codelineno-11-76" href="#briefcode-__codelineno-11-76"></a><span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_interrupt_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">button</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_INT_EDGE_TO_ACTIVE</span><span class="p">);</span>
</span><span id="__span-11-77"><a id="__codelineno-11-77" name="__codelineno-11-77" href="#briefcode-__codelineno-11-77"></a>
</span><span id="__span-11-78"><a id="__codelineno-11-78" name="__codelineno-11-78" href="#briefcode-__codelineno-11-78"></a><span class="w">    </span><span class="n">gpio_init_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">button_cb_data</span><span class="p">,</span><span class="w"> </span><span class="n">button_pressed</span><span class="p">,</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="n">button</span><span class="p">.</span><span class="n">pin</span><span class="p">));</span><span class="w">   </span>
</span><span id="__span-11-79"><a id="__codelineno-11-79" name="__codelineno-11-79" href="#briefcode-__codelineno-11-79"></a>
</span><span id="__span-11-80"><a id="__codelineno-11-80" name="__codelineno-11-80" href="#briefcode-__codelineno-11-80"></a><span class="w">    </span><span class="n">gpio_add_callback</span><span class="p">(</span><span class="n">button</span><span class="p">.</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">button_cb_data</span><span class="p">);</span><span class="w">    </span>
</span><span id="__span-11-81"><a id="__codelineno-11-81" name="__codelineno-11-81" href="#briefcode-__codelineno-11-81"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-82"><a id="__codelineno-11-82" name="__codelineno-11-82" href="#briefcode-__codelineno-11-82"></a><span class="w">        </span><span class="n">k_msleep</span><span class="p">(</span><span class="n">SLEEP_TIME_MS</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-11-83"><a id="__codelineno-11-83" name="__codelineno-11-83" href="#briefcode-__codelineno-11-83"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-84"><a id="__codelineno-11-84" name="__codelineno-11-84" href="#briefcode-__codelineno-11-84"></a><span class="p">}</span>
</span></code></pre></div>
</details>
<details class="example">
<summary>factorial_logh - (ISR + Logger) hexdump dbg data, Calculate and print factorials after button click</summary>
<div class="language-c highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#briefcode-__codelineno-12-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#briefcode-__codelineno-12-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/device.h&gt;</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#briefcode-__codelineno-12-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/devicetree.h&gt;</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#briefcode-__codelineno-12-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/gpio.h&gt;</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#briefcode-__codelineno-12-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/sys/printk.h&gt;</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#briefcode-__codelineno-12-6"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/logging/log.h&gt;</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#briefcode-__codelineno-12-7"></a>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#briefcode-__codelineno-12-8"></a><span class="cp">#define MAX_NUMBER_FACT 10</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#briefcode-__codelineno-12-9"></a><span class="cp">#define SLEEP_TIME_MS   10*60*1000</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#briefcode-__codelineno-12-10"></a>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#briefcode-__codelineno-12-11"></a><span class="cp">#define SW0_NODE    DT_ALIAS(sw0)</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#briefcode-__codelineno-12-12"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">SW0_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">gpios</span><span class="p">);</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#briefcode-__codelineno-12-13"></a>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#briefcode-__codelineno-12-14"></a><span class="cp">#define LED0_NODE DT_ALIAS(led0)</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#briefcode-__codelineno-12-15"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">led</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">LED0_NODE</span><span class="p">,</span><span class="w"> </span><span class="n">gpios</span><span class="p">);</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#briefcode-__codelineno-12-16"></a>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#briefcode-__codelineno-12-17"></a><span class="n">LOG_MODULE_REGISTER</span><span class="p">(</span><span class="n">Less4_Exer3</span><span class="p">,</span><span class="n">LOG_LEVEL_DBG</span><span class="p">);</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#briefcode-__codelineno-12-18"></a>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19" href="#briefcode-__codelineno-12-19"></a><span class="kt">void</span><span class="w"> </span><span class="nf">button_pressed</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_callback</span><span class="w"> </span><span class="o">*</span><span class="n">cb</span><span class="p">,</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20" href="#briefcode-__codelineno-12-20"></a><span class="w">            </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">pins</span><span class="p">)</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21" href="#briefcode-__codelineno-12-21"></a><span class="p">{</span>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22" href="#briefcode-__codelineno-12-22"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23" href="#briefcode-__codelineno-12-23"></a><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24" href="#briefcode-__codelineno-12-24"></a><span class="w">  </span><span class="kt">long</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">factorial</span><span class="p">;</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25" href="#briefcode-__codelineno-12-25"></a><span class="w">  </span><span class="n">LOG_INF</span><span class="p">(</span><span class="s">&quot;Calculating the factorials of numbers 1 to %d:&quot;</span><span class="p">,</span><span class="n">MAX_NUMBER_FACT</span><span class="p">);</span>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26" href="#briefcode-__codelineno-12-26"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">MAX_NUMBER_FACT</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27" href="#briefcode-__codelineno-12-27"></a><span class="w">       </span><span class="n">factorial</span><span class="w"> </span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28" href="#briefcode-__codelineno-12-28"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">j</span><span class="o">&lt;=</span><span class="n">i</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">){</span>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29" href="#briefcode-__codelineno-12-29"></a><span class="w">            </span><span class="n">factorial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">factorial</span><span class="o">*</span><span class="n">j</span><span class="p">;</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30" href="#briefcode-__codelineno-12-30"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31" href="#briefcode-__codelineno-12-31"></a><span class="w">        </span><span class="n">LOG_INF</span><span class="p">(</span><span class="s">&quot;The factorial of %2d = %ld&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">factorial</span><span class="p">);</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32" href="#briefcode-__codelineno-12-32"></a><span class="w">  </span><span class="p">}</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33" href="#briefcode-__codelineno-12-33"></a><span class="w">  </span><span class="cm">/*Important note! </span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34" href="#briefcode-__codelineno-12-34"></a><span class="cm">  Code in ISR runs at a high priority, therefore, it should be written with timing in mind.</span>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35" href="#briefcode-__codelineno-12-35"></a><span class="cm">  Too lengthy or too complex tasks should not be performed by an ISR, they should be deferred to a thread or a workqueue </span>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36" href="#briefcode-__codelineno-12-36"></a><span class="cm">  */</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37" href="#briefcode-__codelineno-12-37"></a><span class="p">}</span>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38" href="#briefcode-__codelineno-12-38"></a>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39" href="#briefcode-__codelineno-12-39"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_callback</span><span class="w"> </span><span class="n">button_cb_data</span><span class="p">;</span>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40" href="#briefcode-__codelineno-12-40"></a>
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41" href="#briefcode-__codelineno-12-41"></a><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42" href="#briefcode-__codelineno-12-42"></a><span class="p">{</span>
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43" href="#briefcode-__codelineno-12-43"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-12-44"><a id="__codelineno-12-44" name="__codelineno-12-44" href="#briefcode-__codelineno-12-44"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">exercise_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
</span><span id="__span-12-45"><a id="__codelineno-12-45" name="__codelineno-12-45" href="#briefcode-__codelineno-12-45"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">data</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span><span class="p">,</span>
</span><span id="__span-12-46"><a id="__codelineno-12-46" name="__codelineno-12-46" href="#briefcode-__codelineno-12-46"></a><span class="w">                      </span><span class="mh">0x04</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">,</span><span class="w"> </span><span class="mh">0x06</span><span class="p">,</span><span class="w"> </span><span class="mh">0x07</span><span class="p">,</span>
</span><span id="__span-12-47"><a id="__codelineno-12-47" name="__codelineno-12-47" href="#briefcode-__codelineno-12-47"></a><span class="w">                      </span><span class="sc">&#39;H&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;e&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="w"> </span><span class="sc">&#39;l&#39;</span><span class="p">,</span><span class="sc">&#39;o&#39;</span><span class="p">};</span>
</span><span id="__span-12-48"><a id="__codelineno-12-48" name="__codelineno-12-48" href="#briefcode-__codelineno-12-48"></a><span class="w">    </span><span class="c1">//Printf-like messages</span>
</span><span id="__span-12-49"><a id="__codelineno-12-49" name="__codelineno-12-49" href="#briefcode-__codelineno-12-49"></a><span class="w">    </span><span class="n">LOG_INF</span><span class="p">(</span><span class="s">&quot;nRF Connect SDK Fundamentals&quot;</span><span class="p">);</span>
</span><span id="__span-12-50"><a id="__codelineno-12-50" name="__codelineno-12-50" href="#briefcode-__codelineno-12-50"></a><span class="w">    </span><span class="n">LOG_INF</span><span class="p">(</span><span class="s">&quot;Exercise %d&quot;</span><span class="p">,</span><span class="n">exercise_num</span><span class="p">);</span><span class="w">    </span>
</span><span id="__span-12-51"><a id="__codelineno-12-51" name="__codelineno-12-51" href="#briefcode-__codelineno-12-51"></a><span class="w">    </span><span class="n">LOG_DBG</span><span class="p">(</span><span class="s">&quot;A log message in debug level&quot;</span><span class="p">);</span>
</span><span id="__span-12-52"><a id="__codelineno-12-52" name="__codelineno-12-52" href="#briefcode-__codelineno-12-52"></a><span class="w">    </span><span class="n">LOG_WRN</span><span class="p">(</span><span class="s">&quot;A log message in warning level!&quot;</span><span class="p">);</span>
</span><span id="__span-12-53"><a id="__codelineno-12-53" name="__codelineno-12-53" href="#briefcode-__codelineno-12-53"></a><span class="w">    </span><span class="n">LOG_ERR</span><span class="p">(</span><span class="s">&quot;A log message in error level!&quot;</span><span class="p">);</span>
</span><span id="__span-12-54"><a id="__codelineno-12-54" name="__codelineno-12-54" href="#briefcode-__codelineno-12-54"></a><span class="w">    </span><span class="c1">//Hexdump some data</span>
</span><span id="__span-12-55"><a id="__codelineno-12-55" name="__codelineno-12-55" href="#briefcode-__codelineno-12-55"></a><span class="w">    </span><span class="n">LOG_HEXDUMP_INF</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="s">&quot;Sample Data!&quot;</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-12-56"><a id="__codelineno-12-56" name="__codelineno-12-56" href="#briefcode-__codelineno-12-56"></a>
</span><span id="__span-12-57"><a id="__codelineno-12-57" name="__codelineno-12-57" href="#briefcode-__codelineno-12-57"></a><span class="w">    </span><span class="cm">/* Only checking one since led.port and button.port point to the same device, &amp;gpio0 */</span>
</span><span id="__span-12-58"><a id="__codelineno-12-58" name="__codelineno-12-58" href="#briefcode-__codelineno-12-58"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">led</span><span class="p">.</span><span class="n">port</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-59"><a id="__codelineno-12-59" name="__codelineno-12-59" href="#briefcode-__codelineno-12-59"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-12-60"><a id="__codelineno-12-60" name="__codelineno-12-60" href="#briefcode-__codelineno-12-60"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-61"><a id="__codelineno-12-61" name="__codelineno-12-61" href="#briefcode-__codelineno-12-61"></a>
</span><span id="__span-12-62"><a id="__codelineno-12-62" name="__codelineno-12-62" href="#briefcode-__codelineno-12-62"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_OUTPUT_ACTIVE</span><span class="p">);</span>
</span><span id="__span-12-63"><a id="__codelineno-12-63" name="__codelineno-12-63" href="#briefcode-__codelineno-12-63"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-64"><a id="__codelineno-12-64" name="__codelineno-12-64" href="#briefcode-__codelineno-12-64"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-12-65"><a id="__codelineno-12-65" name="__codelineno-12-65" href="#briefcode-__codelineno-12-65"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-66"><a id="__codelineno-12-66" name="__codelineno-12-66" href="#briefcode-__codelineno-12-66"></a>
</span><span id="__span-12-67"><a id="__codelineno-12-67" name="__codelineno-12-67" href="#briefcode-__codelineno-12-67"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">button</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_INPUT</span><span class="p">);</span>
</span><span id="__span-12-68"><a id="__codelineno-12-68" name="__codelineno-12-68" href="#briefcode-__codelineno-12-68"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-69"><a id="__codelineno-12-69" name="__codelineno-12-69" href="#briefcode-__codelineno-12-69"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-70"><a id="__codelineno-12-70" name="__codelineno-12-70" href="#briefcode-__codelineno-12-70"></a>
</span><span id="__span-12-71"><a id="__codelineno-12-71" name="__codelineno-12-71" href="#briefcode-__codelineno-12-71"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_interrupt_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">button</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_INT_EDGE_TO_ACTIVE</span><span class="p">);</span>
</span><span id="__span-12-72"><a id="__codelineno-12-72" name="__codelineno-12-72" href="#briefcode-__codelineno-12-72"></a>
</span><span id="__span-12-73"><a id="__codelineno-12-73" name="__codelineno-12-73" href="#briefcode-__codelineno-12-73"></a><span class="w">    </span><span class="n">gpio_init_callback</span><span class="p">(</span><span class="o">&amp;</span><span class="n">button_cb_data</span><span class="p">,</span><span class="w"> </span><span class="n">button_pressed</span><span class="p">,</span><span class="w"> </span><span class="n">BIT</span><span class="p">(</span><span class="n">button</span><span class="p">.</span><span class="n">pin</span><span class="p">));</span><span class="w">   </span>
</span><span id="__span-12-74"><a id="__codelineno-12-74" name="__codelineno-12-74" href="#briefcode-__codelineno-12-74"></a>
</span><span id="__span-12-75"><a id="__codelineno-12-75" name="__codelineno-12-75" href="#briefcode-__codelineno-12-75"></a><span class="w">    </span><span class="n">gpio_add_callback</span><span class="p">(</span><span class="n">button</span><span class="p">.</span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">button_cb_data</span><span class="p">);</span>
</span><span id="__span-12-76"><a id="__codelineno-12-76" name="__codelineno-12-76" href="#briefcode-__codelineno-12-76"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-77"><a id="__codelineno-12-77" name="__codelineno-12-77" href="#briefcode-__codelineno-12-77"></a><span class="w">        </span><span class="n">k_msleep</span><span class="p">(</span><span class="n">SLEEP_TIME_MS</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-12-78"><a id="__codelineno-12-78" name="__codelineno-12-78" href="#briefcode-__codelineno-12-78"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-79"><a id="__codelineno-12-79" name="__codelineno-12-79" href="#briefcode-__codelineno-12-79"></a><span class="p">}</span>
</span></code></pre></div>
</details>
<details class="example">
<summary>key_ctrl - Controlling LEDs through UART. Press 1-3 on your keyboard (Enable the serial driver in asynchronous mode)</summary>
<div class="language-c highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#briefcode-__codelineno-13-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#briefcode-__codelineno-13-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/device.h&gt;</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#briefcode-__codelineno-13-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/devicetree.h&gt;</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#briefcode-__codelineno-13-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/gpio.h&gt;</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#briefcode-__codelineno-13-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/sys/printk.h&gt;</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#briefcode-__codelineno-13-6"></a><span class="cm">/* STEP 3 - Include the header file of the UART driver in main.c */</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#briefcode-__codelineno-13-7"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/uart.h&gt;</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#briefcode-__codelineno-13-8"></a>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#briefcode-__codelineno-13-9"></a><span class="cm">/* 1000 msec = 1 sec */</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#briefcode-__codelineno-13-10"></a><span class="cp">#define SLEEP_TIME_MS   1000</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#briefcode-__codelineno-13-11"></a>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#briefcode-__codelineno-13-12"></a><span class="cm">/* STEP 10.1.1 - Define the size of the receive buffer */</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#briefcode-__codelineno-13-13"></a><span class="cp">#define RECEIVE_BUFF_SIZE 10</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#briefcode-__codelineno-13-14"></a>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#briefcode-__codelineno-13-15"></a><span class="cm">/* STEP 10.2 - Define the receiving timeout period */</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#briefcode-__codelineno-13-16"></a><span class="cp">#define RECEIVE_TIMEOUT 100</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#briefcode-__codelineno-13-17"></a>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#briefcode-__codelineno-13-18"></a><span class="cm">/* STEP 5.1 - Get the device pointers of the LEDs through gpio_dt_spec */</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#briefcode-__codelineno-13-19"></a><span class="cm">/* The nRF7002dk has only 2 LEDs so this step uses a compile-time condition to reflect the DK you are building for */</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#briefcode-__codelineno-13-20"></a><span class="cp">#if defined (CONFIG_BOARD_NRF7002DK_NRF5340_CPUAPP)|| defined (CONFIG_BOARD_NRF7002DK_NRF5340_CPUAPP_NS)</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#briefcode-__codelineno-13-21"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">led0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">DT_ALIAS</span><span class="p">(</span><span class="n">led0</span><span class="p">),</span><span class="w"> </span><span class="n">gpios</span><span class="p">);</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#briefcode-__codelineno-13-22"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">led1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">DT_ALIAS</span><span class="p">(</span><span class="n">led1</span><span class="p">),</span><span class="w"> </span><span class="n">gpios</span><span class="p">);</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#briefcode-__codelineno-13-23"></a><span class="cp">#else</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#briefcode-__codelineno-13-24"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">led0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">DT_ALIAS</span><span class="p">(</span><span class="n">led0</span><span class="p">),</span><span class="w"> </span><span class="n">gpios</span><span class="p">);</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#briefcode-__codelineno-13-25"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">led1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">DT_ALIAS</span><span class="p">(</span><span class="n">led1</span><span class="p">),</span><span class="w"> </span><span class="n">gpios</span><span class="p">);</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#briefcode-__codelineno-13-26"></a><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">gpio_dt_spec</span><span class="w"> </span><span class="n">led2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GPIO_DT_SPEC_GET</span><span class="p">(</span><span class="n">DT_ALIAS</span><span class="p">(</span><span class="n">led2</span><span class="p">),</span><span class="w"> </span><span class="n">gpios</span><span class="p">);</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#briefcode-__codelineno-13-27"></a><span class="cp">#endif</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#briefcode-__codelineno-13-28"></a>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#briefcode-__codelineno-13-29"></a><span class="cm">/* STEP 4.1 - Get the device pointer of the UART hardware */</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#briefcode-__codelineno-13-30"></a><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">uart</span><span class="o">=</span><span class="w"> </span><span class="n">DEVICE_DT_GET</span><span class="p">(</span><span class="n">DT_NODELABEL</span><span class="p">(</span><span class="n">uart0</span><span class="p">));</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#briefcode-__codelineno-13-31"></a>
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="#briefcode-__codelineno-13-32"></a>
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="#briefcode-__codelineno-13-33"></a><span class="cm">/* STEP 9.1 - Define the transmission buffer, which is a buffer to hold the data to be sent over UART */</span>
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="#briefcode-__codelineno-13-34"></a><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">tx_buf</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w">   </span><span class="p">{</span><span class="s">&quot;nRF Connect SDK Fundamentals Course</span><span class="se">\n\r</span><span class="s">&quot;</span>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="#briefcode-__codelineno-13-35"></a><span class="w">                             </span><span class="s">&quot;Press 1-3 on your keyboard to toggle LEDS 1-3 on your development kit</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">};</span>
</span><span id="__span-13-36"><a id="__codelineno-13-36" name="__codelineno-13-36" href="#briefcode-__codelineno-13-36"></a>
</span><span id="__span-13-37"><a id="__codelineno-13-37" name="__codelineno-13-37" href="#briefcode-__codelineno-13-37"></a><span class="cm">/* STEP 10.1.2 - Define the receive buffer */</span>
</span><span id="__span-13-38"><a id="__codelineno-13-38" name="__codelineno-13-38" href="#briefcode-__codelineno-13-38"></a><span class="k">static</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">rx_buf</span><span class="p">[</span><span class="n">RECEIVE_BUFF_SIZE</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span><span id="__span-13-39"><a id="__codelineno-13-39" name="__codelineno-13-39" href="#briefcode-__codelineno-13-39"></a>
</span><span id="__span-13-40"><a id="__codelineno-13-40" name="__codelineno-13-40" href="#briefcode-__codelineno-13-40"></a><span class="cm">/* STEP 7 - Define the callback function for UART */</span>
</span><span id="__span-13-41"><a id="__codelineno-13-41" name="__codelineno-13-41" href="#briefcode-__codelineno-13-41"></a><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">uart_cb</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">device</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">uart_event</span><span class="w"> </span><span class="o">*</span><span class="n">evt</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_data</span><span class="p">)</span>
</span><span id="__span-13-42"><a id="__codelineno-13-42" name="__codelineno-13-42" href="#briefcode-__codelineno-13-42"></a><span class="p">{</span>
</span><span id="__span-13-43"><a id="__codelineno-13-43" name="__codelineno-13-43" href="#briefcode-__codelineno-13-43"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-44"><a id="__codelineno-13-44" name="__codelineno-13-44" href="#briefcode-__codelineno-13-44"></a>
</span><span id="__span-13-45"><a id="__codelineno-13-45" name="__codelineno-13-45" href="#briefcode-__codelineno-13-45"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">UART_RX_RDY</span><span class="p">:</span>
</span><span id="__span-13-46"><a id="__codelineno-13-46" name="__codelineno-13-46" href="#briefcode-__codelineno-13-46"></a><span class="w">    </span><span class="cp">#if defined (CONFIG_BOARD_NRF7002DK_NRF5340_CPUAPP)|| defined (CONFIG_BOARD_NRF7002DK_NRF5340_CPUAPP_NS)</span>
</span><span id="__span-13-47"><a id="__codelineno-13-47" name="__codelineno-13-47" href="#briefcode-__codelineno-13-47"></a><span class="w">        </span><span class="k">if</span><span class="p">((</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span>
</span><span id="__span-13-48"><a id="__codelineno-13-48" name="__codelineno-13-48" href="#briefcode-__codelineno-13-48"></a>
</span><span id="__span-13-49"><a id="__codelineno-13-49" name="__codelineno-13-49" href="#briefcode-__codelineno-13-49"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">offset</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;1&#39;</span><span class="p">)</span>
</span><span id="__span-13-50"><a id="__codelineno-13-50" name="__codelineno-13-50" href="#briefcode-__codelineno-13-50"></a><span class="w">            </span><span class="n">gpio_pin_toggle_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led0</span><span class="p">);</span>
</span><span id="__span-13-51"><a id="__codelineno-13-51" name="__codelineno-13-51" href="#briefcode-__codelineno-13-51"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">offset</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;2&#39;</span><span class="p">)</span>
</span><span id="__span-13-52"><a id="__codelineno-13-52" name="__codelineno-13-52" href="#briefcode-__codelineno-13-52"></a><span class="w">            </span><span class="n">gpio_pin_toggle_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led1</span><span class="p">);</span><span class="w">  </span>
</span><span id="__span-13-53"><a id="__codelineno-13-53" name="__codelineno-13-53" href="#briefcode-__codelineno-13-53"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-13-54"><a id="__codelineno-13-54" name="__codelineno-13-54" href="#briefcode-__codelineno-13-54"></a><span class="w">    </span><span class="cp">#else</span>
</span><span id="__span-13-55"><a id="__codelineno-13-55" name="__codelineno-13-55" href="#briefcode-__codelineno-13-55"></a><span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">){</span>
</span><span id="__span-13-56"><a id="__codelineno-13-56" name="__codelineno-13-56" href="#briefcode-__codelineno-13-56"></a>
</span><span id="__span-13-57"><a id="__codelineno-13-57" name="__codelineno-13-57" href="#briefcode-__codelineno-13-57"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">offset</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;1&#39;</span><span class="p">)</span>
</span><span id="__span-13-58"><a id="__codelineno-13-58" name="__codelineno-13-58" href="#briefcode-__codelineno-13-58"></a><span class="w">            </span><span class="n">gpio_pin_toggle_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led0</span><span class="p">);</span>
</span><span id="__span-13-59"><a id="__codelineno-13-59" name="__codelineno-13-59" href="#briefcode-__codelineno-13-59"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">offset</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;2&#39;</span><span class="p">)</span>
</span><span id="__span-13-60"><a id="__codelineno-13-60" name="__codelineno-13-60" href="#briefcode-__codelineno-13-60"></a><span class="w">            </span><span class="n">gpio_pin_toggle_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led1</span><span class="p">);</span>
</span><span id="__span-13-61"><a id="__codelineno-13-61" name="__codelineno-13-61" href="#briefcode-__codelineno-13-61"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">[</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">offset</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;3&#39;</span><span class="p">)</span>
</span><span id="__span-13-62"><a id="__codelineno-13-62" name="__codelineno-13-62" href="#briefcode-__codelineno-13-62"></a><span class="w">            </span><span class="n">gpio_pin_toggle_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led2</span><span class="p">);</span><span class="w">                  </span>
</span><span id="__span-13-63"><a id="__codelineno-13-63" name="__codelineno-13-63" href="#briefcode-__codelineno-13-63"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-13-64"><a id="__codelineno-13-64" name="__codelineno-13-64" href="#briefcode-__codelineno-13-64"></a><span class="cp">#endif</span>
</span><span id="__span-13-65"><a id="__codelineno-13-65" name="__codelineno-13-65" href="#briefcode-__codelineno-13-65"></a><span class="w">    </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-13-66"><a id="__codelineno-13-66" name="__codelineno-13-66" href="#briefcode-__codelineno-13-66"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">UART_RX_DISABLED</span><span class="p">:</span>
</span><span id="__span-13-67"><a id="__codelineno-13-67" name="__codelineno-13-67" href="#briefcode-__codelineno-13-67"></a><span class="w">        </span><span class="n">uart_rx_enable</span><span class="p">(</span><span class="n">dev</span><span class="w"> </span><span class="p">,</span><span class="n">rx_buf</span><span class="p">,</span><span class="k">sizeof</span><span class="w"> </span><span class="n">rx_buf</span><span class="p">,</span><span class="n">RECEIVE_TIMEOUT</span><span class="p">);</span>
</span><span id="__span-13-68"><a id="__codelineno-13-68" name="__codelineno-13-68" href="#briefcode-__codelineno-13-68"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-13-69"><a id="__codelineno-13-69" name="__codelineno-13-69" href="#briefcode-__codelineno-13-69"></a>
</span><span id="__span-13-70"><a id="__codelineno-13-70" name="__codelineno-13-70" href="#briefcode-__codelineno-13-70"></a><span class="w">    </span><span class="k">default</span><span class="o">:</span>
</span><span id="__span-13-71"><a id="__codelineno-13-71" name="__codelineno-13-71" href="#briefcode-__codelineno-13-71"></a><span class="w">        </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-13-72"><a id="__codelineno-13-72" name="__codelineno-13-72" href="#briefcode-__codelineno-13-72"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-73"><a id="__codelineno-13-73" name="__codelineno-13-73" href="#briefcode-__codelineno-13-73"></a><span class="p">}</span>
</span><span id="__span-13-74"><a id="__codelineno-13-74" name="__codelineno-13-74" href="#briefcode-__codelineno-13-74"></a>
</span><span id="__span-13-75"><a id="__codelineno-13-75" name="__codelineno-13-75" href="#briefcode-__codelineno-13-75"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-13-76"><a id="__codelineno-13-76" name="__codelineno-13-76" href="#briefcode-__codelineno-13-76"></a><span class="p">{</span>
</span><span id="__span-13-77"><a id="__codelineno-13-77" name="__codelineno-13-77" href="#briefcode-__codelineno-13-77"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-13-78"><a id="__codelineno-13-78" name="__codelineno-13-78" href="#briefcode-__codelineno-13-78"></a>
</span><span id="__span-13-79"><a id="__codelineno-13-79" name="__codelineno-13-79" href="#briefcode-__codelineno-13-79"></a><span class="cm">/* STEP 4.2 - Verify that the UART device is ready */</span><span class="w"> </span>
</span><span id="__span-13-80"><a id="__codelineno-13-80" name="__codelineno-13-80" href="#briefcode-__codelineno-13-80"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">uart</span><span class="p">)){</span>
</span><span id="__span-13-81"><a id="__codelineno-13-81" name="__codelineno-13-81" href="#briefcode-__codelineno-13-81"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;UART device not ready</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-13-82"><a id="__codelineno-13-82" name="__codelineno-13-82" href="#briefcode-__codelineno-13-82"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-13-83"><a id="__codelineno-13-83" name="__codelineno-13-83" href="#briefcode-__codelineno-13-83"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-84"><a id="__codelineno-13-84" name="__codelineno-13-84" href="#briefcode-__codelineno-13-84"></a><span class="cm">/* STEP 5.2 - Verify that the LED devices are ready */</span>
</span><span id="__span-13-85"><a id="__codelineno-13-85" name="__codelineno-13-85" href="#briefcode-__codelineno-13-85"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">led0</span><span class="p">.</span><span class="n">port</span><span class="p">)){</span>
</span><span id="__span-13-86"><a id="__codelineno-13-86" name="__codelineno-13-86" href="#briefcode-__codelineno-13-86"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;GPIO device is not ready</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-13-87"><a id="__codelineno-13-87" name="__codelineno-13-87" href="#briefcode-__codelineno-13-87"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-13-88"><a id="__codelineno-13-88" name="__codelineno-13-88" href="#briefcode-__codelineno-13-88"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-89"><a id="__codelineno-13-89" name="__codelineno-13-89" href="#briefcode-__codelineno-13-89"></a><span class="cm">/* STEP 6 - Configure the GPIOs of the LEDs */</span>
</span><span id="__span-13-90"><a id="__codelineno-13-90" name="__codelineno-13-90" href="#briefcode-__codelineno-13-90"></a><span class="cp">#if defined (CONFIG_BOARD_NRF7002DK_NRF5340_CPUAPP)|| defined (CONFIG_BOARD_NRF7002DK_NRF5340_CPUAPP_NS)</span>
</span><span id="__span-13-91"><a id="__codelineno-13-91" name="__codelineno-13-91" href="#briefcode-__codelineno-13-91"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led0</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_OUTPUT_ACTIVE</span><span class="p">);</span>
</span><span id="__span-13-92"><a id="__codelineno-13-92" name="__codelineno-13-92" href="#briefcode-__codelineno-13-92"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-93"><a id="__codelineno-13-93" name="__codelineno-13-93" href="#briefcode-__codelineno-13-93"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-13-94"><a id="__codelineno-13-94" name="__codelineno-13-94" href="#briefcode-__codelineno-13-94"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-95"><a id="__codelineno-13-95" name="__codelineno-13-95" href="#briefcode-__codelineno-13-95"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led1</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_OUTPUT_ACTIVE</span><span class="p">);</span>
</span><span id="__span-13-96"><a id="__codelineno-13-96" name="__codelineno-13-96" href="#briefcode-__codelineno-13-96"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-97"><a id="__codelineno-13-97" name="__codelineno-13-97" href="#briefcode-__codelineno-13-97"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-13-98"><a id="__codelineno-13-98" name="__codelineno-13-98" href="#briefcode-__codelineno-13-98"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-99"><a id="__codelineno-13-99" name="__codelineno-13-99" href="#briefcode-__codelineno-13-99"></a><span class="cp">#else</span>
</span><span id="__span-13-100"><a id="__codelineno-13-100" name="__codelineno-13-100" href="#briefcode-__codelineno-13-100"></a><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led0</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_OUTPUT_ACTIVE</span><span class="p">);</span>
</span><span id="__span-13-101"><a id="__codelineno-13-101" name="__codelineno-13-101" href="#briefcode-__codelineno-13-101"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-102"><a id="__codelineno-13-102" name="__codelineno-13-102" href="#briefcode-__codelineno-13-102"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-13-103"><a id="__codelineno-13-103" name="__codelineno-13-103" href="#briefcode-__codelineno-13-103"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-104"><a id="__codelineno-13-104" name="__codelineno-13-104" href="#briefcode-__codelineno-13-104"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led1</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_OUTPUT_ACTIVE</span><span class="p">);</span>
</span><span id="__span-13-105"><a id="__codelineno-13-105" name="__codelineno-13-105" href="#briefcode-__codelineno-13-105"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-106"><a id="__codelineno-13-106" name="__codelineno-13-106" href="#briefcode-__codelineno-13-106"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-13-107"><a id="__codelineno-13-107" name="__codelineno-13-107" href="#briefcode-__codelineno-13-107"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-108"><a id="__codelineno-13-108" name="__codelineno-13-108" href="#briefcode-__codelineno-13-108"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gpio_pin_configure_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led2</span><span class="p">,</span><span class="w"> </span><span class="n">GPIO_OUTPUT_ACTIVE</span><span class="p">);</span>
</span><span id="__span-13-109"><a id="__codelineno-13-109" name="__codelineno-13-109" href="#briefcode-__codelineno-13-109"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-110"><a id="__codelineno-13-110" name="__codelineno-13-110" href="#briefcode-__codelineno-13-110"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">;</span>
</span><span id="__span-13-111"><a id="__codelineno-13-111" name="__codelineno-13-111" href="#briefcode-__codelineno-13-111"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-112"><a id="__codelineno-13-112" name="__codelineno-13-112" href="#briefcode-__codelineno-13-112"></a><span class="cp">#endif</span>
</span><span id="__span-13-113"><a id="__codelineno-13-113" name="__codelineno-13-113" href="#briefcode-__codelineno-13-113"></a>
</span><span id="__span-13-114"><a id="__codelineno-13-114" name="__codelineno-13-114" href="#briefcode-__codelineno-13-114"></a><span class="cm">/* STEP 8 - Register the UART callback function */</span>
</span><span id="__span-13-115"><a id="__codelineno-13-115" name="__codelineno-13-115" href="#briefcode-__codelineno-13-115"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uart_callback_set</span><span class="p">(</span><span class="n">uart</span><span class="p">,</span><span class="w"> </span><span class="n">uart_cb</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span><span id="__span-13-116"><a id="__codelineno-13-116" name="__codelineno-13-116" href="#briefcode-__codelineno-13-116"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-117"><a id="__codelineno-13-117" name="__codelineno-13-117" href="#briefcode-__codelineno-13-117"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-13-118"><a id="__codelineno-13-118" name="__codelineno-13-118" href="#briefcode-__codelineno-13-118"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-13-119"><a id="__codelineno-13-119" name="__codelineno-13-119" href="#briefcode-__codelineno-13-119"></a><span class="cm">/* STEP 9.2 - Send the data over UART by calling uart_tx() */</span>
</span><span id="__span-13-120"><a id="__codelineno-13-120" name="__codelineno-13-120" href="#briefcode-__codelineno-13-120"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uart_tx</span><span class="p">(</span><span class="n">uart</span><span class="p">,</span><span class="w"> </span><span class="n">tx_buf</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">tx_buf</span><span class="p">),</span><span class="w"> </span><span class="n">SYS_FOREVER_MS</span><span class="p">);</span>
</span><span id="__span-13-121"><a id="__codelineno-13-121" name="__codelineno-13-121" href="#briefcode-__codelineno-13-121"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-122"><a id="__codelineno-13-122" name="__codelineno-13-122" href="#briefcode-__codelineno-13-122"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-13-123"><a id="__codelineno-13-123" name="__codelineno-13-123" href="#briefcode-__codelineno-13-123"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-124"><a id="__codelineno-13-124" name="__codelineno-13-124" href="#briefcode-__codelineno-13-124"></a><span class="cm">/* STEP 10.3  - Start receiving by calling uart_rx_enable() and pass it the address of the receive  buffer */</span>
</span><span id="__span-13-125"><a id="__codelineno-13-125" name="__codelineno-13-125" href="#briefcode-__codelineno-13-125"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">uart_rx_enable</span><span class="p">(</span><span class="n">uart</span><span class="w"> </span><span class="p">,</span><span class="n">rx_buf</span><span class="p">,</span><span class="k">sizeof</span><span class="w"> </span><span class="n">rx_buf</span><span class="p">,</span><span class="n">RECEIVE_TIMEOUT</span><span class="p">);</span>
</span><span id="__span-13-126"><a id="__codelineno-13-126" name="__codelineno-13-126" href="#briefcode-__codelineno-13-126"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-127"><a id="__codelineno-13-127" name="__codelineno-13-127" href="#briefcode-__codelineno-13-127"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-13-128"><a id="__codelineno-13-128" name="__codelineno-13-128" href="#briefcode-__codelineno-13-128"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-129"><a id="__codelineno-13-129" name="__codelineno-13-129" href="#briefcode-__codelineno-13-129"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-130"><a id="__codelineno-13-130" name="__codelineno-13-130" href="#briefcode-__codelineno-13-130"></a><span class="w">        </span><span class="n">k_msleep</span><span class="p">(</span><span class="n">SLEEP_TIME_MS</span><span class="p">);</span>
</span><span id="__span-13-131"><a id="__codelineno-13-131" name="__codelineno-13-131" href="#briefcode-__codelineno-13-131"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-132"><a id="__codelineno-13-132" name="__codelineno-13-132" href="#briefcode-__codelineno-13-132"></a>
</span><span id="__span-13-133"><a id="__codelineno-13-133" name="__codelineno-13-133" href="#briefcode-__codelineno-13-133"></a><span class="p">}</span>
</span></code></pre></div>
</details>
<details class="example">
<summary>sen_i2c - get data from i2c temp sensor SSTS751 (Enable CONFIG_I2C &amp; CONFIG_CBPRINTF_FP_SUPPORT)</summary>
<div class="language-c highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#briefcode-__codelineno-14-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#briefcode-__codelineno-14-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/device.h&gt;</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#briefcode-__codelineno-14-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/devicetree.h&gt;</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#briefcode-__codelineno-14-4"></a><span class="cm">/* STEP 3 - Include the header file of the I2C API */</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#briefcode-__codelineno-14-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/i2c.h&gt;</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#briefcode-__codelineno-14-6"></a><span class="cm">/* STEP 4.1 - Include the header file of printk() */</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#briefcode-__codelineno-14-7"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/sys/printk.h&gt;</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#briefcode-__codelineno-14-8"></a><span class="cm">/* 1000 msec = 1 sec */</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#briefcode-__codelineno-14-9"></a><span class="cp">#define SLEEP_TIME_MS   1000</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#briefcode-__codelineno-14-10"></a>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#briefcode-__codelineno-14-11"></a><span class="cm">/* STEP 8 - Define the I2C slave device address and the addresses of relevant registers */</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#briefcode-__codelineno-14-12"></a><span class="cp">#define STTS751_TEMP_HIGH_REG            0x00</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#briefcode-__codelineno-14-13"></a><span class="cp">#define STTS751_TEMP_LOW_REG             0x02</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#briefcode-__codelineno-14-14"></a><span class="cp">#define STTS751_CONFIG_REG               0x03</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#briefcode-__codelineno-14-15"></a>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16" href="#briefcode-__codelineno-14-16"></a><span class="cm">/* STEP 6 - Get the node identifier of the sensor */</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17" href="#briefcode-__codelineno-14-17"></a><span class="cp">#define I2C_NODE DT_NODELABEL(mysensor)</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18" href="#briefcode-__codelineno-14-18"></a>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19" href="#briefcode-__codelineno-14-19"></a><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20" href="#briefcode-__codelineno-14-20"></a><span class="p">{</span>
</span><span id="__span-14-21"><a id="__codelineno-14-21" name="__codelineno-14-21" href="#briefcode-__codelineno-14-21"></a>
</span><span id="__span-14-22"><a id="__codelineno-14-22" name="__codelineno-14-22" href="#briefcode-__codelineno-14-22"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-14-23"><a id="__codelineno-14-23" name="__codelineno-14-23" href="#briefcode-__codelineno-14-23"></a>
</span><span id="__span-14-24"><a id="__codelineno-14-24" name="__codelineno-14-24" href="#briefcode-__codelineno-14-24"></a><span class="cm">/* STEP 7 - Retrieve the API-specific device structure and make sure that the device is ready to use  */</span>
</span><span id="__span-14-25"><a id="__codelineno-14-25" name="__codelineno-14-25" href="#briefcode-__codelineno-14-25"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_dt_spec</span><span class="w"> </span><span class="n">dev_i2c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I2C_DT_SPEC_GET</span><span class="p">(</span><span class="n">I2C_NODE</span><span class="p">);</span>
</span><span id="__span-14-26"><a id="__codelineno-14-26" name="__codelineno-14-26" href="#briefcode-__codelineno-14-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">dev_i2c</span><span class="p">.</span><span class="n">bus</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-27"><a id="__codelineno-14-27" name="__codelineno-14-27" href="#briefcode-__codelineno-14-27"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;I2C bus %s is not ready!</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev_i2c</span><span class="p">.</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span><span id="__span-14-28"><a id="__codelineno-14-28" name="__codelineno-14-28" href="#briefcode-__codelineno-14-28"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-14-29"><a id="__codelineno-14-29" name="__codelineno-14-29" href="#briefcode-__codelineno-14-29"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-14-30"><a id="__codelineno-14-30" name="__codelineno-14-30" href="#briefcode-__codelineno-14-30"></a>
</span><span id="__span-14-31"><a id="__codelineno-14-31" name="__codelineno-14-31" href="#briefcode-__codelineno-14-31"></a><span class="cm">/* STEP 9 - Setup the sensor by writing the value 0x8C to the Configuration register */</span>
</span><span id="__span-14-32"><a id="__codelineno-14-32" name="__codelineno-14-32" href="#briefcode-__codelineno-14-32"></a><span class="w">    </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">config</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">STTS751_CONFIG_REG</span><span class="p">,</span><span class="mh">0x8C</span><span class="p">};</span>
</span><span id="__span-14-33"><a id="__codelineno-14-33" name="__codelineno-14-33" href="#briefcode-__codelineno-14-33"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_write_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_i2c</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">config</span><span class="p">));</span>
</span><span id="__span-14-34"><a id="__codelineno-14-34" name="__codelineno-14-34" href="#briefcode-__codelineno-14-34"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
</span><span id="__span-14-35"><a id="__codelineno-14-35" name="__codelineno-14-35" href="#briefcode-__codelineno-14-35"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Failed to write to I2C device address %x at Reg. %x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dev_i2c</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span id="__span-14-36"><a id="__codelineno-14-36" name="__codelineno-14-36" href="#briefcode-__codelineno-14-36"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-14-37"><a id="__codelineno-14-37" name="__codelineno-14-37" href="#briefcode-__codelineno-14-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-14-38"><a id="__codelineno-14-38" name="__codelineno-14-38" href="#briefcode-__codelineno-14-38"></a>
</span><span id="__span-14-39"><a id="__codelineno-14-39" name="__codelineno-14-39" href="#briefcode-__codelineno-14-39"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-40"><a id="__codelineno-14-40" name="__codelineno-14-40" href="#briefcode-__codelineno-14-40"></a><span class="cm">/* STEP 10 - Read the temperature from the sensor */</span>
</span><span id="__span-14-41"><a id="__codelineno-14-41" name="__codelineno-14-41" href="#briefcode-__codelineno-14-41"></a><span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">temp_reading</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span><span id="__span-14-42"><a id="__codelineno-14-42" name="__codelineno-14-42" href="#briefcode-__codelineno-14-42"></a><span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">sensor_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="p">{</span><span class="n">STTS751_TEMP_LOW_REG</span><span class="p">,</span><span class="n">STTS751_TEMP_HIGH_REG</span><span class="p">};</span>
</span><span id="__span-14-43"><a id="__codelineno-14-43" name="__codelineno-14-43" href="#briefcode-__codelineno-14-43"></a><span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_write_read_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_i2c</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sensor_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">temp_reading</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-14-44"><a id="__codelineno-14-44" name="__codelineno-14-44" href="#briefcode-__codelineno-14-44"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
</span><span id="__span-14-45"><a id="__codelineno-14-45" name="__codelineno-14-45" href="#briefcode-__codelineno-14-45"></a><span class="w">            </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Failed to write/read I2C device address %x at Reg. %x </span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dev_i2c</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span><span class="n">sensor_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span id="__span-14-46"><a id="__codelineno-14-46" name="__codelineno-14-46" href="#briefcode-__codelineno-14-46"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-14-47"><a id="__codelineno-14-47" name="__codelineno-14-47" href="#briefcode-__codelineno-14-47"></a><span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_write_read_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_i2c</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sensor_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="o">&amp;</span><span class="n">temp_reading</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-14-48"><a id="__codelineno-14-48" name="__codelineno-14-48" href="#briefcode-__codelineno-14-48"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
</span><span id="__span-14-49"><a id="__codelineno-14-49" name="__codelineno-14-49" href="#briefcode-__codelineno-14-49"></a><span class="w">            </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Failed to write/read I2C device address %x at Reg. %x </span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dev_i2c</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span><span class="n">sensor_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span id="__span-14-50"><a id="__codelineno-14-50" name="__codelineno-14-50" href="#briefcode-__codelineno-14-50"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-14-51"><a id="__codelineno-14-51" name="__codelineno-14-51" href="#briefcode-__codelineno-14-51"></a>
</span><span id="__span-14-52"><a id="__codelineno-14-52" name="__codelineno-14-52" href="#briefcode-__codelineno-14-52"></a><span class="cm">/* STEP 11 - Convert the two bytes to a 12-bits */</span>
</span><span id="__span-14-53"><a id="__codelineno-14-53" name="__codelineno-14-53" href="#briefcode-__codelineno-14-53"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">temp_reading</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">temp_reading</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xF0</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
</span><span id="__span-14-54"><a id="__codelineno-14-54" name="__codelineno-14-54" href="#briefcode-__codelineno-14-54"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">temp</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2047</span><span class="p">)</span>
</span><span id="__span-14-55"><a id="__codelineno-14-55" name="__codelineno-14-55" href="#briefcode-__codelineno-14-55"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-14-56"><a id="__codelineno-14-56" name="__codelineno-14-56" href="#briefcode-__codelineno-14-56"></a><span class="w">            </span><span class="n">temp</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">4096</span><span class="p">;</span>
</span><span id="__span-14-57"><a id="__codelineno-14-57" name="__codelineno-14-57" href="#briefcode-__codelineno-14-57"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-14-58"><a id="__codelineno-14-58" name="__codelineno-14-58" href="#briefcode-__codelineno-14-58"></a>
</span><span id="__span-14-59"><a id="__codelineno-14-59" name="__codelineno-14-59" href="#briefcode-__codelineno-14-59"></a><span class="w">        </span><span class="c1">// Convert to engineering units </span>
</span><span id="__span-14-60"><a id="__codelineno-14-60" name="__codelineno-14-60" href="#briefcode-__codelineno-14-60"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">cTemp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.0625</span><span class="p">;</span>
</span><span id="__span-14-61"><a id="__codelineno-14-61" name="__codelineno-14-61" href="#briefcode-__codelineno-14-61"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">fTemp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cTemp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1.8</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">32</span><span class="p">;</span>
</span><span id="__span-14-62"><a id="__codelineno-14-62" name="__codelineno-14-62" href="#briefcode-__codelineno-14-62"></a>
</span><span id="__span-14-63"><a id="__codelineno-14-63" name="__codelineno-14-63" href="#briefcode-__codelineno-14-63"></a><span class="w">        </span><span class="c1">//Print reading to console  </span>
</span><span id="__span-14-64"><a id="__codelineno-14-64" name="__codelineno-14-64" href="#briefcode-__codelineno-14-64"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Temperature in Celsius : %.2f C </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cTemp</span><span class="p">);</span>
</span><span id="__span-14-65"><a id="__codelineno-14-65" name="__codelineno-14-65" href="#briefcode-__codelineno-14-65"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Temperature in Fahrenheit : %.2f F </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fTemp</span><span class="p">);</span>
</span><span id="__span-14-66"><a id="__codelineno-14-66" name="__codelineno-14-66" href="#briefcode-__codelineno-14-66"></a><span class="w">        </span><span class="n">k_msleep</span><span class="p">(</span><span class="n">SLEEP_TIME_MS</span><span class="p">);</span>
</span><span id="__span-14-67"><a id="__codelineno-14-67" name="__codelineno-14-67" href="#briefcode-__codelineno-14-67"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-14-68"><a id="__codelineno-14-68" name="__codelineno-14-68" href="#briefcode-__codelineno-14-68"></a><span class="p">}</span>
</span></code></pre></div>
</details>
<details class="example">
<summary>sen2_i2c - get data from i2c RGB sensor BH1749 (Enable CONFIG_I2C &amp; CONFIG_CBPRINTF_FP_SUPPORT)</summary>
<div class="language-c highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#briefcode-__codelineno-15-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#briefcode-__codelineno-15-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/device.h&gt;</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#briefcode-__codelineno-15-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/devicetree.h&gt;</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#briefcode-__codelineno-15-4"></a><span class="cm">/* STEP 3 - Include the header file of the I2C API */</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#briefcode-__codelineno-15-5"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/drivers/i2c.h&gt;</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#briefcode-__codelineno-15-6"></a><span class="cm">/* STEP 4.1 - Include the header file of printk() */</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#briefcode-__codelineno-15-7"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/sys/printk.h&gt;</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#briefcode-__codelineno-15-8"></a><span class="cm">/* 1000 msec = 1 sec */</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#briefcode-__codelineno-15-9"></a><span class="cp">#define SLEEP_TIME_MS   1000</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#briefcode-__codelineno-15-10"></a>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#briefcode-__codelineno-15-11"></a><span class="cm">/* STEP 8 - Define the the addresses of relevant sensor registers and settings */</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#briefcode-__codelineno-15-12"></a><span class="cp">#define BH1749_SYSTEM_CONTROL                           0x40</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#briefcode-__codelineno-15-13"></a><span class="cp">#define BH1749_MODE_CONTROL1                            0x41</span>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#briefcode-__codelineno-15-14"></a><span class="cp">#define BH1749_MODE_CONTROL2                            0x42</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#briefcode-__codelineno-15-15"></a><span class="cp">#define BH1749_RED_DATA_LSB                             0x50</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#briefcode-__codelineno-15-16"></a><span class="cp">#define BH1749_MODE_CONTROL2_RGB_EN_ENABLE              BIT(4)</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#briefcode-__codelineno-15-17"></a><span class="cm">/* IR Gain: 1x, RGB Gain: 1x, Measurement mode: 120ms mode */</span>
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#briefcode-__codelineno-15-18"></a><span class="cp">#define BH1749_MODE_CONTROL1_DEFAULTS                   0x2A</span>
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#briefcode-__codelineno-15-19"></a>
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#briefcode-__codelineno-15-20"></a><span class="cm">/* STEP 6 - Get the node identifier of the sensor */</span>
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#briefcode-__codelineno-15-21"></a><span class="cp">#define I2C_NODE DT_NODELABEL(bh1749)</span>
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#briefcode-__codelineno-15-22"></a>
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#briefcode-__codelineno-15-23"></a><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#briefcode-__codelineno-15-24"></a><span class="p">{</span>
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#briefcode-__codelineno-15-25"></a>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#briefcode-__codelineno-15-26"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#briefcode-__codelineno-15-27"></a>
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#briefcode-__codelineno-15-28"></a><span class="cm">/* STEP 7 - Retrieve the API-specific device structure and make sure that the device is ready to use  */</span>
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#briefcode-__codelineno-15-29"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">i2c_dt_spec</span><span class="w"> </span><span class="n">dev_i2c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">I2C_DT_SPEC_GET</span><span class="p">(</span><span class="n">I2C_NODE</span><span class="p">);</span>
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#briefcode-__codelineno-15-30"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">device_is_ready</span><span class="p">(</span><span class="n">dev_i2c</span><span class="p">.</span><span class="n">bus</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#briefcode-__codelineno-15-31"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;I2C bus %s is not ready!</span><span class="se">\n\r</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev_i2c</span><span class="p">.</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span><span id="__span-15-32"><a id="__codelineno-15-32" name="__codelineno-15-32" href="#briefcode-__codelineno-15-32"></a><span class="w">        </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-15-33"><a id="__codelineno-15-33" name="__codelineno-15-33" href="#briefcode-__codelineno-15-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-34"><a id="__codelineno-15-34" name="__codelineno-15-34" href="#briefcode-__codelineno-15-34"></a>
</span><span id="__span-15-35"><a id="__codelineno-15-35" name="__codelineno-15-35" href="#briefcode-__codelineno-15-35"></a><span class="cm">/* STEP 9 - Setup the sensor by writing the value 0x2A to the MODE_CONTROL1 register </span>
</span><span id="__span-15-36"><a id="__codelineno-15-36" name="__codelineno-15-36" href="#briefcode-__codelineno-15-36"></a><span class="cm">0x2A Means : IR Gain: 1x, RGB Gain: 1x, Measurement mode: 120ms mode</span>
</span><span id="__span-15-37"><a id="__codelineno-15-37" name="__codelineno-15-37" href="#briefcode-__codelineno-15-37"></a><span class="cm">*/</span>
</span><span id="__span-15-38"><a id="__codelineno-15-38" name="__codelineno-15-38" href="#briefcode-__codelineno-15-38"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">buff1</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">BH1749_MODE_CONTROL1</span><span class="p">,</span><span class="n">BH1749_MODE_CONTROL1_DEFAULTS</span><span class="p">};</span>
</span><span id="__span-15-39"><a id="__codelineno-15-39" name="__codelineno-15-39" href="#briefcode-__codelineno-15-39"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_write_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_i2c</span><span class="p">,</span><span class="n">buff1</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buff1</span><span class="p">));</span>
</span><span id="__span-15-40"><a id="__codelineno-15-40" name="__codelineno-15-40" href="#briefcode-__codelineno-15-40"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
</span><span id="__span-15-41"><a id="__codelineno-15-41" name="__codelineno-15-41" href="#briefcode-__codelineno-15-41"></a><span class="w">            </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Failed to write to I2C device address 0x%c at Reg. 0x%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev_i2c</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span><span class="n">BH1749_MODE_CONTROL1</span><span class="p">);</span>
</span><span id="__span-15-42"><a id="__codelineno-15-42" name="__codelineno-15-42" href="#briefcode-__codelineno-15-42"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-15-43"><a id="__codelineno-15-43" name="__codelineno-15-43" href="#briefcode-__codelineno-15-43"></a><span class="cm">/* STEP 10 - Enable measurement by writing 1 to bit 4 of the MODE_CONTROL2 register */</span>
</span><span id="__span-15-44"><a id="__codelineno-15-44" name="__codelineno-15-44" href="#briefcode-__codelineno-15-44"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">buff2</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">BH1749_MODE_CONTROL2</span><span class="p">,</span><span class="n">BH1749_MODE_CONTROL2_RGB_EN_ENABLE</span><span class="p">};</span>
</span><span id="__span-15-45"><a id="__codelineno-15-45" name="__codelineno-15-45" href="#briefcode-__codelineno-15-45"></a><span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_write_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_i2c</span><span class="p">,</span><span class="n">buff2</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buff2</span><span class="p">));</span>
</span><span id="__span-15-46"><a id="__codelineno-15-46" name="__codelineno-15-46" href="#briefcode-__codelineno-15-46"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
</span><span id="__span-15-47"><a id="__codelineno-15-47" name="__codelineno-15-47" href="#briefcode-__codelineno-15-47"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Failed to write to I2C device address 0x%c at Reg. 0x%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev_i2c</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span><span class="n">BH1749_MODE_CONTROL2</span><span class="p">);</span>
</span><span id="__span-15-48"><a id="__codelineno-15-48" name="__codelineno-15-48" href="#briefcode-__codelineno-15-48"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-49"><a id="__codelineno-15-49" name="__codelineno-15-49" href="#briefcode-__codelineno-15-49"></a>
</span><span id="__span-15-50"><a id="__codelineno-15-50" name="__codelineno-15-50" href="#briefcode-__codelineno-15-50"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-51"><a id="__codelineno-15-51" name="__codelineno-15-51" href="#briefcode-__codelineno-15-51"></a><span class="cm">/* STEP 11 - Read the RGB values from the sensor */</span>
</span><span id="__span-15-52"><a id="__codelineno-15-52" name="__codelineno-15-52" href="#briefcode-__codelineno-15-52"></a><span class="w">        </span><span class="kt">uint8_t</span><span class="w"> </span><span class="n">rgb_value</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="c1">//3 colour channels x 2 = 6</span>
</span><span id="__span-15-53"><a id="__codelineno-15-53" name="__codelineno-15-53" href="#briefcode-__codelineno-15-53"></a><span class="w">        </span><span class="c1">//Do a burst read of 6 bytes as each color channel is 2 bytes. </span>
</span><span id="__span-15-54"><a id="__codelineno-15-54" name="__codelineno-15-54" href="#briefcode-__codelineno-15-54"></a><span class="w">        </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i2c_burst_read_dt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev_i2c</span><span class="p">,</span><span class="w"> </span><span class="n">BH1749_RED_DATA_LSB</span><span class="p">,</span><span class="n">rgb_value</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rgb_value</span><span class="p">));</span>
</span><span id="__span-15-55"><a id="__codelineno-15-55" name="__codelineno-15-55" href="#briefcode-__codelineno-15-55"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span>
</span><span id="__span-15-56"><a id="__codelineno-15-56" name="__codelineno-15-56" href="#briefcode-__codelineno-15-56"></a><span class="w">            </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Failed to read to I2C device address 0x%c at Reg. 0x%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev_i2c</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span><span class="n">BH1749_RED_DATA_LSB</span><span class="p">);</span>
</span><span id="__span-15-57"><a id="__codelineno-15-57" name="__codelineno-15-57" href="#briefcode-__codelineno-15-57"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-15-58"><a id="__codelineno-15-58" name="__codelineno-15-58" href="#briefcode-__codelineno-15-58"></a><span class="w">        </span><span class="c1">//Print reading to console  </span>
</span><span id="__span-15-59"><a id="__codelineno-15-59" name="__codelineno-15-59" href="#briefcode-__codelineno-15-59"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;_______________________________</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-15-60"><a id="__codelineno-15-60" name="__codelineno-15-60" href="#briefcode-__codelineno-15-60"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Red Value:</span><span class="se">\t</span><span class="s"> %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">rgb_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rgb_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">));</span>
</span><span id="__span-15-61"><a id="__codelineno-15-61" name="__codelineno-15-61" href="#briefcode-__codelineno-15-61"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Green Value:</span><span class="se">\t</span><span class="s"> %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">rgb_value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rgb_value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">));</span>
</span><span id="__span-15-62"><a id="__codelineno-15-62" name="__codelineno-15-62" href="#briefcode-__codelineno-15-62"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Blue Value:</span><span class="se">\t</span><span class="s"> %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">rgb_value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">rgb_value</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span><span class="p">));</span>
</span><span id="__span-15-63"><a id="__codelineno-15-63" name="__codelineno-15-63" href="#briefcode-__codelineno-15-63"></a>
</span><span id="__span-15-64"><a id="__codelineno-15-64" name="__codelineno-15-64" href="#briefcode-__codelineno-15-64"></a><span class="w">        </span><span class="n">k_msleep</span><span class="p">(</span><span class="n">SLEEP_TIME_MS</span><span class="p">);</span>
</span><span id="__span-15-65"><a id="__codelineno-15-65" name="__codelineno-15-65" href="#briefcode-__codelineno-15-65"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-66"><a id="__codelineno-15-66" name="__codelineno-15-66" href="#briefcode-__codelineno-15-66"></a><span class="p">}</span>
</span></code></pre></div>
</details>
<details class="example">
<summary>thrd - threads creation (Enable CONFIG_PRINTK)</summary>
<div class="language-c highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#briefcode-__codelineno-16-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#briefcode-__codelineno-16-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/sys/printk.h&gt;</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#briefcode-__codelineno-16-3"></a>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#briefcode-__codelineno-16-4"></a><span class="cm">/* STEP 2 - Define stack size and scheduling priority used by each thread */</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#briefcode-__codelineno-16-5"></a><span class="cp">#define STACKSIZE 1024</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#briefcode-__codelineno-16-6"></a>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#briefcode-__codelineno-16-7"></a><span class="cp">#define THREAD0_PRIORITY 7</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#briefcode-__codelineno-16-8"></a><span class="cp">#define THREAD1_PRIORITY 7</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#briefcode-__codelineno-16-9"></a>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#briefcode-__codelineno-16-10"></a><span class="kt">void</span><span class="w"> </span><span class="nf">thread0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#briefcode-__codelineno-16-11"></a><span class="p">{</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#briefcode-__codelineno-16-12"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#briefcode-__codelineno-16-13"></a><span class="w">          </span><span class="cm">/* STEP 3 - Call printk() to display a simple string &quot;Hello, I am thread0&quot; */</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#briefcode-__codelineno-16-14"></a><span class="w">          </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Hello, I am thread0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#briefcode-__codelineno-16-15"></a><span class="w">          </span><span class="cm">/* STEP 6 - Make the thread yield */</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#briefcode-__codelineno-16-16"></a><span class="w">          </span><span class="c1">//k_yield();</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#briefcode-__codelineno-16-17"></a><span class="w">          </span><span class="cm">/* STEP 10 - Put the thread to sleep */</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#briefcode-__codelineno-16-18"></a><span class="w">          </span><span class="n">k_msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#briefcode-__codelineno-16-19"></a><span class="w">          </span><span class="cm">/* Remember to comment out the line from STEP 6 */</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#briefcode-__codelineno-16-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#briefcode-__codelineno-16-21"></a><span class="p">}</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#briefcode-__codelineno-16-22"></a>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#briefcode-__codelineno-16-23"></a><span class="kt">void</span><span class="w"> </span><span class="nf">thread1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="#briefcode-__codelineno-16-24"></a><span class="p">{</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25" href="#briefcode-__codelineno-16-25"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26" href="#briefcode-__codelineno-16-26"></a><span class="w">          </span><span class="cm">/* STEP 3 - Call printk() to display a simple string &quot;Hello, I am thread1&quot; */</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27" href="#briefcode-__codelineno-16-27"></a><span class="w">          </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Hello, I am thread1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w">        </span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28" href="#briefcode-__codelineno-16-28"></a><span class="w">          </span><span class="cm">/* STEP 8 - Make the thread yield */</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29" href="#briefcode-__codelineno-16-29"></a><span class="w">          </span><span class="c1">//k_yield();        </span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30" href="#briefcode-__codelineno-16-30"></a><span class="w">          </span><span class="cm">/* STEP 10 - Put the thread to sleep */</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31" href="#briefcode-__codelineno-16-31"></a><span class="w">          </span><span class="n">k_msleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32" href="#briefcode-__codelineno-16-32"></a><span class="w">          </span><span class="cm">/* Remember to comment out the line from STEP 8 */</span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33" href="#briefcode-__codelineno-16-33"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34" href="#briefcode-__codelineno-16-34"></a><span class="p">}</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35" href="#briefcode-__codelineno-16-35"></a>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36" href="#briefcode-__codelineno-16-36"></a><span class="cm">/* STEP 4 - Define and initialize the two threads */</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37" href="#briefcode-__codelineno-16-37"></a><span class="n">K_THREAD_DEFINE</span><span class="p">(</span><span class="n">thread0_id</span><span class="p">,</span><span class="w"> </span><span class="n">STACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">thread0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38" href="#briefcode-__codelineno-16-38"></a><span class="w">        </span><span class="n">THREAD0_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39" href="#briefcode-__codelineno-16-39"></a><span class="n">K_THREAD_DEFINE</span><span class="p">(</span><span class="n">thread1_id</span><span class="p">,</span><span class="w"> </span><span class="n">STACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">thread1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
</span><span id="__span-16-40"><a id="__codelineno-16-40" name="__codelineno-16-40" href="#briefcode-__codelineno-16-40"></a><span class="w">        </span><span class="n">THREAD1_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></div>
</details>
<details class="example">
<summary>thrd_ts - threads creation with timeslicing (Enable CONFIG_PRINTK, timeslicing)</summary>
<div class="language-c highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#briefcode-__codelineno-17-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#briefcode-__codelineno-17-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/sys/printk.h&gt;</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#briefcode-__codelineno-17-3"></a>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#briefcode-__codelineno-17-4"></a><span class="cp">#define STACKSIZE 1024</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#briefcode-__codelineno-17-5"></a>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#briefcode-__codelineno-17-6"></a><span class="cm">/* STEP 5 - Change the priority of thread0 to 6 */</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#briefcode-__codelineno-17-7"></a><span class="cp">#define THREAD0_PRIORITY 6</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#briefcode-__codelineno-17-8"></a><span class="cp">#define THREAD1_PRIORITY 7</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#briefcode-__codelineno-17-9"></a>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#briefcode-__codelineno-17-10"></a><span class="kt">void</span><span class="w"> </span><span class="nf">thread0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#briefcode-__codelineno-17-11"></a><span class="p">{</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#briefcode-__codelineno-17-12"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#briefcode-__codelineno-17-13"></a><span class="w">          </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Hello, I am thread0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#briefcode-__codelineno-17-14"></a><span class="w">          </span><span class="n">k_busy_wait</span><span class="p">(</span><span class="mi">1000000</span><span class="p">);</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#briefcode-__codelineno-17-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#briefcode-__codelineno-17-16"></a><span class="p">}</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#briefcode-__codelineno-17-17"></a>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#briefcode-__codelineno-17-18"></a><span class="kt">void</span><span class="w"> </span><span class="nf">thread1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#briefcode-__codelineno-17-19"></a><span class="p">{</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#briefcode-__codelineno-17-20"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#briefcode-__codelineno-17-21"></a><span class="w">          </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Hello, I am thread1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="#briefcode-__codelineno-17-22"></a><span class="w">          </span><span class="n">k_busy_wait</span><span class="p">(</span><span class="mi">1000000</span><span class="p">);</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="#briefcode-__codelineno-17-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="#briefcode-__codelineno-17-24"></a><span class="p">}</span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="#briefcode-__codelineno-17-25"></a>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26" href="#briefcode-__codelineno-17-26"></a><span class="n">K_THREAD_DEFINE</span><span class="p">(</span><span class="n">thread0_id</span><span class="p">,</span><span class="w"> </span><span class="n">STACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">thread0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27" href="#briefcode-__codelineno-17-27"></a><span class="w">        </span><span class="n">THREAD0_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28" href="#briefcode-__codelineno-17-28"></a><span class="n">K_THREAD_DEFINE</span><span class="p">(</span><span class="n">thread1_id</span><span class="p">,</span><span class="w"> </span><span class="n">STACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">thread1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29" href="#briefcode-__codelineno-17-29"></a><span class="w">        </span><span class="n">THREAD1_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></div>
</details>
<details class="example">
<summary>thrd_wq - workqueue threads creation (Enable CONFIG_PRINTK)</summary>
<div class="language-c highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#briefcode-__codelineno-18-1"></a><span class="cm">/*</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#briefcode-__codelineno-18-2"></a><span class="cm"> * Copyright (c) 2017 Linaro Limited</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#briefcode-__codelineno-18-3"></a><span class="cm"> *</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#briefcode-__codelineno-18-4"></a><span class="cm"> * SPDX-License-Identifier: Apache-2.0</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#briefcode-__codelineno-18-5"></a><span class="cm"> */</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#briefcode-__codelineno-18-6"></a>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#briefcode-__codelineno-18-7"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#briefcode-__codelineno-18-8"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/sys/printk.h&gt;</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#briefcode-__codelineno-18-9"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#briefcode-__codelineno-18-10"></a><span class="c1">// Define stack size used by each thread</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#briefcode-__codelineno-18-11"></a><span class="cp">#define THREAD0_STACKSIZE       512</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#briefcode-__codelineno-18-12"></a><span class="cp">#define THREAD1_STACKSIZE       512</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#briefcode-__codelineno-18-13"></a><span class="cp">#define WORQ_THREAD_STACK_SIZE  512</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#briefcode-__codelineno-18-14"></a>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#briefcode-__codelineno-18-15"></a><span class="cm">/* STEP 2 - Set the priorities of the threads */</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#briefcode-__codelineno-18-16"></a><span class="cp">#define THREAD0_PRIORITY 2 </span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#briefcode-__codelineno-18-17"></a><span class="cp">#define THREAD1_PRIORITY 3</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#briefcode-__codelineno-18-18"></a><span class="cp">#define WORKQ_PRIORITY   4</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#briefcode-__codelineno-18-19"></a>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#briefcode-__codelineno-18-20"></a><span class="c1">// Define stack area used by workqueue thread</span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#briefcode-__codelineno-18-21"></a><span class="k">static</span><span class="w"> </span><span class="n">K_THREAD_STACK_DEFINE</span><span class="p">(</span><span class="n">my_stack_area</span><span class="p">,</span><span class="w"> </span><span class="n">WORQ_THREAD_STACK_SIZE</span><span class="p">);</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#briefcode-__codelineno-18-22"></a>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#briefcode-__codelineno-18-23"></a><span class="c1">// Define queue structure</span>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#briefcode-__codelineno-18-24"></a><span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">k_work_q</span><span class="w"> </span><span class="n">offload_work_q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25" href="#briefcode-__codelineno-18-25"></a>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26" href="#briefcode-__codelineno-18-26"></a>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27" href="#briefcode-__codelineno-18-27"></a><span class="cm">/* STEP 5 - Define function to emulate non-urgent work */</span>
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28" href="#briefcode-__codelineno-18-28"></a><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">emulate_work</span><span class="p">()</span>
</span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29" href="#briefcode-__codelineno-18-29"></a><span class="p">{</span>
</span><span id="__span-18-30"><a id="__codelineno-18-30" name="__codelineno-18-30" href="#briefcode-__codelineno-18-30"></a><span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="k">volatile</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count_out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">count_out</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">150000</span><span class="p">;</span><span class="w"> </span><span class="n">count_out</span><span class="w"> </span><span class="o">++</span><span class="p">);</span>
</span><span id="__span-18-31"><a id="__codelineno-18-31" name="__codelineno-18-31" href="#briefcode-__codelineno-18-31"></a><span class="p">}</span>
</span><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32" href="#briefcode-__codelineno-18-32"></a>
</span><span id="__span-18-33"><a id="__codelineno-18-33" name="__codelineno-18-33" href="#briefcode-__codelineno-18-33"></a><span class="cm">/* STEP 7 - Create work_info structure and offload function */</span>
</span><span id="__span-18-34"><a id="__codelineno-18-34" name="__codelineno-18-34" href="#briefcode-__codelineno-18-34"></a><span class="k">struct</span><span class="w"> </span><span class="nc">work_info</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-35"><a id="__codelineno-18-35" name="__codelineno-18-35" href="#briefcode-__codelineno-18-35"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">k_work</span><span class="w"> </span><span class="n">work</span><span class="p">;</span>
</span><span id="__span-18-36"><a id="__codelineno-18-36" name="__codelineno-18-36" href="#briefcode-__codelineno-18-36"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="mi">25</span><span class="p">];</span>
</span><span id="__span-18-37"><a id="__codelineno-18-37" name="__codelineno-18-37" href="#briefcode-__codelineno-18-37"></a><span class="p">}</span><span class="w"> </span><span class="n">my_work</span><span class="p">;</span>
</span><span id="__span-18-38"><a id="__codelineno-18-38" name="__codelineno-18-38" href="#briefcode-__codelineno-18-38"></a>
</span><span id="__span-18-39"><a id="__codelineno-18-39" name="__codelineno-18-39" href="#briefcode-__codelineno-18-39"></a><span class="kt">void</span><span class="w"> </span><span class="nf">offload_function</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">k_work</span><span class="w"> </span><span class="o">*</span><span class="n">work_tem</span><span class="p">)</span>
</span><span id="__span-18-40"><a id="__codelineno-18-40" name="__codelineno-18-40" href="#briefcode-__codelineno-18-40"></a><span class="p">{</span>
</span><span id="__span-18-41"><a id="__codelineno-18-41" name="__codelineno-18-41" href="#briefcode-__codelineno-18-41"></a><span class="w">    </span><span class="n">emulate_work</span><span class="p">();</span>
</span><span id="__span-18-42"><a id="__codelineno-18-42" name="__codelineno-18-42" href="#briefcode-__codelineno-18-42"></a><span class="p">}</span>
</span><span id="__span-18-43"><a id="__codelineno-18-43" name="__codelineno-18-43" href="#briefcode-__codelineno-18-43"></a>
</span><span id="__span-18-44"><a id="__codelineno-18-44" name="__codelineno-18-44" href="#briefcode-__codelineno-18-44"></a><span class="kt">void</span><span class="w"> </span><span class="nf">thread0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-18-45"><a id="__codelineno-18-45" name="__codelineno-18-45" href="#briefcode-__codelineno-18-45"></a><span class="p">{</span>
</span><span id="__span-18-46"><a id="__codelineno-18-46" name="__codelineno-18-46" href="#briefcode-__codelineno-18-46"></a><span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">time_stamp</span><span class="p">;</span>
</span><span id="__span-18-47"><a id="__codelineno-18-47" name="__codelineno-18-47" href="#briefcode-__codelineno-18-47"></a><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">delta_time</span><span class="p">;</span>
</span><span id="__span-18-48"><a id="__codelineno-18-48" name="__codelineno-18-48" href="#briefcode-__codelineno-18-48"></a><span class="w">    </span><span class="cm">/* STEP 8 - Start the workqueue, */</span>
</span><span id="__span-18-49"><a id="__codelineno-18-49" name="__codelineno-18-49" href="#briefcode-__codelineno-18-49"></a><span class="w">    </span><span class="cm">/* initialize the work item and connect it to its handler function */</span><span class="w"> </span>
</span><span id="__span-18-50"><a id="__codelineno-18-50" name="__codelineno-18-50" href="#briefcode-__codelineno-18-50"></a><span class="w">    </span><span class="n">k_work_queue_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offload_work_q</span><span class="p">,</span><span class="w"> </span><span class="n">my_stack_area</span><span class="p">,</span>
</span><span id="__span-18-51"><a id="__codelineno-18-51" name="__codelineno-18-51" href="#briefcode-__codelineno-18-51"></a><span class="w">                    </span><span class="n">K_THREAD_STACK_SIZEOF</span><span class="p">(</span><span class="n">my_stack_area</span><span class="p">),</span><span class="w"> </span><span class="n">WORKQ_PRIORITY</span><span class="p">,</span>
</span><span id="__span-18-52"><a id="__codelineno-18-52" name="__codelineno-18-52" href="#briefcode-__codelineno-18-52"></a><span class="w">                    </span><span class="nb">NULL</span><span class="p">);</span>
</span><span id="__span-18-53"><a id="__codelineno-18-53" name="__codelineno-18-53" href="#briefcode-__codelineno-18-53"></a><span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">my_work</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Thread0 emulate_work()&quot;</span><span class="p">);</span>
</span><span id="__span-18-54"><a id="__codelineno-18-54" name="__codelineno-18-54" href="#briefcode-__codelineno-18-54"></a><span class="w">    </span><span class="n">k_work_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_work</span><span class="p">.</span><span class="n">work</span><span class="p">,</span><span class="w"> </span><span class="n">offload_function</span><span class="p">);</span>
</span><span id="__span-18-55"><a id="__codelineno-18-55" name="__codelineno-18-55" href="#briefcode-__codelineno-18-55"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-56"><a id="__codelineno-18-56" name="__codelineno-18-56" href="#briefcode-__codelineno-18-56"></a><span class="w">        </span><span class="n">time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k_uptime_get</span><span class="p">();</span>
</span><span id="__span-18-57"><a id="__codelineno-18-57" name="__codelineno-18-57" href="#briefcode-__codelineno-18-57"></a><span class="w">        </span><span class="cm">/* STEP 9 - Submit the work item to the workqueue instead of calling emulate_work() directly */</span>
</span><span id="__span-18-58"><a id="__codelineno-18-58" name="__codelineno-18-58" href="#briefcode-__codelineno-18-58"></a><span class="w">        </span><span class="cm">/* Remember to comment out emulate_work(); */</span>
</span><span id="__span-18-59"><a id="__codelineno-18-59" name="__codelineno-18-59" href="#briefcode-__codelineno-18-59"></a><span class="w">        </span><span class="n">k_work_submit_to_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offload_work_q</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">my_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
</span><span id="__span-18-60"><a id="__codelineno-18-60" name="__codelineno-18-60" href="#briefcode-__codelineno-18-60"></a><span class="w">        </span><span class="n">delta_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k_uptime_delta</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time_stamp</span><span class="p">);</span>
</span><span id="__span-18-61"><a id="__codelineno-18-61" name="__codelineno-18-61" href="#briefcode-__codelineno-18-61"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;thread0 yielding this round in %lld ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">);</span>
</span><span id="__span-18-62"><a id="__codelineno-18-62" name="__codelineno-18-62" href="#briefcode-__codelineno-18-62"></a><span class="w">        </span><span class="n">k_msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
</span><span id="__span-18-63"><a id="__codelineno-18-63" name="__codelineno-18-63" href="#briefcode-__codelineno-18-63"></a><span class="w">    </span><span class="p">}</span><span class="w">   </span>
</span><span id="__span-18-64"><a id="__codelineno-18-64" name="__codelineno-18-64" href="#briefcode-__codelineno-18-64"></a><span class="p">}</span>
</span><span id="__span-18-65"><a id="__codelineno-18-65" name="__codelineno-18-65" href="#briefcode-__codelineno-18-65"></a>
</span><span id="__span-18-66"><a id="__codelineno-18-66" name="__codelineno-18-66" href="#briefcode-__codelineno-18-66"></a><span class="cm">/* STEP 4 - Define entry function for thread1 */</span>
</span><span id="__span-18-67"><a id="__codelineno-18-67" name="__codelineno-18-67" href="#briefcode-__codelineno-18-67"></a><span class="kt">void</span><span class="w"> </span><span class="nf">thread1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-18-68"><a id="__codelineno-18-68" name="__codelineno-18-68" href="#briefcode-__codelineno-18-68"></a><span class="p">{</span>
</span><span id="__span-18-69"><a id="__codelineno-18-69" name="__codelineno-18-69" href="#briefcode-__codelineno-18-69"></a><span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">time_stamp</span><span class="p">;</span>
</span><span id="__span-18-70"><a id="__codelineno-18-70" name="__codelineno-18-70" href="#briefcode-__codelineno-18-70"></a><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">delta_time</span><span class="p">;</span>
</span><span id="__span-18-71"><a id="__codelineno-18-71" name="__codelineno-18-71" href="#briefcode-__codelineno-18-71"></a>
</span><span id="__span-18-72"><a id="__codelineno-18-72" name="__codelineno-18-72" href="#briefcode-__codelineno-18-72"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-73"><a id="__codelineno-18-73" name="__codelineno-18-73" href="#briefcode-__codelineno-18-73"></a><span class="w">        </span><span class="n">time_stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k_uptime_get</span><span class="p">();</span>
</span><span id="__span-18-74"><a id="__codelineno-18-74" name="__codelineno-18-74" href="#briefcode-__codelineno-18-74"></a><span class="w">        </span><span class="n">emulate_work</span><span class="p">();</span>
</span><span id="__span-18-75"><a id="__codelineno-18-75" name="__codelineno-18-75" href="#briefcode-__codelineno-18-75"></a><span class="w">        </span><span class="n">delta_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">k_uptime_delta</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time_stamp</span><span class="p">);</span>
</span><span id="__span-18-76"><a id="__codelineno-18-76" name="__codelineno-18-76" href="#briefcode-__codelineno-18-76"></a>
</span><span id="__span-18-77"><a id="__codelineno-18-77" name="__codelineno-18-77" href="#briefcode-__codelineno-18-77"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;thread1 yielding this round in %lld ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">delta_time</span><span class="p">);</span>
</span><span id="__span-18-78"><a id="__codelineno-18-78" name="__codelineno-18-78" href="#briefcode-__codelineno-18-78"></a><span class="w">        </span><span class="n">k_msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
</span><span id="__span-18-79"><a id="__codelineno-18-79" name="__codelineno-18-79" href="#briefcode-__codelineno-18-79"></a><span class="w">    </span><span class="p">}</span><span class="w">   </span>
</span><span id="__span-18-80"><a id="__codelineno-18-80" name="__codelineno-18-80" href="#briefcode-__codelineno-18-80"></a><span class="p">}</span>
</span><span id="__span-18-81"><a id="__codelineno-18-81" name="__codelineno-18-81" href="#briefcode-__codelineno-18-81"></a>
</span><span id="__span-18-82"><a id="__codelineno-18-82" name="__codelineno-18-82" href="#briefcode-__codelineno-18-82"></a><span class="n">K_THREAD_DEFINE</span><span class="p">(</span><span class="n">thread0_id</span><span class="p">,</span><span class="w"> </span><span class="n">THREAD0_STACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">thread0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
</span><span id="__span-18-83"><a id="__codelineno-18-83" name="__codelineno-18-83" href="#briefcode-__codelineno-18-83"></a><span class="w">        </span><span class="n">THREAD0_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-18-84"><a id="__codelineno-18-84" name="__codelineno-18-84" href="#briefcode-__codelineno-18-84"></a><span class="n">K_THREAD_DEFINE</span><span class="p">(</span><span class="n">thread1_id</span><span class="p">,</span><span class="w"> </span><span class="n">THREAD1_STACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">thread1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
</span><span id="__span-18-85"><a id="__codelineno-18-85" name="__codelineno-18-85" href="#briefcode-__codelineno-18-85"></a><span class="w">        </span><span class="n">THREAD1_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></div>
</details>
<details class="example">
<summary>thrd_semaphore - producer &amp; consumer problem with <code>semaphore</code> (Enable CONFIG_PRINTK, CONFIG_ENTROPY_GENERATOR, CONFIG_TEST_RANDOM_GENERATOR)</summary>
<div class="language-c highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#briefcode-__codelineno-19-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#briefcode-__codelineno-19-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/sys/printk.h&gt;</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#briefcode-__codelineno-19-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/random/rand32.h&gt;</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#briefcode-__codelineno-19-4"></a>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#briefcode-__codelineno-19-5"></a><span class="cp">#define PRODUCER_STACKSIZE       512</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#briefcode-__codelineno-19-6"></a><span class="cp">#define CONSUMER_STACKSIZE       512</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#briefcode-__codelineno-19-7"></a>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#briefcode-__codelineno-19-8"></a><span class="cm">/* STEP 2 - Set the priority of the producer and consumper thread */</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#briefcode-__codelineno-19-9"></a><span class="cp">#define PRODUCER_PRIORITY 5 </span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#briefcode-__codelineno-19-10"></a><span class="cp">#define CONSUMER_PRIORITY 4</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#briefcode-__codelineno-19-11"></a>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#briefcode-__codelineno-19-12"></a><span class="cm">/* STEP 9 - Define semaphore to monitor instances of available resource */</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#briefcode-__codelineno-19-13"></a><span class="n">K_SEM_DEFINE</span><span class="p">(</span><span class="n">instance_monitor_sem</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#briefcode-__codelineno-19-14"></a>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#briefcode-__codelineno-19-15"></a><span class="cm">/* STEP 3 - Initialize the available instances of this resource */</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#briefcode-__codelineno-19-16"></a><span class="k">volatile</span><span class="w"> </span><span class="kt">uint32_t</span><span class="w"> </span><span class="n">available_instance_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#briefcode-__codelineno-19-17"></a>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#briefcode-__codelineno-19-18"></a><span class="c1">// Function for getting access of resource</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#briefcode-__codelineno-19-19"></a><span class="kt">void</span><span class="w"> </span><span class="nf">get_access</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#briefcode-__codelineno-19-20"></a><span class="p">{</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#briefcode-__codelineno-19-21"></a><span class="w">    </span><span class="cm">/* STEP 10.1 - Get semaphore before access to the resource */</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#briefcode-__codelineno-19-22"></a><span class="w">    </span><span class="n">k_sem_take</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance_monitor_sem</span><span class="p">,</span><span class="w"> </span><span class="n">K_FOREVER</span><span class="p">);</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#briefcode-__codelineno-19-23"></a>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#briefcode-__codelineno-19-24"></a><span class="w">    </span><span class="cm">/* STEP 6.1 - Decrement available resource */</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#briefcode-__codelineno-19-25"></a><span class="w">    </span><span class="n">available_instance_count</span><span class="o">--</span><span class="p">;</span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#briefcode-__codelineno-19-26"></a><span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Resource taken and available_instance_count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">available_instance_count</span><span class="p">);</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27" href="#briefcode-__codelineno-19-27"></a><span class="p">}</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28" href="#briefcode-__codelineno-19-28"></a>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29" href="#briefcode-__codelineno-19-29"></a><span class="c1">// Function for releasing access of resource</span>
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30" href="#briefcode-__codelineno-19-30"></a><span class="kt">void</span><span class="w"> </span><span class="nf">release_access</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31" href="#briefcode-__codelineno-19-31"></a><span class="p">{</span>
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32" href="#briefcode-__codelineno-19-32"></a><span class="w">    </span><span class="cm">/* STEP 6.2 - Increment available resource */</span>
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33" href="#briefcode-__codelineno-19-33"></a><span class="w">    </span><span class="n">available_instance_count</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34" href="#briefcode-__codelineno-19-34"></a><span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Resource given and available_instance_count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">available_instance_count</span><span class="p">);</span>
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35" href="#briefcode-__codelineno-19-35"></a>
</span><span id="__span-19-36"><a id="__codelineno-19-36" name="__codelineno-19-36" href="#briefcode-__codelineno-19-36"></a><span class="w">    </span><span class="cm">/* STEP 10.2 - Give semaphore after finishing access to resource */</span>
</span><span id="__span-19-37"><a id="__codelineno-19-37" name="__codelineno-19-37" href="#briefcode-__codelineno-19-37"></a><span class="w">    </span><span class="n">k_sem_give</span><span class="p">(</span><span class="o">&amp;</span><span class="n">instance_monitor_sem</span><span class="p">);</span>
</span><span id="__span-19-38"><a id="__codelineno-19-38" name="__codelineno-19-38" href="#briefcode-__codelineno-19-38"></a><span class="p">}</span>
</span><span id="__span-19-39"><a id="__codelineno-19-39" name="__codelineno-19-39" href="#briefcode-__codelineno-19-39"></a>
</span><span id="__span-19-40"><a id="__codelineno-19-40" name="__codelineno-19-40" href="#briefcode-__codelineno-19-40"></a><span class="cm">/* STEP 4 - Producer thread relinquishing access to instance */</span>
</span><span id="__span-19-41"><a id="__codelineno-19-41" name="__codelineno-19-41" href="#briefcode-__codelineno-19-41"></a><span class="kt">void</span><span class="w"> </span><span class="nf">producer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-19-42"><a id="__codelineno-19-42" name="__codelineno-19-42" href="#briefcode-__codelineno-19-42"></a><span class="p">{</span>
</span><span id="__span-19-43"><a id="__codelineno-19-43" name="__codelineno-19-43" href="#briefcode-__codelineno-19-43"></a><span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Producer thread started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-19-44"><a id="__codelineno-19-44" name="__codelineno-19-44" href="#briefcode-__codelineno-19-44"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-45"><a id="__codelineno-19-45" name="__codelineno-19-45" href="#briefcode-__codelineno-19-45"></a><span class="w">        </span><span class="n">release_access</span><span class="p">();</span>
</span><span id="__span-19-46"><a id="__codelineno-19-46" name="__codelineno-19-46" href="#briefcode-__codelineno-19-46"></a><span class="w">        </span><span class="c1">// Assume the resource instance access is released at this point</span>
</span><span id="__span-19-47"><a id="__codelineno-19-47" name="__codelineno-19-47" href="#briefcode-__codelineno-19-47"></a><span class="w">        </span><span class="n">k_msleep</span><span class="p">(</span><span class="mi">500</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sys_rand32_get</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
</span><span id="__span-19-48"><a id="__codelineno-19-48" name="__codelineno-19-48" href="#briefcode-__codelineno-19-48"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-49"><a id="__codelineno-19-49" name="__codelineno-19-49" href="#briefcode-__codelineno-19-49"></a><span class="p">}</span>
</span><span id="__span-19-50"><a id="__codelineno-19-50" name="__codelineno-19-50" href="#briefcode-__codelineno-19-50"></a>
</span><span id="__span-19-51"><a id="__codelineno-19-51" name="__codelineno-19-51" href="#briefcode-__codelineno-19-51"></a><span class="cm">/* STEP 5 - Consumer thread obtaining access to instance */</span>
</span><span id="__span-19-52"><a id="__codelineno-19-52" name="__codelineno-19-52" href="#briefcode-__codelineno-19-52"></a><span class="kt">void</span><span class="w"> </span><span class="nf">consumer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-19-53"><a id="__codelineno-19-53" name="__codelineno-19-53" href="#briefcode-__codelineno-19-53"></a><span class="p">{</span>
</span><span id="__span-19-54"><a id="__codelineno-19-54" name="__codelineno-19-54" href="#briefcode-__codelineno-19-54"></a><span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Consumer thread started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-19-55"><a id="__codelineno-19-55" name="__codelineno-19-55" href="#briefcode-__codelineno-19-55"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-56"><a id="__codelineno-19-56" name="__codelineno-19-56" href="#briefcode-__codelineno-19-56"></a><span class="w">        </span><span class="n">get_access</span><span class="p">();</span>
</span><span id="__span-19-57"><a id="__codelineno-19-57" name="__codelineno-19-57" href="#briefcode-__codelineno-19-57"></a><span class="w">        </span><span class="c1">// Assume the resource instance access is released at this point</span>
</span><span id="__span-19-58"><a id="__codelineno-19-58" name="__codelineno-19-58" href="#briefcode-__codelineno-19-58"></a><span class="w">        </span><span class="n">k_msleep</span><span class="p">(</span><span class="w"> </span><span class="n">sys_rand32_get</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
</span><span id="__span-19-59"><a id="__codelineno-19-59" name="__codelineno-19-59" href="#briefcode-__codelineno-19-59"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-60"><a id="__codelineno-19-60" name="__codelineno-19-60" href="#briefcode-__codelineno-19-60"></a><span class="p">}</span>
</span><span id="__span-19-61"><a id="__codelineno-19-61" name="__codelineno-19-61" href="#briefcode-__codelineno-19-61"></a>
</span><span id="__span-19-62"><a id="__codelineno-19-62" name="__codelineno-19-62" href="#briefcode-__codelineno-19-62"></a><span class="n">K_THREAD_DEFINE</span><span class="p">(</span><span class="n">producer_id</span><span class="p">,</span><span class="w"> </span><span class="n">PRODUCER_STACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">producer</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
</span><span id="__span-19-63"><a id="__codelineno-19-63" name="__codelineno-19-63" href="#briefcode-__codelineno-19-63"></a><span class="w">        </span><span class="n">PRODUCER_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-19-64"><a id="__codelineno-19-64" name="__codelineno-19-64" href="#briefcode-__codelineno-19-64"></a>
</span><span id="__span-19-65"><a id="__codelineno-19-65" name="__codelineno-19-65" href="#briefcode-__codelineno-19-65"></a><span class="n">K_THREAD_DEFINE</span><span class="p">(</span><span class="n">consumer_id</span><span class="p">,</span><span class="w"> </span><span class="n">CONSUMER_STACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">consumer</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
</span><span id="__span-19-66"><a id="__codelineno-19-66" name="__codelineno-19-66" href="#briefcode-__codelineno-19-66"></a><span class="w">        </span><span class="n">CONSUMER_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></div>
</details>
<details class="example">
<summary>thrd_mutex - race condition problem with <code>mutex</code> (Enable CONFIG_PRINTK, CONFIG_ENTROPY_GENERATOR, CONFIG_TEST_RANDOM_GENERATOR, timeslicing)</summary>
<div class="language-c highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#briefcode-__codelineno-20-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/kernel.h&gt;</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#briefcode-__codelineno-20-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/sys/printk.h&gt;</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#briefcode-__codelineno-20-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;zephyr/random/rand32.h&gt;</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#briefcode-__codelineno-20-4"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#briefcode-__codelineno-20-5"></a>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#briefcode-__codelineno-20-6"></a><span class="cp">#define THREAD0_STACKSIZE       512</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#briefcode-__codelineno-20-7"></a><span class="cp">#define THREAD1_STACKSIZE       512</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#briefcode-__codelineno-20-8"></a>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#briefcode-__codelineno-20-9"></a><span class="cm">/* STEP 3 - Set the priority of the two threads to have equal priority*/</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#briefcode-__codelineno-20-10"></a><span class="cp">#define THREAD0_PRIORITY 4 </span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#briefcode-__codelineno-20-11"></a><span class="cp">#define THREAD1_PRIORITY 4</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#briefcode-__codelineno-20-12"></a>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#briefcode-__codelineno-20-13"></a><span class="cm">/* STEP 5 - Define the two counters with a constant combined total */</span>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#briefcode-__codelineno-20-14"></a><span class="cp">#define COMBINED_TOTAL   40</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#briefcode-__codelineno-20-15"></a>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#briefcode-__codelineno-20-16"></a><span class="kt">int32_t</span><span class="w"> </span><span class="n">increment_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#briefcode-__codelineno-20-17"></a><span class="kt">int32_t</span><span class="w"> </span><span class="n">decrement_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COMBINED_TOTAL</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#briefcode-__codelineno-20-18"></a>
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#briefcode-__codelineno-20-19"></a><span class="cm">/* STEP 11 - Define mutex to protect access to shared code section */</span>
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#briefcode-__codelineno-20-20"></a><span class="n">K_MUTEX_DEFINE</span><span class="p">(</span><span class="n">test_mutex</span><span class="p">);</span>
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#briefcode-__codelineno-20-21"></a>
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#briefcode-__codelineno-20-22"></a><span class="c1">// Shared code run by both threads</span>
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#briefcode-__codelineno-20-23"></a><span class="kt">void</span><span class="w"> </span><span class="nf">shared_code_section</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#briefcode-__codelineno-20-24"></a><span class="p">{</span>
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="#briefcode-__codelineno-20-25"></a><span class="w">    </span><span class="cm">/* STEP 12.1 - Lock the mutex */</span>
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="#briefcode-__codelineno-20-26"></a><span class="w">    </span><span class="n">k_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">test_mutex</span><span class="p">,</span><span class="w"> </span><span class="n">K_FOREVER</span><span class="p">);</span>
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27" href="#briefcode-__codelineno-20-27"></a>
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28" href="#briefcode-__codelineno-20-28"></a><span class="w">    </span><span class="cm">/* STEP 6 - Increment count and decrement count changed */</span>
</span><span id="__span-20-29"><a id="__codelineno-20-29" name="__codelineno-20-29" href="#briefcode-__codelineno-20-29"></a><span class="w">    </span><span class="cm">/* according to logic defined in exercise text */</span>
</span><span id="__span-20-30"><a id="__codelineno-20-30" name="__codelineno-20-30" href="#briefcode-__codelineno-20-30"></a><span class="w">    </span><span class="n">increment_count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-20-31"><a id="__codelineno-20-31" name="__codelineno-20-31" href="#briefcode-__codelineno-20-31"></a><span class="w">    </span><span class="n">increment_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">increment_count</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">COMBINED_TOTAL</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-20-32"><a id="__codelineno-20-32" name="__codelineno-20-32" href="#briefcode-__codelineno-20-32"></a>
</span><span id="__span-20-33"><a id="__codelineno-20-33" name="__codelineno-20-33" href="#briefcode-__codelineno-20-33"></a><span class="w">    </span><span class="n">decrement_count</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-20-34"><a id="__codelineno-20-34" name="__codelineno-20-34" href="#briefcode-__codelineno-20-34"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">decrement_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-20-35"><a id="__codelineno-20-35" name="__codelineno-20-35" href="#briefcode-__codelineno-20-35"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-20-36"><a id="__codelineno-20-36" name="__codelineno-20-36" href="#briefcode-__codelineno-20-36"></a><span class="w">        </span><span class="n">decrement_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">COMBINED_TOTAL</span><span class="p">;</span>
</span><span id="__span-20-37"><a id="__codelineno-20-37" name="__codelineno-20-37" href="#briefcode-__codelineno-20-37"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-20-38"><a id="__codelineno-20-38" name="__codelineno-20-38" href="#briefcode-__codelineno-20-38"></a>
</span><span id="__span-20-39"><a id="__codelineno-20-39" name="__codelineno-20-39" href="#briefcode-__codelineno-20-39"></a><span class="w">    </span><span class="cm">/* STEP 12.2 - Unlock the mutex */</span>
</span><span id="__span-20-40"><a id="__codelineno-20-40" name="__codelineno-20-40" href="#briefcode-__codelineno-20-40"></a><span class="w">    </span><span class="n">k_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">test_mutex</span><span class="p">);</span>
</span><span id="__span-20-41"><a id="__codelineno-20-41" name="__codelineno-20-41" href="#briefcode-__codelineno-20-41"></a>
</span><span id="__span-20-42"><a id="__codelineno-20-42" name="__codelineno-20-42" href="#briefcode-__codelineno-20-42"></a><span class="w">    </span><span class="cm">/* STEP 7 - Print counter values if they do not add up to COMBINED_TOTAL */</span>
</span><span id="__span-20-43"><a id="__codelineno-20-43" name="__codelineno-20-43" href="#briefcode-__codelineno-20-43"></a><span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">increment_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">decrement_count</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">COMBINED_TOTAL</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-20-44"><a id="__codelineno-20-44" name="__codelineno-20-44" href="#briefcode-__codelineno-20-44"></a><span class="w">    </span><span class="p">{</span>
</span><span id="__span-20-45"><a id="__codelineno-20-45" name="__codelineno-20-45" href="#briefcode-__codelineno-20-45"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Race condition happend!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-20-46"><a id="__codelineno-20-46" name="__codelineno-20-46" href="#briefcode-__codelineno-20-46"></a><span class="w">        </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Increment_count (%d) + Decrement_count (%d) = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span id="__span-20-47"><a id="__codelineno-20-47" name="__codelineno-20-47" href="#briefcode-__codelineno-20-47"></a><span class="w">                    </span><span class="n">increment_count</span><span class="p">,</span><span class="w"> </span><span class="n">decrement_count</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">increment_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">decrement_count</span><span class="p">));</span>
</span><span id="__span-20-48"><a id="__codelineno-20-48" name="__codelineno-20-48" href="#briefcode-__codelineno-20-48"></a><span class="w">        </span><span class="n">k_msleep</span><span class="p">(</span><span class="mi">400</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sys_rand32_get</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
</span><span id="__span-20-49"><a id="__codelineno-20-49" name="__codelineno-20-49" href="#briefcode-__codelineno-20-49"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-20-50"><a id="__codelineno-20-50" name="__codelineno-20-50" href="#briefcode-__codelineno-20-50"></a><span class="p">}</span>
</span><span id="__span-20-51"><a id="__codelineno-20-51" name="__codelineno-20-51" href="#briefcode-__codelineno-20-51"></a>
</span><span id="__span-20-52"><a id="__codelineno-20-52" name="__codelineno-20-52" href="#briefcode-__codelineno-20-52"></a><span class="cm">/* STEP 4 - Functions for thread0 and thread1 with a shared code section */</span>
</span><span id="__span-20-53"><a id="__codelineno-20-53" name="__codelineno-20-53" href="#briefcode-__codelineno-20-53"></a><span class="kt">void</span><span class="w"> </span><span class="nf">thread0</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-20-54"><a id="__codelineno-20-54" name="__codelineno-20-54" href="#briefcode-__codelineno-20-54"></a><span class="p">{</span>
</span><span id="__span-20-55"><a id="__codelineno-20-55" name="__codelineno-20-55" href="#briefcode-__codelineno-20-55"></a><span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Thread 0 started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-20-56"><a id="__codelineno-20-56" name="__codelineno-20-56" href="#briefcode-__codelineno-20-56"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-57"><a id="__codelineno-20-57" name="__codelineno-20-57" href="#briefcode-__codelineno-20-57"></a><span class="w">        </span><span class="n">shared_code_section</span><span class="p">();</span><span class="w"> </span>
</span><span id="__span-20-58"><a id="__codelineno-20-58" name="__codelineno-20-58" href="#briefcode-__codelineno-20-58"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-20-59"><a id="__codelineno-20-59" name="__codelineno-20-59" href="#briefcode-__codelineno-20-59"></a><span class="p">}</span>
</span><span id="__span-20-60"><a id="__codelineno-20-60" name="__codelineno-20-60" href="#briefcode-__codelineno-20-60"></a>
</span><span id="__span-20-61"><a id="__codelineno-20-61" name="__codelineno-20-61" href="#briefcode-__codelineno-20-61"></a><span class="kt">void</span><span class="w"> </span><span class="nf">thread1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-20-62"><a id="__codelineno-20-62" name="__codelineno-20-62" href="#briefcode-__codelineno-20-62"></a><span class="p">{</span>
</span><span id="__span-20-63"><a id="__codelineno-20-63" name="__codelineno-20-63" href="#briefcode-__codelineno-20-63"></a><span class="w">    </span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Thread 1 started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-20-64"><a id="__codelineno-20-64" name="__codelineno-20-64" href="#briefcode-__codelineno-20-64"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-65"><a id="__codelineno-20-65" name="__codelineno-20-65" href="#briefcode-__codelineno-20-65"></a><span class="w">        </span><span class="n">shared_code_section</span><span class="p">();</span><span class="w"> </span>
</span><span id="__span-20-66"><a id="__codelineno-20-66" name="__codelineno-20-66" href="#briefcode-__codelineno-20-66"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-20-67"><a id="__codelineno-20-67" name="__codelineno-20-67" href="#briefcode-__codelineno-20-67"></a><span class="p">}</span>
</span><span id="__span-20-68"><a id="__codelineno-20-68" name="__codelineno-20-68" href="#briefcode-__codelineno-20-68"></a>
</span><span id="__span-20-69"><a id="__codelineno-20-69" name="__codelineno-20-69" href="#briefcode-__codelineno-20-69"></a><span class="c1">// Define and initialize threads</span>
</span><span id="__span-20-70"><a id="__codelineno-20-70" name="__codelineno-20-70" href="#briefcode-__codelineno-20-70"></a><span class="n">K_THREAD_DEFINE</span><span class="p">(</span><span class="n">thread0_id</span><span class="p">,</span><span class="w"> </span><span class="n">THREAD0_STACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">thread0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
</span><span id="__span-20-71"><a id="__codelineno-20-71" name="__codelineno-20-71" href="#briefcode-__codelineno-20-71"></a><span class="w">        </span><span class="n">THREAD0_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p">);</span>
</span><span id="__span-20-72"><a id="__codelineno-20-72" name="__codelineno-20-72" href="#briefcode-__codelineno-20-72"></a>
</span><span id="__span-20-73"><a id="__codelineno-20-73" name="__codelineno-20-73" href="#briefcode-__codelineno-20-73"></a><span class="n">K_THREAD_DEFINE</span><span class="p">(</span><span class="n">thread1_id</span><span class="p">,</span><span class="w"> </span><span class="n">THREAD1_STACKSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">thread1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span>
</span><span id="__span-20-74"><a id="__codelineno-20-74" name="__codelineno-20-74" href="#briefcode-__codelineno-20-74"></a><span class="w">        </span><span class="n">THREAD1_PRIORITY</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p">);</span>
</span></code></pre></div>
</details></section></div>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      2023 <a href="https://github.com/deimosmh"  target="_blank" rel="noopener">Maciej Hejlasz</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/deimosmh" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://www.linkedin.com/in/maciej-hejlasz/" target="_blank" rel="noopener" title="www.linkedin.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "/", "features": ["navigation.tabs", "navigation.sections", "navigation.tabs.sticky", "navigation.top", "toc.follow", "toc.integrate", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.6c14ae12.min.js"></script>
      
        <script src="../js/print-site.js"></script>
      
    
  </body>
</html>